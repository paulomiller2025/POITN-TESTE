<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POINT — Multipliers (Deriv)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Gráfico leve estilo Deriv -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root{
      --bg:#0b1220;--card:#121a2b;--muted:#9fb0d0;--ok:#22c55e;--warn:#eab308;--err:#ef4444;--ink:#e6edf7;--soft:#1b2740
    }
    body{background:var(--bg);color:var(--ink)}
    .card{background:var(--card);border:1px solid #1e2a46; border-radius:1rem; box-shadow:0 10px 20px rgba(0,0,0,.25)}
    .pill{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08); border-radius:.8rem}
    .btn{transition:transform .05s ease,opacity .2s}
    .btn:active{transform:translateY(1px)}
    .glass{backdrop-filter: blur(8px); background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); border-radius: .9rem}
    .grid-col{display:grid;grid-template-columns:1fr 1fr;gap:.85rem}
    @media (min-width:1024px){.grid-col-3{grid-template-columns:repeat(3,1fr)}}

    /* Selects com texto preto ao focar/abrir */
    select:focus, select:active { color:#000 !important; background:#fff !important; }
    select option { color:#000; }

    /* Layout principal: 3 colunas (esq — centro — dir) com mais espaço ao gráfico */
    .layout-3 {
      display: grid;
      grid-template-columns: 360px 1fr 420px;
      gap: 1.5rem;
      align-items: stretch;
    }
    @media (max-width: 1400px){
      .layout-3 { grid-template-columns: 320px 1fr 380px; }
    }
    @media (max-width: 1024px){
      .layout-3 { grid-template-columns: 1fr; }
    }

    /* Gráfico mais alto/largo */
    #chartWrap{ height: 620px; }
    #chart{ width:100%; height:100%; }
  </style>
</head>
<body>
  <header class="sticky top-0 z-50 border-b border-slate-800 bg-[color:var(--soft)]">
    <div class="max-w-[1800px] mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-indigo-500/20 flex items-center justify-center">
          <span class="text-indigo-300 font-bold">P</span>
        </div>
        <div>
          <h1 class="text-lg font-semibold tracking-wide">POINT — Multipliers (Deriv)</h1>
          <p class="text-xs text-slate-400">App ID: 98640 • OAuth + WebSocket</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="loginBtn" class="btn px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm">Conectar</button>
        <button id="logoutBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-slate-100 text-sm hidden">Desconectar</button>
      </div>
    </div>
  </header>

  <main class="max-w-[1800px] mx-auto px-6 py-6 space-y-5">
    <!-- STATUS / CONTAS -->
    <section class="card p-4">
      <div class="flex flex-wrap items-center gap-4 justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-emerald-500/15 flex items-center justify-center">
            <span class="text-emerald-300">●</span>
          </div>
          <div>
            <div id="connStatus" class="text-sm text-slate-300">Desconectado</div>
            <div id="loginNote" class="text-xs text-slate-400">
              Clique em <b>Conectar</b> para iniciar o OAuth (será redirecionado e voltará com os tokens).
            </div>
          </div>
        </div>

        <!-- LINHA ÚNICA: Conta + Tipo + Saldo -->
        <div class="flex flex-wrap items-center gap-3">
          <label class="text-sm text-slate-300">Conta:</label>
          <select id="accountSelect" class="pill px-3 py-2 text-sm text-slate-200 bg-transparent min-w-[220px]" disabled></select>

          <span id="acctType" class="text-xs px-2 py-1 rounded-md bg-white/10 border border-white/10 text-slate-200">—</span>

          <label class="text-sm text-slate-300">Saldo:</label>
          <input id="balanceInput" class="pill px-3 py-2 text-sm bg-transparent text-slate-200 w-44 text-right" placeholder="—" disabled />
        </div>
      </div>
    </section>

    <!-- LAYOUT: ESQ | CENTRO | DIR -->
    <section class="layout-3">
      <!-- ESQUERDA: MERCADO + POSIÇÃO -->
      <div class="space-y-4">
        <!-- MERCADO -->
        <div class="card p-4">
          <div class="text-xs uppercase tracking-wide text-slate-400 mb-2">Mercado</div>
          <div class="space-y-3">
            <div>
              <label class="text-sm text-slate-300">Símbolo (Volatility/Synthetic)</label>
              <select id="symbolSelect" class="pill w-full px-3 py-2 text-sm bg-transparent text-slate-200" disabled>
                <option>— carregando —</option>
              </select>
            </div>
          </div>
        </div>

        <!-- POSIÇÃO -->
        <div class="card p-4">
          <div class="text-xs uppercase tracking-wide text-slate-400">Posição</div>
          <div id="posStatus" class="text-sm mt-1">Nenhuma posição aberta.</div>
          <div class="flex items-center justify-between mt-3">
            <div class="text-sm">P/L: <span id="plVal" class="font-semibold text-slate-200">—</span></div>
            <button id="closeBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-sm hidden">Fechar posição</button>
          </div>
        </div>
      </div>

      <!-- CENTRO: GRÁFICO -->
      <div class="card p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-xs uppercase tracking-wide text-slate-400">Gráfico de Velas</div>
          <div class="flex items-center gap-2">
            <label class="text-xs text-slate-400">Intervalo:</label>
            <select id="timeframeSelect" class="pill px-3 py-2 rounded-xl text-xs bg-transparent text-slate-200">
              <option value="60" selected>1m</option>
              <option value="120">2m</option>
              <option value="180">3m</option>
              <option value="300">5m</option>
              <option value="600">10m</option>
              <option value="900">15m</option>
              <option value="1800">30m</option>
              <option value="3600">1h</option>
              <option value="7200">2h</option>
              <option value="14400">4h</option>
              <option value="28800">8h</option>
              <option value="86400">1d</option>
            </select>

            <!-- Botões de zoom -->
            <div class="flex items-center gap-1 ml-2">
              <button id="zoomInBtn" class="btn px-2 py-1 rounded-md border border-white/10 text-xs">+</button>
              <button id="zoomOutBtn" class="btn px-2 py-1 rounded-md border border-white/10 text-xs">−</button>
              <button id="zoomFitBtn" class="btn px-2 py-1 rounded-md border border-white/10 text-xs">Fit</button>
            </div>

            <div class="text-xs text-slate-400 ml-2" id="chartInfo">1m candles • stream</div>
          </div>
        </div>
        <div id="chartWrap" class="rounded-xl overflow-hidden">
          <div id="chart"></div>
        </div>
      </div>

      <!-- DIREITA: PARÂMETROS + AÇÃO -->
      <div class="space-y-4">
        <div class="card p-4">
          <div class="text-xs uppercase tracking-wide text-slate-400 mb-2">Parâmetros</div>
          <div class="space-y-3">
            <div class="grid-col">
              <div>
                <label class="text-sm text-slate-300">Stake</label>
                <input id="stakeInput" type="number" min="1" step="1" value="5" class="pill w-full px-3 py-2 bg-transparent text-slate-200" disabled />
              </div>
              <div>
                <label class="text-sm text-slate-300">Multiplier</label>
                <select id="multInput" class="pill w-full px-3 py-2 bg-transparent text-slate-200" disabled>
                  <option value="10" selected>x10</option>
                  <option value="50">x50</option>
                  <option value="100">x100</option>
                  <option value="200">x200</option>
                  <option value="400">x400</option>
                  <option value="800">x800</option>
                  <option value="1000">x1000</option>
                  <option value="1500">x1500</option>
                  <option value="2000">x2000</option>
                </select>
              </div>
            </div>

            <div class="grid-col">
              <div>
                <label class="text-sm text-slate-300">Take Profit (opcional)</label>
                <input id="tpInput" type="number" min="1" step="1" placeholder="ex: 150" class="pill w-full px-3 py-2 bg-transparent text-slate-200" disabled />
              </div>
              <div>
                <label class="text-sm text-slate-300">Stop Loss (opcional)</label>
                <input id="slInput" type="number" min="1" step="1" placeholder="ex: 130" class="pill w-full px-3 py-2 bg-transparent text-slate-200" disabled />
              </div>
            </div>

            <div>
              <label class="text-sm text-slate-300">Deal Cancellation</label>
              <select id="dcInput" class="pill w-full px-3 py-2 bg-transparent text-slate-200" disabled>
                <option value="">Desligado</option>
                <option value="5m">5m</option>
                <option value="10m">10m</option>
                <option value="15m">15m</option>
                <option value="30m">30m</option>
                <option value="60m">60m</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card p-4">
          <div class="text-xs uppercase tracking-wide text-slate-400 mb-2">Ação</div>
          <div class="flex gap-3">
            <button id="upBtn" class="btn flex-1 px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white disabled:opacity-40" disabled>UP (MULTUP)</button>
            <button id="downBtn" class="btn flex-1 px-4 py-3 rounded-xl bg-rose-600 hover:bg-rose-500 text-white disabled:opacity-40" disabled>DOWN (MULTDOWN)</button>
          </div>
          <div class="text-xs text-slate-400 mt-2">
            Multipliers: perdas limitadas ao <b>stake</b>; podes fechar a qualquer momento; TP/SL e Cancellation suportados.
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ================== CONFIG ==================
    const APP_ID = 98640; // POINT
    const WS_URL = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;

    // OAuth: usa redirect_uri em http/https e adiciona parâmetros obrigatórios
    const CAN_USE_REDIRECT = location.protocol === 'http:' || location.protocol === 'https:';
    const REDIRECT_URL = CAN_USE_REDIRECT ? (window.location.origin + window.location.pathname) : '';
    // Parâmetros essenciais: response_type=token e scope=read trade (+ brand=deriv para consistência)
    const OAUTH_URL =
      `https://oauth.deriv.com/oauth2/authorize?brand=deriv&app_id=${APP_ID}` +
      `&response_type=token&scope=${encodeURIComponent('read trade')}` +
      (CAN_USE_REDIRECT ? `&redirect_uri=${encodeURIComponent(REDIRECT_URL)}` : '');

    const DEFAULT_SYMBOL = '1HZ100V'; // Volatility 100 (1s)
    let CANDLE_GRANULARITY = 60; // padrão 1m
    // ============================================

    // Estado global simples
    let ws = null;
    let authorized = false;
    let selectedToken = null;
    let loginId = null;
    let currency = 'USD';
    let tickSubId = null;
    let candleSubId = null;
    let openContractId = null;
    let pocSubId = null;
    let balanceSubId = null;

    const els = {
      loginBtn: document.getElementById('loginBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      connStatus: document.getElementById('connStatus'),
      loginNote: document.getElementById('loginNote'),
      accountSelect: document.getElementById('accountSelect'),
      symbolSelect: document.getElementById('symbolSelect'),
      stakeInput: document.getElementById('stakeInput'),
      multInput: document.getElementById('multInput'),
      tpInput: document.getElementById('tpInput'),
      slInput: document.getElementById('slInput'),
      dcInput: document.getElementById('dcInput'),
      upBtn: document.getElementById('upBtn'),
      downBtn: document.getElementById('downBtn'),
      posStatus: document.getElementById('posStatus'),
      plVal: document.getElementById('plVal'),
      closeBtn: document.getElementById('closeBtn'),
      balanceInput: document.getElementById('balanceInput'),
      chartInfo: document.getElementById('chartInfo'),
      timeframeSelect: document.getElementById('timeframeSelect'),
      acctType: document.getElementById('acctType'),
    };

    // === Chart (Lightweight Charts) ===
    const chartContainer = document.getElementById('chart');
    const chart = LightweightCharts.createChart(chartContainer, {
      layout: { background: { type: 'solid', color: '#0b1220' }, textColor: '#cbd5e1' },
      grid: { vertLines: { color: '#1e293b' }, horzLines: { color: '#1e293b' } },
      crosshair: { mode: 0 },
      rightPriceScale: { borderColor: '#334155' },
      timeScale: { borderColor: '#334155' },
      handleScroll: true,
      handleScale: true,
    });
    const candleSeries = chart.addCandlestickSeries({
      upColor: '#22c55e', downColor: '#ef4444',
      borderDownColor: '#ef4444', borderUpColor: '#22c55e',
      wickDownColor: '#ef4444', wickUpColor: '#22c55e',
    });
    // Série para ticks (linha sobre o gráfico)
    const tickSeries = chart.addLineSeries({ lineWidth: 1.5 });

    function resizeChart(){
      const wrap = document.getElementById('chartWrap');
      chart.applyOptions({ width: wrap.clientWidth, height: wrap.clientHeight });
    }
    window.addEventListener('resize', resizeChart);
    setTimeout(resizeChart, 10);

    // ------------- Helpers UI -------------
    function setConnectedUI(on){
      els.connStatus.textContent = on ? 'Conectado (WebSocket ativo)' : 'Desconectado';
    }
    function setAuthUI(on){
      authorized = !!on;
      const dis = !on;
      [els.accountSelect, els.symbolSelect, els.stakeInput, els.multInput, els.tpInput, els.slInput, els.dcInput, els.upBtn, els.downBtn, els.timeframeSelect].forEach(el=>{
        el.disabled = dis;
      });
      els.logoutBtn.classList.toggle('hidden', !on);
      els.loginBtn.classList.toggle('hidden', on);
      els.loginNote.textContent = on
        ? 'Autorizado. Escolhe a conta e o símbolo para negociar.'
        : 'Clique em Conectar para iniciar o OAuth.';
      if(dis){ els.balanceInput.value = ''; els.balanceInput.placeholder = '—'; els.acctType.textContent='—'; }
    }
    function toast(msg,isErr=false){ console[isErr?'error':'log'](msg); }

    // ------------- OAuth: captura tokens do redirect (query e hash) -------------
    function parseParams(str){
      const p = new URLSearchParams(str);
      const tokens = [];
      for (let i=1;i<=10;i++){
        const acct = p.get(`acct${i}`) || p.get(`loginid${i}`);
        const token = p.get(`token${i}`);
        const cur = p.get(`cur${i}`) || p.get(`currency${i}`);
        if(acct && token){
          tokens.push({account:acct.toUpperCase(), token, currency:(cur||'USD').toUpperCase()});
        }
      }
      return tokens;
    }
    function extractTokensFromUrl(){
      // tokens podem vir em ? e/ou # (hash)
      const qTokens = parseParams(location.search.startsWith('?') ? location.search.slice(1) : '');
      const hTokens = parseParams(location.hash.startsWith('#') ? location.hash.slice(1) : '');
      const tokens = [...qTokens, ...hTokens];
      if(tokens.length){
        localStorage.setItem('POINT_TOKENS', JSON.stringify(tokens));
        // limpa barra
        history.replaceState({}, document.title, location.pathname);
      }
    }
    function getStoredTokens(){
      try { return JSON.parse(localStorage.getItem('POINT_TOKENS')||'[]'); } catch(e){ return []; }
    }
    function clearTokens(){
      localStorage.removeItem('POINT_TOKENS');
      localStorage.removeItem('POINT_SELECTED');
    }

    // ------------- WebSocket Core -------------
    function connectWS(){
      if(ws && ws.readyState===1) return;
      ws = new WebSocket(WS_URL);
      ws.onopen = ()=>{
        setConnectedUI(true);
        const remembered = JSON.parse(localStorage.getItem('POINT_SELECTED')||'null');
        const tokens = getStoredTokens();
        if(remembered && tokens.length){
          const match = tokens.find(t=>t.account===remembered.account);
          if(match) authorize(match.token, match.account, match.currency);
        }
      };
      ws.onclose = ()=>{
        setConnectedUI(false);
        setAuthUI(false);
      };
      ws.onmessage = handleMessage;
      ws.onerror = (e)=>toast('WebSocket error', true);
    }

    function send(msg){
      if(!ws || ws.readyState!==1){ toast('WS não conectado', true); return; }
      ws.send(JSON.stringify(msg));
    }

    // ------------- Mensagens WS -------------
    function handleMessage(evt){
      const data = JSON.parse(evt.data);

      if(data.error){
        toast(data.error.message, true);
        els.posStatus.textContent = `Erro: ${data.error.message}`;
        return;
      }

      // authorize
      if(data.msg_type==='authorize'){
        loginId = data.authorize.loginid;
        currency = data.authorize.currency || 'USD';
        setAuthUI(true);
        updateAcctType(loginId);
        loadActiveSymbols();
        els.posStatus.textContent = 'Nenhuma posição aberta.';
        subscribeBalance(); // saldo ao autorizar
        setTimeout(()=>ensureDefaultSymbol(), 50);
      }

      // active_symbols -> popula select
      if(data.msg_type==='active_symbols'){
        const syms = (data.active_symbols||[])
          .filter(s=>s.market==='synthetic_index' || s.symbol.includes('R_') || s.symbol.includes('VOL') || s.symbol.startsWith('1HZ'))
          .map(s=>({symbol:s.symbol, display:`${s.display_name} (${s.symbol})`}));
        els.symbolSelect.innerHTML = '';
        syms.forEach(s=>{
          const o=document.createElement('option');
          o.value = s.symbol; o.textContent = s.display;
          els.symbolSelect.appendChild(o);
        });
        const hasDefault = syms.find(s=>s.symbol===DEFAULT_SYMBOL);
        els.symbolSelect.value = hasDefault ? DEFAULT_SYMBOL : (syms[0]?.symbol||'');
        if(els.symbolSelect.value){
          subscribeCandles(els.symbolSelect.value);
          subscribeTicks(els.symbolSelect.value);
        }
      }

      // ticks -> linha no gráfico
      if(data.msg_type==='tick'){
        const q = Number(data.tick.quote);
        tickSeries.update({ time: Number(data.tick.epoch), value: q });
      }

      // candles stream
      if(data.msg_type==='candles'){
        const arr = Array.isArray(data.candles) ? data.candles : [data.candles];
        const mapped = arr.map(c=>({
          time: Number(c.epoch),
          open: Number(c.open),
          high: Number(c.high),
          low: Number(c.low),
          close: Number(c.close),
        }));
        if(Array.isArray(data.candles)){
          candleSeries.setData(mapped);
          chart.timeScale().fitContent();
        } else {
          candleSeries.update(mapped[0]);
        }
      }

      // proposal -> buy
      if(data.msg_type==='proposal'){
        if(data.proposal && data.proposal.id){
          const id = data.proposal.id;
          const ask = Number(data.proposal.ask_price);
          send({ buy: id, price: ask });
        }
      }

      // buy -> contrato aberto
      if(data.msg_type==='buy'){
        if(data.buy && data.buy.contract_id){
          openContractId = data.buy.contract_id;
          els.posStatus.textContent = `Contrato #${openContractId} aberto. A acompanhar...`;
          els.closeBtn.classList.remove('hidden');
          subscribeOpenContract(openContractId);
        }
      }

      // acompanhar contrato
      if(data.msg_type==='proposal_open_contract'){
        const poc = data.proposal_open_contract;
        if(!poc) return;
        if(poc.contract_id) openContractId = poc.contract_id;
        const pl = (poc.profit || 0);
        els.plVal.textContent = `${pl.toFixed(2)} ${currency}`;
        if(poc.is_sold){
          els.posStatus.textContent = `Contrato fechado. Resultado: ${pl.toFixed(2)} ${currency}`;
          cleanupPosition();
        }
      }

      if(data.msg_type==='sell'){ toast('Solicitado fechar posição.'); }

      // balance (atualiza campo)
      if(data.msg_type==='balance'){
        if(data.balance && typeof data.balance.balance !== 'undefined'){
          const bal = Number(data.balance.balance);
          els.balanceInput.value = `${bal.toFixed(2)} ${data.balance.currency || currency}`;
        }
        if(data.subscription && data.subscription.id && !balanceSubId){
          balanceSubId = data.subscription.id;
        }
      }
    }

    function updateAcctType(loginid){
      if(!loginid){ els.acctType.textContent='—'; return; }
      const isDemo = /^VRTC/i.test(loginid);
      els.acctType.textContent = isDemo ? 'Conta Demo' : 'Conta Real';
    }

    // ------------- Fluxos API -------------
    function authorize(token, acct, cur){
      selectedToken = token;
      currency = (cur||'USD').toUpperCase();
      send({ authorize: token, passthrough:{acct} });
    }

    function loadActiveSymbols(){
      send({ active_symbols: 'brief', product_type: 'basic' });
    }

    function ensureDefaultSymbol(){
      if(!els.symbolSelect.value){
        els.symbolSelect.value = DEFAULT_SYMBOL;
      }
      if(els.symbolSelect.value){
        subscribeCandles(els.symbolSelect.value);
        subscribeTicks(els.symbolSelect.value);
      }
    }

    function subscribeTicks(symbol){
      if(tickSubId){ send({ forget: tickSubId }); tickSubId=null; }
      tickSeries.setData([]);
      send({ ticks: symbol, subscribe: 1 });
      ws.addEventListener('message', function once(e){
        try{
          const d = JSON.parse(e.data);
          if(d.msg_type==='tick' && d.tick && d.subscription && d.subscription.id){
            tickSubId = d.subscription.id;
            ws.removeEventListener('message', once);
          }
        }catch(_){}
      });
    }

    function subscribeCandles(symbol){
      if(candleSubId){ send({ forget: candleSubId }); candleSubId=null; }
      send({
        ticks_history: symbol,
        style: 'candles',
        granularity: CANDLE_GRANULARITY,
        count: 300,
        subscribe: 1
      });
      ws.addEventListener('message', function once(e){
        try{
          const d = JSON.parse(e.data);
          if(d.msg_type==='candles' && d.subscription && d.subscription.id){
            candleSubId = d.subscription.id;
            ws.removeEventListener('message', once);
          }
        }catch(_){}
      });
      els.chartInfo.textContent = tfLabel(CANDLE_GRANULARITY) + ' candles • stream';
    }

    function tfLabel(g){
      const map = {
        60:'1m',120:'2m',180:'3m',300:'5m',600:'10m',900:'15m',
        1800:'30m',3600:'1h',7200:'2h',14400:'4h',28800:'8h',86400:'1d'
      };
      return map[g] || (g+'s');
    }

    function subscribeOpenContract(contract_id){
      if(pocSubId){ send({ forget: pocSubId }); pocSubId=null; }
      send({ proposal_open_contract: 1, contract_id, subscribe: 1 });
      ws.addEventListener('message', function once(e){
        try{
          const d = JSON.parse(e.data);
          if(d.msg_type==='proposal_open_contract' && d.subscription && d.subscription.id){
            pocSubId = d.subscription.id;
            ws.removeEventListener('message', once);
          }
        }catch(_){}
      });
    }

    function subscribeBalance(){
      if(balanceSubId){ send({ forget: balanceSubId }); balanceSubId = null; }
      send({ balance: 1, subscribe: 1 });
    }

    function requestBalanceOnce(){ send({ balance: 1 }); }

    function cleanupPosition(){
      openContractId = null;
      if(pocSubId){ send({ forget: pocSubId }); pocSubId=null; }
      els.closeBtn.classList.add('hidden');
      els.plVal.textContent = '—';
    }

    function placeMultiplier(direction){
      if(!authorized) return toast('Autorize primeiro', true);
      const symbol = els.symbolSelect.value || DEFAULT_SYMBOL;
      const amount = Number(els.stakeInput.value||0);
      const multiplier = Number(els.multInput.value||10); // x10 padrão
      if(!symbol || !amount){ els.posStatus.textContent='Preencha símbolo e stake'; return; }

      const limit_order = {};
      const tp = Number(els.tpInput.value||0);
      const sl = Number(els.slInput.value||0);
      if(tp>0) limit_order.take_profit = tp;
      if(sl>0) limit_order.stop_loss = sl;

      const req = {
        proposal: 1,
        amount,
        basis: 'stake',
        product_type: 'multiplier',
        contract_type: direction==='up' ? 'MULTUP' : 'MULTDOWN',
        currency,
        symbol,
        multiplier
      };
      if(Object.keys(limit_order).length) req.limit_order = limit_order;
      const dc = els.dcInput.value;
      if(dc) req.cancellation = dc;

      els.posStatus.textContent = 'Enviando proposal...';
      send(req);
    }

    // ------------- Eventos UI -------------
    els.loginBtn.onclick = () => {
      // Se estiver em file://, avisa — OAuth precisa de http/https
      if (!(location.protocol === 'http:' || location.protocol === 'https:')) {
        alert('Para conectar via OAuth, abra este arquivo usando http/https (ex.: Live Server no VSCode). O protocolo file:// bloqueia o OAuth.');
      }
      // Redireciona de forma confiável
      try { window.location.assign(OAUTH_URL); }
      catch { window.location.href = OAUTH_URL; }
    };

    els.logoutBtn.onclick = ()=>{
      cleanupPosition();
      if(ws && ws.readyState===1) ws.close();
      if(balanceSubId){ send({ forget: balanceSubId }); balanceSubId=null; }
      if(tickSubId){ send({ forget: tickSubId }); tickSubId=null; }
      if(candleSubId){ send({ forget: candleSubId }); candleSubId=null; }
      clearTokens();
      selectedToken=null; loginId=null; setAuthUI(false);
      els.accountSelect.innerHTML = '';
      candleSeries.setData([]);
      tickSeries.setData([]);
      toast('Sessão limpa.');
    };

    // Troca de conta -> autoriza e atualiza saldo
    els.accountSelect.onchange = ()=>{
      const opt = els.accountSelect.value;
      if(!opt) return;
      const tokens = getStoredTokens();
      const chosen = tokens.find(t=>t.account===opt);
      if(!chosen) return;
      localStorage.setItem('POINT_SELECTED', JSON.stringify(chosen));
      updateAcctType(chosen.account);
      if(ws && ws.readyState===1) authorize(chosen.token, chosen.account, chosen.currency);
      else connectWS();
      setTimeout(()=>{ subscribeBalance(); requestBalanceOnce(); }, 200);
    };

    // Símbolo mudou -> re-assinar candles e ticks
    els.symbolSelect.onchange = (e)=>{
      const sym = e.target.value;
      if(!sym) return;
      subscribeCandles(sym);
      subscribeTicks(sym);
    };

    // Timeframe
    els.timeframeSelect.onchange = (e)=>{
      CANDLE_GRANULARITY = Number(e.target.value || 60);
      const sym = els.symbolSelect.value || DEFAULT_SYMBOL;
      if(sym){ subscribeCandles(sym); }
    };

    // Zoom botões
    document.getElementById('zoomInBtn').onclick = ()=>{
      const s = chart.timeScale().getBarSpacing();
      chart.timeScale().setBarSpacing(s * 0.8);
    };
    document.getElementById('zoomOutBtn').onclick = ()=>{
      const s = chart.timeScale().getBarSpacing();
      chart.timeScale().setBarSpacing(s * 1.25);
    };
    document.getElementById('zoomFitBtn').onclick = ()=>{
      chart.timeScale().fitContent();
    };

    // ------------- Inicialização -------------
    function initTokensAndConnect(){
      extractTokensFromUrl();
      const tokens = getStoredTokens();
      connectWS(); // WS sempre primeiro

      if(tokens.length){
        els.accountSelect.innerHTML = '';
        tokens.forEach(t=>{
          const o=document.createElement('option');
          o.value=t.account; o.textContent=`${t.account} • ${t.currency}`;
          els.accountSelect.appendChild(o);
        });
        els.accountSelect.disabled = false;

        const first = tokens[0];
        localStorage.setItem('POINT_SELECTED', JSON.stringify(first));
        updateAcctType(first.account);
        authorize(first.token, first.account, first.currency);
      }
    }

    initTokensAndConnect();
  </script>
</body>
</html>
