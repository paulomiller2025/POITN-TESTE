<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>POINT — Multipliers</title>

<!-- Chart de velas (leve e suave) -->
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<style>
:root{
  --bg:#0b1220;--card:#121a2b;--muted:#9fb0d0;--ok:#22c55e;--err:#ef4444;--warn:#eab308;
  --primary:#2a62ff;--border:#263453;--ink:#e6edf7;--ink2:#cfe8ff;
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);background:#0d1628;position:sticky;top:0;z-index:10}
h3{margin:0}
.btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#0f1830;color:var(--ink);cursor:pointer}
.btn.primary{background:var(--primary);border-color:var(--primary)}
.btn.danger{background:#9b2226;border-color:#9b2226}
select,input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0f1830;color:var(--ink)}
main{max-width:1200px;margin:16px auto;padding:0 12px;display:grid;gap:14px;grid-template-columns:1.3fr .9fr}
@media(max-width:980px){ main{display:block} }

.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
.pill{background:#0f1830;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
.pill b{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}

.status{display:flex;gap:8px;align-items:center;margin:6px 0}
.badge{padding:6px 10px;border-radius:10px;border:1px solid var(--border);font-size:12px}
.badge.ok{background:#0f2a1a;border-color:#124f2f;color:#bef7d0}
.badge.err{background:#2b1010;border-color:#5a1d1d;color:#ffc6c6}
.badge.warn{background:#2b230f;border-color:#5a4c1d;color:#ffe9a6}

.chartRow{display:grid;grid-template-columns:2.1fr 1fr;gap:12px}
@media(max-width:980px){ .chartRow{display:block} }
.chartBox{height:420px;border:1px solid var(--border);border-radius:12px;background:#0b1524;overflow:hidden}
.toolsBox{border:1px solid var(--border);border-radius:12px;padding:12px;background:#0b1524}

.toolsBox .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.toolsBox .title{font-weight:700;margin-bottom:8px}
.mini{font-size:12px;color:var(--muted)}

.table{width:100%;border-collapse:collapse;font-size:14px;margin-top:8px}
.table th,.table td{border-bottom:1px solid rgba(255,255,255,.06);padding:8px;text-align:left;white-space:nowrap}
.table th{color:#9fb0d0;font-weight:700}

.orderRow{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:10px}
.orderRow .wide{grid-column: span 2}
.actions{display:flex;gap:8px;margin-top:10px}
.actions .btn{flex:1;font-weight:700}
.actions .btn.up{background:#0e7a3d;border-color:#0e7a3d}
.actions .btn.down{background:#9b2226;border-color:#9b2226}
.small{font-size:12px;color:#9fb0d0;margin-top:6px}
</style>
</head>
<body>
<header>
  <h3>POINT — Multipliers</h3>
  <div style="display:flex;gap:8px">
    <button id="btn_connect" class="btn primary">Autorizar & Conectar</button>
    <button id="btn_disconnect" class="btn danger">Desconectar</button>
  </div>
</header>

<main>
  <!-- Coluna esquerda -->
  <section class="card">
    <h4>Conexão & Mercado</h4>

    <div class="grid2">
      <div>
        <label>Conta</label>
        <select id="account_select" disabled></select>
      </div>
      <div>
        <label>Moeda</label>
        <select id="currency">
          <option value="USD" selected>USD</option><option>EUR</option><option>GBP</option>
        </select>
      </div>
      <div>
        <label>Símbolo (*multipliers*)</label>
        <select id="symbol"></select>
      </div>
      <div>
        <label>Timeframe da vela</label>
        <select id="tf">
          <option value="1">1s</option>
          <option value="5" selected>5s</option>
          <option value="60">1m</option>
          <option value="300">5m</option>
        </select>
      </div>
    </div>

    <div class="kpi">
      <div class="pill"><b>Tipo</b><span id="acc_type">—</span></div>
      <div class="pill"><b>Saldo</b><span id="balance">—</span></div>
      <div class="pill"><b>P/L Sessão</b><span id="pl">0.00</span></div>
    </div>

    <div class="kpi" style="margin-top:10px">
      <div class="pill"><b>Posição</b><span id="position_lbl">—</span></div>
      <div class="pill"><b>Status</b><span class="status">
        <span id="conn_badge" class="badge err">Offline</span>
        <span id="tick_badge" class="badge warn">Sem ticks</span>
      </span></div>
      <div class="pill"><b>Último preço</b><span id="last_price">—</span></div>
    </div>

    <div class="chartRow" style="margin-top:10px">
      <div class="chartBox" id="chart_box"></div>
      <div class="toolsBox">
        <div class="title">Probabilidades (curto prazo)</div>
        <div class="mini" id="prob_read">Leitura: —</div>
        <div style="margin-top:8px">
          <div class="mini">Prob. UP</div>
          <div id="prob_up" class="badge ok" style="display:inline-block">—</div>
        </div>
        <div style="margin-top:8px">
          <div class="mini">Prob. DOWN</div>
          <div id="prob_dn" class="badge err" style="display:inline-block">—</div>
        </div>

        <div style="height:10px"></div>
        <div class="title">Ordem Multiplier</div>

        <div class="orderRow">
          <div>
            <label>Stake</label>
            <input id="stake" type="number" step="0.01" value="1.00"/>
          </div>
          <div>
            <label>Perfil</label>
            <select id="profile">
              <option value="20">Conservador (x20–x30)</option>
              <option value="40">Moderado (x40–x60)</option>
              <option value="80">Agressivo (x80–x100)</option>
            </select>
          </div>
          <div>
            <label>Multiplicador (opcional)</label>
            <input id="multiplier" type="number" step="1" placeholder="ex.: 30"/>
          </div>
          <div>
            <label>TP (opcional)</label>
            <input id="tp" type="number" step="0.01" placeholder="ex.: 5"/>
          </div>
          <div>
            <label>SL (opcional)</label>
            <input id="sl" type="number" step="0.01" placeholder="ex.: 5"/>
          </div>
          <div class="wide">
            <label>—</label>
            <div class="actions">
              <button id="btn_up" class="btn up">UP (MULTUP)</button>
              <button id="btn_down" class="btn down">DOWN (MULTDOWN)</button>
            </div>
          </div>
        </div>

        <div class="small">TP/SL são valores monetários (ex.: USD). O multiplicador é escolhido pelo campo “Multiplicador” — se vazio, é estimado pelo perfil.</div>
      </div>
    </div>
  </section>

  <!-- Coluna direita -->
  <section class="card">
    <h4>Histórico</h4>
    <table class="table" id="hist">
      <thead><tr><th>Hora</th><th>Tipo</th><th>Símbolo</th><th>Mult</th><th>Stake</th><th>P/L</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script>
/* ========== CONFIG ========== */
const APP_ID = 98640;
const WS_URL = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;
const OAUTH_SCOPE = 'read trade';
const REDIRECT_URI = location.origin + location.pathname;

/* ========== ESTADO ========== */
let ws=null, authorized=false, account_info={};
let session_pl=0;
let open_position=null; // {contract_id, type:'MULTUP'|'MULTDOWN'}
let last_tick_time=0, last_ohlc_time=0;
let order_lock=false, lock_tmr=null;

const $ = id => document.getElementById(id);
const fmt = (n,d=2)=> Number.isFinite(+n)?(+n).toFixed(d):'—';
function nowStr(){ const d=new Date(); return d.toLocaleTimeString(); }

/* ===== Símbolos de Multipliers (Volatility + 1s) ===== */
const MULT_SYMBOLS = [
  // 1s
  "1HZ10V","1HZ15V","1HZ25V","1HZ30V","1HZ50V","1HZ75V","1HZ100V",
  // contínuos
  "R_10","R_15","R_25","R_30","R_50","R_75","R_100"
];

/* ========== UI helpers ========== */
function setConn(ok){ $('conn_badge').className = 'badge ' + (ok?'ok':'err'); $('conn_badge').textContent = ok?'Conectado':'Offline'; }
function setTick(ok){ $('tick_badge').className = 'badge ' + (ok?'ok':'warn'); $('tick_badge').textContent = ok?'Ticks':'Sem ticks'; }
function addHistRow(type, sym, mult, stake, pl){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td>${nowStr()}</td><td>${type}</td><td>${sym}</td><td>x${mult}</td><td>${fmt(stake)}</td><td style="color:${pl>=0?'#22c55e':'#ef4444'}">${fmt(pl)}</td>`;
  $('hist').querySelector('tbody').prepend(tr);
}
function chooseMultiplierFromProfile(){
  const p = parseInt($('profile').value,10);
  const user = parseInt($('multiplier').value || '0',10);
  if (user>0) return user;
  // leque por perfil
  if (p===20) return 25;        // conservador
  if (p===40) return 50;        // moderado
  return 90;                    // agressivo
}

/* ========== OAuth ========= */
function beginOAuth(){
  const url = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}` +
              `&scope=${encodeURIComponent(OAUTH_SCOPE)}`+
              `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
  location.href = url;
}
function parseOAuthTokens(){
  const h = new URLSearchParams(location.hash.slice(1));
  const s = new URLSearchParams(location.search);
  s.forEach((v,k)=>{ if(!h.get(k)) h.set(k,v); });
  const out=[];
  const push=(tk,acct,cur)=>{ if(tk&&acct) out.push({token:tk,loginid:acct,currency:cur||'USD',is_virtual:/VRTC/.test(acct)}); };
  if (h.get('token')||h.get('acct')) push(h.get('token'),h.get('acct'),h.get('cur'));
  for(let i=1;i<=10;i++) push(h.get('token'+i),h.get('acct'+i),h.get('cur'+i));
  if (out.length){
    localStorage.setItem('deriv_oauth_map', JSON.stringify(out));
    history.replaceState({}, document.title, location.origin+location.pathname);
  }else{
    try{ const c=JSON.parse(localStorage.getItem('deriv_oauth_map')||'[]'); if(Array.isArray(c)) return c; }catch{}
  }
  return out;
}
function populateAccounts(){
  const accs = parseOAuthTokens();
  const sel=$('account_select'); sel.innerHTML='';
  if(!accs.length){ sel.disabled=true; return; }
  accs.forEach((a,i)=>{
    const o=document.createElement('option');
    o.value=String(i);
    o.textContent=`${a.loginid} • ${a.is_virtual?'DEMO':'REAL'} ${a.currency}`;
    sel.appendChild(o);
  });
  sel.disabled=false;
}

/* ========== WebSocket & assinaturas ========== */
function wsSend(o){ if(ws&&ws.readyState===1) ws.send(JSON.stringify(o)); }

function subscribeTicks(symbol){
  // ticks: só para último preço e probabilidade rápida
  try{ wsSend({ forget_all:'ticks' }); }catch(e){}
  wsSend({ ticks:symbol, subscribe:1 });
}

function subscribeCandles(symbol, granSec){
  // gráfico de velas: estilo candles + granularidade
  try{ wsSend({ forget_all:'candles' }); }catch(e){}
  const now = Math.floor(Date.now()/1000);
  const start = now - (granSec*600);  // ~600 velas históricas
  wsSend({
    ticks_history: symbol,
    start,
    end: 'latest',
    style: 'candles',
    granularity: granSec,
    subscribe: 1
  });
}

/* ========== Gráfico (Lightweight Charts) ========== */
let chart, series;
function initChart(){
  if(chart){ chart.remove(); chart=null; series=null; }
  chart = LightweightCharts.createChart($('chart_box'), {
    layout:{ background:{ type:'solid', color:'#0b1524' }, textColor:'#cfe8ff' },
    grid:{ vertLines:{ color:'#1a2a44' }, horzLines:{ color:'#1a2a44' } },
    timeScale:{ rightOffset:6, barSpacing:7, lockVisibleTimeRangeOnResize:true },
    crosshair:{ mode:1 },
  });
  series = chart.addCandlestickSeries({
    upColor:'#10b981', downColor:'#ef4444', borderVisible:false, wickUpColor:'#10b981', wickDownColor:'#ef4444'
  });
}

// mantém um cache de candles por epoch (para atualizar a última vela “viva”)
const candleMap = new Map();
function applyInitialCandles(arr){
  candleMap.clear();
  const data = arr.map(c=>{
    const x={ time: c.epoch, open:+c.open, high:+c.high, low:+c.low, close:+c.close };
    candleMap.set(c.epoch, x); return x;
  });
  series.setData(data);
}
function updateOneCandle(c){
  const x={ time:c.epoch, open:+c.open, high:+c.high, low:+c.low, close:+c.close };
  candleMap.set(c.epoch, x);
  series.update(x);
}

/* ========== Probabilidade simples (momentum curto) ========== */
const momWin = [];
function updateMomentumProb(price){
  momWin.push(price);
  if(momWin.length>120) momWin.shift();
  let up=0, dn=0; for(let i=1;i<momWin.length;i++){ (momWin[i]>momWin[i-1])?up++:dn++; }
  const tot = Math.max(1, up+dn);
  const pUp = up/tot, pDn=dn/tot;
  $('prob_up').textContent = (pUp*100).toFixed(1)+'%';
  $('prob_dn').textContent = (pDn*100).toFixed(1)+'%';
  $('prob_read').textContent = pUp>pDn? 'Tendência curta favorece UP' : (pUp<pDn?'Tendência curta favorece DOWN':'Neutro');
}

/* ========== Compra Multipliers (proposal → buy) ========== */
function armLock(){
  order_lock=true; clearTimeout(lock_tmr);
  lock_tmr=setTimeout(()=>{ order_lock=false; }, 8000);
}
function releaseLock(){ order_lock=false; clearTimeout(lock_tmr); lock_tmr=null; }

function proposeAndBuy(kind){ // 'MULTUP' | 'MULTDOWN'
  if(!authorized){ alert('Conecte primeiro.'); return; }
  if(order_lock){ return; }
  const symbol = $('symbol').value;
  const currency = $('currency').value;
  const amount = parseFloat($('stake').value)||1;
  const multiplier = chooseMultiplierFromProfile();
  const tp = parseFloat($('tp').value); const sl = parseFloat($('sl').value);

  const params = {
    proposal: 1,
    amount,
    basis: 'stake',
    contract_type: kind,
    currency,
    symbol,
    multiplier
  };
  if(Number.isFinite(tp)) params.take_profit = tp;
  if(Number.isFinite(sl)) params.stop_loss = sl;

  armLock();
  wsSend(params);
}

/* ========== Conectar ========== */
let watchdog=null, reconnectT=0, reconnectTimer=null;
function scheduleReconnect(){
  if(reconnectTimer) return;
  const delay = Math.min(30000, (1<<Math.min(reconnectT,5))*1000);
  reconnectTimer=setTimeout(()=>{ reconnectTimer=null; reconnectT++; connectWS(); }, delay);
}
function connectWS(){
  const list = parseOAuthTokens();
  if(list.length===0){ beginOAuth(); return; }
  const acc = list[ parseInt(($('account_select').value||'0'),10) ] || list[0];

  if(ws){ try{ws.close();}catch(e){} }
  ws = new WebSocket(WS_URL);
  ws.onopen = ()=> wsSend({ authorize: acc.token });
  ws.onclose = ()=>{ authorized=false; setConn(false); scheduleReconnect(); };
  ws.onerror = ()=>{ try{ws.close();}catch(e){} };

  ws.onmessage = (m)=>{
    const data = JSON.parse(m.data);
    if (data.error){
      console.warn('API error:', data.error);
      releaseLock();
      return;
    }
    switch(data.msg_type){

      case 'authorize':
        authorized = true; reconnectT=0; setConn(true);
        account_info = {
          loginid: data.authorize.loginid,
          is_virtual: data.authorize.is_virtual,
          currency: data.authorize.currency || 'USD'
        };
        $('acc_type').textContent = account_info.is_virtual?'Conta DEMO':'Conta REAL';
        $('currency').value = account_info.currency;
        wsSend({ balance:1, subscribe:1 });

        // gráfico & mercado
        initChart();
        const sym = $('symbol').value;
        subscribeTicks(sym);
        subscribeCandles(sym, parseInt($('tf').value,10));
        break;

      case 'balance':
        $('balance').textContent = `${fmt(data.balance.balance)} ${data.balance.currency}`;
        break;

      case 'tick':
        last_tick_time = Date.now();
        $('last_price').textContent = fmt(data.tick.quote, 2);
        setTick(true);
        updateMomentumProb(+data.tick.quote);
        break;

      case 'proposal':
        // resposta do proposal → comprar
        if (data.proposal && order_lock){
          wsSend({ buy: data.proposal.id, price: data.proposal.ask_price });
        }
        break;

      case 'buy':
        // posição aberta → assinar POC
        releaseLock();
        open_position = { contract_id: data.buy.contract_id, type: data.buy.contract_type };
        $('position_lbl').textContent = `${data.buy.contract_type} #${data.buy.contract_id}`;
        wsSend({ proposal_open_contract:1, contract_id: open_position.contract_id, subscribe:1 });
        break;

      case 'proposal_open_contract': {
        const poc = data.proposal_open_contract;
        if (!poc) return;

        // atualização de P/L
        const pl = +poc.profit || 0;
        $('pl').textContent = fmt(session_pl + pl);

        if (poc.is_sold){
          // posição fechou
          session_pl += pl;
          addHistRow(poc.contract_type, poc.underlying, poc.multiplier || '-', poc.buy_price, pl);
          $('pl').textContent = fmt(session_pl);
          $('position_lbl').textContent = '—';
          open_position = null;
        }
        break;
      }

      // candles (histórico inicial)
      case 'candles':
        if (Array.isArray(data.candles) && data.candles.length){
          applyInitialCandles(data.candles);
          last_ohlc_time = Date.now();
        }
        break;

      // atualizações de OHLC (vela corrente)
      case 'ohlc':
        if (data.ohlc){
          updateOneCandle(data.ohlc);
          last_ohlc_time = Date.now();
        }
        break;
    }
  };

  // watchdog (ticks/candles)
  clearInterval(watchdog);
  watchdog = setInterval(()=>{
    if(!ws || ws.readyState!==1){ setConn(false); return; }
    const now=Date.now();
    if(now - last_tick_time > 7000){ setTick(false); subscribeTicks($('symbol').value); }
    if(now - last_ohlc_time > 10000){ subscribeCandles($('symbol').value, parseInt($('tf').value,10)); }
  }, 2500);
}

/* ========== UI: listas e eventos ========== */
(function init(){
  // símbolos
  const sel=$('symbol');
  MULT_SYMBOLS.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
  sel.value='1HZ100V';

  populateAccounts();
  initChart();
})();

$('btn_connect').onclick = connectWS;
$('btn_disconnect').onclick = ()=>{
  try{ if(ws) ws.close(); }catch(e){}
  authorized=false; setConn(false);
  const url = new URL(location.href); url.search=''; url.hash=''; location.replace(url.toString());
};

$('account_select').onchange = ()=>{ if(authorized) connectWS(); };
$('symbol').onchange = ()=>{
  if(!authorized) return;
  const s=$('symbol').value, g=parseInt($('tf').value,10);
  subscribeTicks(s); subscribeCandles(s,g);
  $('position_lbl').textContent='—';
};
$('tf').onchange = ()=>{ if(authorized) subscribeCandles($('symbol').value, parseInt($('tf').value,10)); };

$('btn_up').onclick   = ()=> proposeAndBuy('MULTUP');
$('btn_down').onclick = ()=> proposeAndBuy('MULTDOWN');
</script>

</body>
</html>
