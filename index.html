<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POINT — Multipliers (Deriv)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- carrega primeiro; mesmo que falhe, código abaixo está protegido -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root{ --bg:#0b1220;--card:#121a2b;--ink:#e6edf7;--soft:#1b2740 }
    body{background:var(--bg);color:var(--ink)}
    .card{background:var(--card);border:1px solid #1e2a46;border-radius:1rem}
    .pill{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:.7rem}
    .btn{transition:transform .05s ease,opacity .2s}
    .btn:active{transform:translateY(1px)}
    .layout-3{display:grid;grid-template-columns:320px 1fr 360px;gap:1.25rem}
    @media(max-width:1200px){.layout-3{grid-template-columns:1fr}}
    #chartWrap{height:600px} #chart{width:100%;height:100%}
    select:focus,select:active{color:#000!important;background:#fff!important}
    select option{color:#000}
    #dbg{position:fixed;right:8px;bottom:8px;max-width:44ch;font:12px/1.35 ui-monospace,monospace;background:#0b1220cc;color:#cbd5e1;border:1px solid #334155;border-radius:.5rem;padding:.5rem .6rem;z-index:9999;display:none}
  </style>
</head>
<body>
<header class="sticky top-0 z-50 border-b border-slate-800 bg-[color:var(--soft)]">
  <div class="max-w-[1600px] mx-auto px-6 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-indigo-500/20 flex items-center justify-center">
        <span class="text-indigo-300 font-bold">P</span>
      </div>
      <div>
        <h1 class="text-lg font-semibold tracking-wide">POINT — Multipliers (Deriv)</h1>
        <p class="text-xs text-slate-400">App ID: 98640 • OAuth + WebSocket</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="loginBtn" class="btn px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm">Conectar</button>
      <button id="logoutBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-slate-100 text-sm hidden">Desconectar</button>
    </div>
  </div>
</header>

<main class="max-w-[1600px] mx-auto px-6 py-6 space-y-4">
  <div id="dbg"></div>

  <!-- STATUS -->
  <section class="card p-4">
    <div class="flex flex-wrap items-center gap-4 justify-between">
      <div>
        <div id="connStatus" class="text-sm">Desconectado</div>
        <div id="loginNote" class="text-xs text-slate-400">Clique em <b>Conectar</b> para autorizar.</div>
      </div>

      <div class="flex flex-wrap items-center gap-3">
        <label class="text-sm text-slate-300">Conta:</label>
        <select id="accountSelect" class="pill px-3 py-2 text-sm bg-transparent text-slate-200 min-w-[220px]" disabled></select>
        <span id="acctType" class="text-xs px-2 py-1 rounded-md bg-white/10 border border-white/10 text-slate-200">—</span>
        <label class="text-sm text-slate-300">Saldo:</label>
        <input id="balanceInput" class="pill px-3 py-2 text-sm bg-transparent text-slate-200 w-40 text-right" placeholder="—" disabled />
      </div>
    </div>
  </section>

  <section class="layout-3">
    <!-- ESQUERDA -->
    <div class="space-y-4">
      <div class="card p-4">
        <div class="text-xs uppercase tracking-wide text-slate-400 mb-2">Mercado</div>
        <label class="text-sm text-slate-300">Símbolo</label>
        <select id="symbolSelect" class="pill w-full px-3 py-2 text-sm bg-transparent text-slate-200" disabled>
          <option>— carregando —</option>
        </select>
      </div>

      <div class="card p-4">
        <div class="text-xs uppercase tracking-wide text-slate-400">Posição</div>
        <div id="posStatus" class="text-sm mt-1">Nenhuma posição aberta.</div>
        <div class="flex items-center justify-between mt-3">
          <div class="text-sm">P/L: <span id="plVal" class="font-semibold">—</span></div>
          <button id="closeBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-sm hidden">Fechar posição</button>
        </div>
      </div>
    </div>

    <!-- CENTRO: GRÁFICO -->
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="text-xs uppercase tracking-wide text-slate-400">Gráfico</div>
        <div class="flex items-center gap-2">
          <label class="text-xs text-slate-400">Intervalo:</label>
          <select id="timeframeSelect" class="pill px-3 py-2 text-xs bg-transparent text-slate-200">
            <option value="60" selected>1m</option><option value="120">2m</option><option value="180">3m</option>
            <option value="300">5m</option><option value="600">10m</option><option value="900">15m</option>
            <option value="1800">30m</option><option value="3600">1h</option><option value="7200">2h</option>
            <option value="14400">4h</option><option value="28800">8h</option><option value="86400">1d</option>
          </select>
          <button id="zoomInBtn"  class="btn px-2 py-1 rounded-md border border-white/10 text-xs">+</button>
          <button id="zoomOutBtn" class="btn px-2 py-1 rounded-md border border-white/10 text-xs">−</button>
          <button id="zoomFitBtn" class="btn px-2 py-1 rounded-md border border-white/10 text-xs">Fit</button>
        </div>
      </div>
      <div id="chartWrap" class="rounded-xl overflow-hidden"><div id="chart"></div></div>
    </div>

    <!-- DIREITA -->
    <div class="space-y-4">
      <div class="card p-4">
        <div class="text-xs uppercase tracking-wide text-slate-400 mb-2">Parâmetros</div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-slate-300">Stake</label>
            <input id="stakeInput" type="number" min="1" step="1" value="5" class="pill w-full px-3 py-2 bg-transparent text-slate-200" disabled />
          </div>
          <div>
            <label class="text-sm text-slate-300">Multiplier</label>
            <select id="multInput" class="pill w-full px-3 py-2 bg-transparent text-slate-200" disabled>
              <option value="10" selected>x10</option><option value="50">x50</option><option value="100">x100</option>
              <option value="200">x200</option><option value="400">x400</option><option value="800">x800</option>
              <option value="1000">x1000</option><option value="1500">x1500</option><option value="2000">x2000</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-slate-300">Take Profit (opcional)</label>
            <input id="tpInput" type="number" min="1" step="1" placeholder="ex: 150" class="pill w-full px-3 py-2 bg-transparent text-slate-200" disabled />
          </div>
          <div>
            <label class="text-sm text-slate-300">Stop Loss (opcional)</label>
            <input id="slInput" type="number" min="1" step="1" placeholder="ex: 130" class="pill w-full px-3 py-2 bg-transparent text-slate-200" disabled />
          </div>
          <div class="col-span-2">
            <label class="text-sm text-slate-300">Deal Cancellation</label>
            <select id="dcInput" class="pill w-full px-3 py-2 bg-transparent text-slate-200" disabled>
              <option value="">Desligado</option><option value="5m">5m</option><option value="10m">10m</option>
              <option value="15m">15m</option><option value="30m">30m</option><option value="60m">60m</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card p-4">
        <div class="text-xs uppercase tracking-wide text-slate-400 mb-2">Ação</div>
        <div class="flex gap-3">
          <button id="upBtn"   class="btn flex-1 px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white disabled:opacity-40" disabled>UP (MULTUP)</button>
          <button id="downBtn" class="btn flex-1 px-4 py-3 rounded-xl bg-rose-600   hover:bg-rose-500   text-white disabled:opacity-40" disabled>DOWN (MULTDOWN)</button>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
/* ============== DEBUG OVERLAY (ajuda a ver o que acontece) ============== */
const DBG = document.getElementById('dbg');
function dbg(msg){ try{DBG.style.display='block'; DBG.textContent = `[${new Date().toLocaleTimeString()}] ` + msg + '\\n' + DBG.textContent;}catch{} }

/* ================== CONFIG ================== */
const APP_ID = 98640;
const WS_URL = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;
const BASE_URL = (location.origin + location.pathname).replace(/[#?].*$/,'');
const OAUTH_URL = `https://oauth.deriv.com/oauth2/authorize?brand=deriv&app_id=${APP_ID}&response_type=token&scope=${encodeURIComponent('read trade')}&redirect_uri=${encodeURIComponent(BASE_URL)}`;
const DEFAULT_SYMBOL = '1HZ100V';
let CANDLE_GRANULARITY = 60;
/* =========================================== */

/* ---- DOM ---- */
const els = {
  loginBtn: document.getElementById('loginBtn'),
  logoutBtn: document.getElementById('logoutBtn'),
  connStatus: document.getElementById('connStatus'),
  loginNote: document.getElementById('loginNote'),
  accountSelect: document.getElementById('accountSelect'),
  symbolSelect: document.getElementById('symbolSelect'),
  stakeInput: document.getElementById('stakeInput'),
  multInput: document.getElementById('multInput'),
  tpInput: document.getElementById('tpInput'),
  slInput: document.getElementById('slInput'),
  dcInput: document.getElementById('dcInput'),
  upBtn: document.getElementById('upBtn'),
  downBtn: document.getElementById('downBtn'),
  posStatus: document.getElementById('posStatus'),
  plVal: document.getElementById('plVal'),
  closeBtn: document.getElementById('closeBtn'),
  balanceInput: document.getElementById('balanceInput'),
  timeframeSelect: document.getElementById('timeframeSelect'),
  acctType: document.getElementById('acctType'),
};

/* ---- Estado ---- */
let ws=null, authorized=false, selectedToken=null, loginId=null, currency='USD';
let tickSubId=null, candleSubId=null, openContractId=null, pocSubId=null, balanceSubId=null;
let chart, candleSeries, tickSeries;

/* ---- UI ---- */
function setConnectedUI(on){ els.connStatus.textContent = on ? 'Conectado (WebSocket ativo)' : 'Desconectado'; }
function setAuthUI(on){
  authorized = !!on;
  const dis = !on;
  [els.accountSelect, els.symbolSelect, els.stakeInput, els.multInput, els.tpInput, els.slInput, els.dcInput, els.upBtn, els.downBtn, els.timeframeSelect].forEach(el=>el.disabled = dis);
  els.logoutBtn.classList.toggle('hidden', !on);
  els.loginBtn.classList.toggle('hidden', on);
  els.loginNote.textContent = on ? 'Autorizado.' : 'Clique em Conectar para autorizar.';
  if(dis){ els.balanceInput.value=''; els.balanceInput.placeholder='—'; els.acctType.textContent='—'; }
}
function isDemo(loginid){ return /^VRTC/i.test(loginid); }

/* ---- Tokens: CAPTURA ANTES DE QUALQUER OUTRA COISA ---- */
function parseTokens(str){
  const out=[], p=new URLSearchParams(str||'');
  // simples
  ['access_token','token','oauth_token','auth_token'].forEach(k=>{
    const v=p.get(k);
    if(v) out.push({token:v, account:(p.get('loginid')||p.get('acct')||'').toUpperCase()||null, currency:(p.get('currency')||p.get('cur')||'USD').toUpperCase()});
  });
  // numerados (formato da tua URL: acct1/token1/cur1, acct2/token2/cur2)
  for(let i=1;i<=15;i++){
    const t=p.get(`token${i}`)||p.get(`access_token${i}`)||p.get(`oauth_token${i}`);
    const a=p.get(`acct${i}`)||p.get(`loginid${i}`);
    const c=p.get(`cur${i}`)||p.get(`currency${i}`);
    if(t){ out.push({token:t, account:(a||'').toUpperCase()||null, currency:(c||'USD').toUpperCase()}); }
  }
  // fallback heurístico
  p.forEach((v,k)=>{ if(/token/i.test(k) && typeof v==='string' && v.length>15){ out.push({token:v, account:(p.get('loginid')||p.get('acct')||'').toUpperCase()||null, currency:(p.get('currency')||p.get('cur')||'USD').toUpperCase()}); }});
  return out;
}
function extractTokensFromUrl(){
  const q = location.search.startsWith('?') ? location.search.slice(1) : '';
  const h = location.hash.startsWith('#') ? location.hash.slice(1) : '';
  const tokens = [...parseTokens(q), ...parseTokens(h)];
  if(tokens.length){
    localStorage.setItem('POINT_TOKENS', JSON.stringify(tokens));
    history.replaceState({}, document.title, BASE_URL);
    dbg('Tokens capturados: '+tokens.map(t=>`${t.account||'?'}:${t.currency||'USD'}`).join(', '));
  } else {
    dbg('Nenhum token encontrado na URL.');
  }
}
function getStoredTokens(){ try{return JSON.parse(localStorage.getItem('POINT_TOKENS')||'[]')}catch(e){return[]} }
function clearTokens(){ localStorage.removeItem('POINT_TOKENS'); localStorage.removeItem('POINT_SELECTED'); }

/* ---- WebSocket ---- */
function connectWS(){
  if(ws && ws.readyState===1) return;
  ws = new WebSocket(WS_URL);
  ws.onopen = ()=>{
    setConnectedUI(true);
    const tokens=getStoredTokens();
    if(tokens.length){
      const sel = JSON.parse(localStorage.getItem('POINT_SELECTED')||'null') || tokens[0];
      selectedToken = sel.token;
      dbg('WS aberto. Enviando authorize…');
      authorize(sel.token, sel.account, sel.currency);
    } else {
      dbg('WS aberto, porém sem tokens salvos.');
    }
  };
  ws.onclose = ()=>{ setConnectedUI(false); setAuthUI(false); dbg('WS fechado.'); };
  ws.onmessage = handleMessage;
  ws.onerror = (e)=>{ dbg('WS erro. Verifique rede/app_id.'); console.error(e); };
}
function send(msg){ if(!ws || ws.readyState!==1){ dbg('WS não conectado'); return; } ws.send(JSON.stringify(msg)); }

/* ---- Chart (protegido, não bloqueia o app) ---- */
(function initChartSafe(){
  try{
    if(!window.LightweightCharts){ dbg('Lib de gráfico ainda não disponível (tentando usar fallback)…'); }
    const container=document.getElementById('chart');
    if(!window.LightweightCharts){ throw new Error('LightweightCharts indefinido'); }
    chart = LightweightCharts.createChart(container, {
      layout:{background:{type:'solid',color:'#0b1220'},textColor:'#cbd5e1'},
      grid:{vertLines:{color:'#1e293b'},horzLines:{color:'#1e293b'}},
      crosshair:{mode:0}, rightPriceScale:{borderColor:'#334155'}, timeScale:{borderColor:'#334155'},
      handleScroll:true, handleScale:true
    });
    candleSeries = chart.addCandlestickSeries({
      upColor:'#22c55e', downColor:'#ef4444',
      borderDownColor:'#ef4444', borderUpColor:'#22c55e',
      wickDownColor:'#ef4444', wickUpColor:'#22c55e'
    });
    tickSeries = chart.addLineSeries({ lineWidth: 1.5 });
    function resize(){ const wrap=document.getElementById('chartWrap'); chart.applyOptions({width:wrap.clientWidth,height:wrap.clientHeight}); }
    window.addEventListener('resize', resize); setTimeout(resize,10);
    dbg('Gráfico inicializado.');
  }catch(err){
    dbg('Gráfico não inicializado (seguindo sem gráfico): '+err.message);
  }
})();

/* ---- Mensagens ---- */
function handleMessage(evt){
  const data = JSON.parse(evt.data);
  if(data.error){ console.error('API error:', data.error); els.posStatus.textContent = `Erro: ${data.error.message}`; dbg('API erro: '+data.error.message); return; }

  if(data.msg_type==='authorize'){
    loginId = data.authorize.loginid;
    currency = data.authorize.currency || 'USD';
    setAuthUI(true);
    dbg('Authorize OK: '+loginId);

    // dropdown de conta
    els.accountSelect.innerHTML='';
    const o=document.createElement('option'); o.value=loginId; o.textContent=`${loginId} • ${currency}`; els.accountSelect.appendChild(o);
    els.accountSelect.disabled=false;
    els.acctType.textContent = isDemo(loginId) ? 'Conta Demo' : 'Conta Real';

    // lembrar seleção
    const tokens=getStoredTokens(); const chosen=tokens.find(t=>t.token===selectedToken) || {token:selectedToken, account:loginId, currency};
    localStorage.setItem('POINT_SELECTED', JSON.stringify(chosen));

    subscribeBalance();
    loadActiveSymbols();
  }

  if(data.msg_type==='active_symbols'){
    const syms=(data.active_symbols||[])
      .filter(s=>s.market==='synthetic_index'||s.symbol.includes('R_')||s.symbol.includes('VOL')||s.symbol.startsWith('1HZ'))
      .map(s=>({symbol:s.symbol, display:`${s.display_name} (${s.symbol})`}));
    els.symbolSelect.innerHTML='';
    syms.forEach(s=>{ const op=document.createElement('option'); op.value=s.symbol; op.textContent=s.display; els.symbolSelect.appendChild(op); });
    els.symbolSelect.value = syms.find(s=>s.symbol===DEFAULT_SYMBOL)?.symbol || syms[0]?.symbol || '';
    if(els.symbolSelect.value){ subscribeCandles(els.symbolSelect.value); subscribeTicks(els.symbolSelect.value); }
    dbg(`Símbolos carregados (${syms.length}). Selecionado: ${els.symbolSelect.value}`);
  }

  if(data.msg_type==='tick' && tickSeries){ tickSeries.update({ time:+data.tick.epoch, value:+data.tick.quote }); }
  if(data.msg_type==='candles' && candleSeries){
    const arr = Array.isArray(data.candles) ? data.candles : [data.candles];
    const mapped = arr.map(c=>({time:+c.epoch, open:+c.open, high:+c.high, low:+c.low, close:+c.close}));
    if(Array.isArray(data.candles)){ candleSeries.setData(mapped); chart?.timeScale().fitContent(); } else { candleSeries.update(mapped[0]); }
  }

  if(data.msg_type==='proposal' && data.proposal?.id){
    send({ buy: data.proposal.id, price: Number(data.proposal.ask_price) });
  }

  if(data.msg_type==='buy' && data.buy?.contract_id){
    openContractId = data.buy.contract_id;
    els.posStatus.textContent = `Contrato #${openContractId} aberto. A acompanhar...`;
    els.closeBtn.classList.remove('hidden');
    subscribeOpenContract(openContractId);
  }

  if(data.msg_type==='proposal_open_contract'){
    const poc=data.proposal_open_contract; if(!poc) return;
    if(poc.contract_id) openContractId=poc.contract_id;
    els.plVal.textContent = `${Number(poc.profit||0).toFixed(2)} ${currency}`;
    if(poc.is_sold){ els.posStatus.textContent = `Contrato fechado. Resultado: ${Number(poc.profit||0).toFixed(2)} ${currency}`; cleanupPosition(); }
  }

  if(data.msg_type==='balance' && data.balance){
    els.balanceInput.value = `${Number(data.balance.balance).toFixed(2)} ${data.balance.currency || currency}`;
    if(data.subscription?.id && !balanceSubId) balanceSubId = data.subscription.id;
  }
}

/* ---- API ---- */
function authorize(token, acct, cur){ selectedToken=token; currency=(cur||'USD').toUpperCase(); send({ authorize: token, passthrough:{acct} }); }
function loadActiveSymbols(){ send({ active_symbols:'brief', product_type:'basic' }); }
function subscribeTicks(symbol){
  if(tickSubId){ send({ forget: tickSubId }); tickSubId=null; }
  tickSeries?.setData([]);
  send({ ticks:symbol, subscribe:1 });
  ws.addEventListener('message', function once(e){ try{const d=JSON.parse(e.data); if(d.msg_type==='tick'&&d.subscription?.id){ tickSubId=d.subscription.id; ws.removeEventListener('message', once);} }catch{} });
}
function subscribeCandles(symbol){
  if(candleSubId){ send({ forget: candleSubId }); candleSubId=null; }
  send({ ticks_history:symbol, style:'candles', granularity:CANDLE_GRANULARITY, count:300, subscribe:1 });
  ws.addEventListener('message', function once(e){ try{const d=JSON.parse(e.data); if(d.msg_type==='candles'&&d.subscription?.id){ candleSubId=d.subscription.id; ws.removeEventListener('message', once);} }catch{} });
}
function subscribeOpenContract(id){
  if(pocSubId){ send({ forget: pocSubId }); pocSubId=null; }
  send({ proposal_open_contract:1, contract_id:id, subscribe:1 });
  ws.addEventListener('message', function once(e){ try{const d=JSON.parse(e.data); if(d.msg_type==='proposal_open_contract'&&d.subscription?.id){ pocSubId=d.subscription.id; ws.removeEventListener('message', once);} }catch{} });
}
function subscribeBalance(){ if(balanceSubId){ send({ forget: balanceSubId }); balanceSubId=null; } send({ balance:1, subscribe:1 }); }
function cleanupPosition(){ openContractId=null; if(pocSubId){ send({ forget:pocSubId }); pocSubId=null; } els.closeBtn.classList.add('hidden'); els.plVal.textContent='—'; }

/* ---- Eventos ---- */
els.loginBtn.onclick = ()=>{ window.location.href = OAUTH_URL; };
els.logoutBtn.onclick = ()=>{
  cleanupPosition();
  if(ws && ws.readyState===1) ws.close();
  if(balanceSubId){ send({ forget: balanceSubId }); balanceSubId=null; }
  if(tickSubId){ send({ forget: tickSubId }); tickSubId=null; }
  if(candleSubId){ send({ forget: candleSubId }); candleSubId=null; }
  clearTokens(); selectedToken=null; loginId=null; setAuthUI(false);
  els.accountSelect.innerHTML=''; candleSeries?.setData([]); tickSeries?.setData([]); dbg('Sessão limpa.');
};
els.accountSelect.onchange = ()=>{
  const opt = els.accountSelect.value; if(!opt) return;
  const tokens = getStoredTokens(); const chosen = tokens.find(t=>t.account===opt) || tokens[0];
  if(!chosen) return;
  localStorage.setItem('POINT_SELECTED', JSON.stringify(chosen));
  els.acctType.textContent = isDemo(opt) ? 'Conta Demo' : 'Conta Real';
  if(ws && ws.readyState===1) authorize(chosen.token, chosen.account, chosen.currency);
  else connectWS();
  setTimeout(()=>subscribeBalance(), 200);
};
els.symbolSelect.onchange = e=>{ const sym=e.target.value; if(sym){ subscribeCandles(sym); subscribeTicks(sym); } };
els.timeframeSelect.onchange = e=>{ CANDLE_GRANULARITY = Number(e.target.value||60); const sym=els.symbolSelect.value||DEFAULT_SYMBOL; if(sym) subscribeCandles(sym); };
document.getElementById('zoomInBtn').onclick  = ()=>{ if(!chart) return; const s=chart.timeScale().getBarSpacing(); chart.timeScale().setBarSpacing(s*0.8); };
document.getElementById('zoomOutBtn').onclick = ()=>{ if(!chart) return; const s=chart.timeScale().getBarSpacing(); chart.timeScale().setBarSpacing(s*1.25); };
document.getElementById('zoomFitBtn').onclick  = ()=>{ if(!chart) return; chart.timeScale().fitContent(); };

/* ---- Boot: 1) captura tokens; 2) popula contas; 3) conecta WS ---- */
(function init(){
  extractTokensFromUrl();                         // 1
  const tokens=getStoredTokens();
  els.accountSelect.innerHTML='';                 // 2
  tokens.forEach(t=>{ if(t.account){ const o=document.createElement('option'); o.value=t.account; o.textContent=`${t.account} • ${t.currency||'USD'}`; els.accountSelect.appendChild(o);} });
  if(els.accountSelect.options.length) els.accountSelect.disabled=false;
  if(tokens.length){ localStorage.setItem('POINT_SELECTED', JSON.stringify(tokens[0])); }
  connectWS();                                    // 3
})();
</script>
</body>
</html>
