<!DOCTYPE html> 
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POINT — Multipliers (Deriv)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root{
      --bg:#0b1220;--card:#121a2b;--muted:#9fb0d0;--ok:#22c55e;--warn:#eab308;--err:#ef4444;--ink:#e6edf7;--soft:#1b2740
    }
    body{background:var(--bg);color:var(--ink)}
    .card{background:var(--card);border:1px solid #1e2a46}
    .pill{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08)}
    .btn{transition:transform .05s ease}
    .btn:active{transform:translateY(1px)}
    .glass{backdrop-filter: blur(8px); background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06)}
    .grid-col{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}

    /* Layout 3 colunas: esquerda (Posição) / centro (Gráfico) / direita (Mercado + Ação) */
    .layout{
      display:grid;
      grid-template-columns: 260px 1fr 300px;
      gap: 12px;
    }
    @media (max-width: 1024px){
      .layout{ grid-template-columns: 1fr; }
    }

    /* selects com texto preto ao focar (teu ajuste) */
    select:focus, select:active { color:#000 !important; }
    select option { color:#000; }

    /* Gráfico */
    #chartWrap { height: 480px; transition: height .2s ease; }
    @media (max-width:1024px){ #chartWrap{ height: 420px; } }
  </style>
</head>
<body>
  <header class="sticky top-0 z-50 border-b border-slate-800 bg-[color:var(--soft)]">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-indigo-500/20 flex items-center justify-center">
          <span class="text-indigo-300 font-bold">P</span>
        </div>
        <div>
          <h1 class="text-lg font-semibold tracking-wide">POINT — Multipliers (Deriv)</h1>
          <p class="text-xs text-slate-400">App ID: 98640 • OAuth + WebSocket</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="loginBtn" class="btn px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm">Conectar</button>
        <button id="logoutBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-slate-100 text-sm hidden">Desconectar</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-4">
    <!-- STATUS / CONTAS -->
    <section class="card rounded-2xl p-4">
      <div class="flex flex-wrap items-center gap-3 justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-emerald-500/15 flex items-center justify-center">
            <span class="text-emerald-300">●</span>
          </div>
          <div>
            <div id="connStatus" class="text-sm text-slate-300">Desconectado</div>
            <div id="loginNote" class="text-xs text-slate-400">
              Clique em <b>Conectar</b> para iniciar o OAuth (será redirecionado e voltará com os tokens).
            </div>
          </div>
        </div>

        <div class="flex flex-col gap-2">
          <div class="flex items-center gap-3">
            <label class="text-sm text-slate-300">Conta:</label>
            <select id="accountSelect" class="pill px-3 py-2 rounded-xl text-sm text-slate-200 bg-transparent" disabled></select>
            <button id="useAccountBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-sm disabled:opacity-50" disabled>Usar conta</button>
          </div>
          <div class="flex items-center gap-3">
            <label class="text-sm text-slate-300">Saldo:</label>
            <input id="balanceInput" class="pill px-3 py-2 rounded-xl text-sm bg-transparent text-slate-200 w-40 text-right" placeholder="—" disabled />
            <button id="refreshBalanceBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-sm disabled:opacity-50" disabled>Atualizar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ======= LAYOUT: ESQ (Posição) | CENTRO (Gráfico) | DIR (Mercado + Ação) ======= -->
    <div class="layout">
      <!-- ESQUERDA: POSIÇÃO -->
      <section class="card rounded-2xl p-4">
        <div class="text-xs uppercase tracking-wide text-slate-400 mb-3">Posição</div>

        <!-- Box mercado fechado -->
        <div id="closedBox" class="hidden space-y-2 text-sm">
          <div class="text-rose-400 font-medium">Este mercado está fechado</div>
          <div id="reopenLine" class="text-slate-300"></div>
          <div class="text-slate-400">Por favor, volte a entrar</div>
          <div id="reopenCountdown" class="text-slate-200 font-semibold text-lg">—</div>
          <div class="text-slate-400 text-xs">Entretanto, experimente os Índices Synthetic (abertos 24/7)</div>
          <hr class="border-slate-700 my-2"/>
        </div>

        <!-- Resumo dinâmico da posição / contrato aberto -->
        <div id="posDetails" class="space-y-2 text-sm">
          <div id="posStatus" class="text-sm">Nenhuma posição aberta.</div>
          <div class="grid grid-cols-2 gap-x-3 gap-y-1 mt-2">
            <div class="text-slate-400">Ativo</div><div id="pd_asset" class="text-slate-200">—</div>
            <div class="text-slate-400">Tipo</div><div id="pd_type" class="text-slate-200">Multipliers</div>
            <div class="text-slate-400">Direção</div><div id="pd_dir" class="text-slate-200">—</div>
            <div class="text-slate-400">Moeda</div><div id="pd_ccy" class="text-slate-200">—</div>

            <div class="col-span-2 h-[1px] bg-slate-800 my-1"></div>

            <div class="text-slate-400">Custos do contrato</div><div id="pd_cost" class="text-slate-200">—</div>
            <div class="text-slate-400">Valor do contrato</div><div id="pd_value" class="text-slate-200">—</div>
            <div class="text-slate-400">Taxa de cancelamento</div><div id="pd_cancel" class="text-slate-200">—</div>
            <div class="text-slate-400">Entrada</div><div id="pd_entry" class="text-slate-200">—</div>
            <div class="text-slate-400">Take profit</div><div id="pd_tp" class="text-slate-200">—</div>
            <div class="text-slate-400">Stop loss</div><div id="pd_sl" class="text-slate-200">—</div>
          </div>

          <div class="flex items-center justify-between pt-2">
            <div class="text-sm">Lucro/perda total:</div>
            <div class="text-sm font-semibold" id="plVal">—</div>
          </div>
          <button id="closeBtn" class="btn w-full px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-sm hidden">Fechar posição</button>
        </div>
      </section>

      <!-- CENTRO: GRÁFICO -->
      <section class="card rounded-2xl p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-xs uppercase tracking-wide text-slate-400">Gráfico de Tendências (Velas)</div>
          <div class="flex items-center gap-2">
            <label for="tfSelect" class="text-xs text-slate-400">Timeframe</label>
            <select id="tfSelect" class="pill px-2 py-1 rounded-lg text-sm bg-transparent text-slate-200" disabled>
              <option value="60" selected>1m</option>
              <option value="120">2m</option>
              <option value="180">3m</option>
              <option value="300">5m</option>
              <option value="600">10m</option>
              <option value="900">15m</option>
              <option value="1800">30m</option>
              <option value="3600">1h</option>
              <option value="7200">2h</option>
              <option value="14400">4h</option>
              <option value="28800">8h</option>
              <option value="86400">1d</option>
            </select>
          </div>
        </div>
        <div id="chartWrap" class="glass rounded-xl"></div>

        <!-- Preço em tempo real: oculto para não quebrar JS -->
        <div class="glass rounded-xl p-4 mt-3 hidden">
          <div id="tickSymbol" class="text-sm text-slate-400">—</div>
          <div class="text-3xl font-semibold mt-1" id="tickPrice">—</div>
          <div class="mt-3 text-xs text-slate-400" id="tickNote">Assina ticks ao escolher o símbolo.</div>
        </div>
      </section>

      <!-- DIREITA: MERCADO + AÇÃO -->
      <div class="flex flex-col gap-3">
        <!-- MERCADO -->
        <section class="card rounded-2xl p-4">
          <div class="text-xs uppercase tracking-wide text-slate-400 mb-3 flex items-center gap-2">
            <span>Mercado</span>
            <span id="marketStatus" class="text-rose-400 text-xs font-medium hidden">Fechado</span>
          </div>
          <div class="space-y-3">
            <div>
              <label class="text-sm text-slate-300">Símbolo</label>
              <div class="flex items-center gap-2">
                <select id="symbolSelect" class="pill w-full px-3 py-2 rounded-xl text-sm bg-transparent text-slate-200" disabled>
                  <option>— carregando —</option>
                </select>
                <span id="multBadge" class="px-2 py-1 rounded-lg text-xs border hidden"></span>
              </div>
            </div>
            <div class="grid-col">
              <div>
                <label class="text-sm text-slate-300">Stake</label>
                <input id="stakeInput" type="number" min="1" step="1" value="10" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled />
              </div>
              <div>
                <label class="text-sm text-slate-300">Multiplier</label>
                <select id="multInput" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled>
                  <!-- opções preenchidas dinamicamente por símbolo -->
                </select>
              </div>
            </div>
            <div class="grid-col">
              <div>
                <label class="text-sm text-slate-300">Take Profit (opcional)</label>
                <input id="tpInput" type="number" min="1" step="1" placeholder="ex: 150" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled />
              </div>
              <div>
                <label class="text-sm text-slate-300">Stop Loss (opcional)</label>
                <input id="slInput" type="number" min="1" step="1" placeholder="ex: 130" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled />
              </div>
            </div>
            <div>
              <label class="text-sm text-slate-300">Deal Cancellation</label>
              <select id="dcInput" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled>
                <option value="">Desligado</option>
                <option value="5m">5m</option>
                <option value="10m">10m</option>
                <option value="15m">15m</option>
                <option value="30m">30m</option>
                <option value="60m">60m</option>
              </select>
            </div>
          </div>
        </section>

        <!-- AÇÃO -->
        <section class="card rounded-2xl p-4">
          <div class="text-xs uppercase tracking-wide text-slate-400 mb-3">Ação</div>
          <div class="flex gap-3">
            <button id="upBtn" class="btn flex-1 px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white disabled:opacity-40" disabled>UP (MULTUP)</button>
            <button id="downBtn" class="btn flex-1 px-4 py-3 rounded-xl bg-rose-600 hover:bg-rose-500 text-white disabled:opacity-40" disabled>DOWN (MULTDOWN)</button>
          </div>
          <div class="text-xs text-slate-400 mt-2">
            Multipliers: perdas limitadas ao <b>stake</b>; podes fechar a qualquer momento; TP/SL e Cancellation suportados.
          </div>
        </section>
      </div>
    </div>
  </main>

  <script>
    // ================== CONFIG ==================
    const APP_ID = 98640; // POINT
    const WS_URL = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;
    const OAUTH_URL = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}`;
    // ============================================

    // Estado global
    let ws = null;
    let authorized = false;
    let selectedToken = null;
    let loginId = null;
    let currency = 'USD';
    let tickSubId = null;
    let openContractId = null;
    let pocSubId = null;
    let balanceSubId = null;

    // Gráfico
    let lwChart = null;
    let candleSeries = null;
    let ohlcSubId = null;
    let currentSymbol = null;
    let currentGranularity = 60; // 1m
    let liveBar = null;
    let markers = [];

    // controle de erros visuais (só mostrar quando for ação do usuário)
    let lastUserActionAt = 0;

    // countdown de reabertura
    let reopenTimer = null;
    let nextReopenEpoch = null;

    const els = {
      loginBtn: document.getElementById('loginBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      connStatus: document.getElementById('connStatus'),
      loginNote: document.getElementById('loginNote'),
      accountSelect: document.getElementById('accountSelect'),
      useAccountBtn: document.getElementById('useAccountBtn'),
      symbolSelect: document.getElementById('symbolSelect'),
      stakeInput: document.getElementById('stakeInput'),
      multInput: document.getElementById('multInput'),
      tpInput: document.getElementById('tpInput'),
      slInput: document.getElementById('slInput'),
      dcInput: document.getElementById('dcInput'),
      upBtn: document.getElementById('upBtn'),
      downBtn: document.getElementById('downBtn'),
      tickSymbol: document.getElementById('tickSymbol'),
      tickPrice: document.getElementById('tickPrice'),
      tickNote: document.getElementById('tickNote'),
      posStatus: document.getElementById('posStatus'),
      plVal: document.getElementById('plVal'),
      closeBtn: document.getElementById('closeBtn'),
      balanceInput: document.getElementById('balanceInput'),
      refreshBalanceBtn: document.getElementById('refreshBalanceBtn'),
      tfSelect: document.getElementById('tfSelect'),
      chartWrap: document.getElementById('chartWrap'),
      multBadge: document.getElementById('multBadge'),
      marketStatus: document.getElementById('marketStatus'),
      closedBox: document.getElementById('closedBox'),
      reopenLine: document.getElementById('reopenLine'),
      reopenCountdown: document.getElementById('reopenCountdown'),
      // posição – detalhes
      pd_asset: document.getElementById('pd_asset'),
      pd_type: document.getElementById('pd_type'),
      pd_dir : document.getElementById('pd_dir'),
      pd_ccy : document.getElementById('pd_ccy'),
      pd_cost: document.getElementById('pd_cost'),
      pd_value: document.getElementById('pd_value'),
      pd_cancel: document.getElementById('pd_cancel'),
      pd_entry: document.getElementById('pd_entry'),
      pd_tp: document.getElementById('pd_tp'),
      pd_sl: document.getElementById('pd_sl'),
    };

    // Helpers UI
    function setConnectedUI(on){
      els.connStatus.textContent = on ? 'Conectado (WebSocket ativo)' : 'Desconectado';
    }
    function setAuthUI(on){
      authorized = !!on;
      const dis = !on;
      [els.accountSelect, els.useAccountBtn, els.symbolSelect, els.stakeInput, els.multInput, els.tpInput, els.slInput, els.dcInput, els.upBtn, els.downBtn, els.refreshBalanceBtn, els.tfSelect].forEach(el=>{
        el.disabled = dis;
      });
      els.logoutBtn.classList.toggle('hidden', !on);
      els.loginBtn.classList.toggle('hidden', on);
      els.loginNote.textContent = on
        ? 'Autorizado. Escolhe a conta e o símbolo para negociar.'
        : 'Clique em Conectar para iniciar o OAuth.';
      if(dis){ els.balanceInput.value = ''; els.balanceInput.placeholder = '—'; }
    }
    function toast(msg,isErr=false,forceUI=false){
      console[isErr?'error':'log'](msg);
      // só coloca no painel se for um erro logo após uma ação do usuário OU se for forçado
      const recentAction = (Date.now() - lastUserActionAt) < 4000;
      if(isErr && (recentAction || forceUI)){
        els.posStatus.textContent = `Erro: ${msg}`;
      }
      // Se erro inclui “Accepts …”, sincroniza multipliers
      if(isErr && /Accepts/i.test(String(msg))){
        const list = String(msg).split('Accepts')[1]?.replace(':','').trim();
        if(list){
          const values = list.split(',').map(s=>Number(s.trim())).filter(Boolean);
          if(values.length) setMultiplierOptions(values);
        }
      }
    }
    function setBadge(available){
      const b = els.multBadge;
      if(!b) return;
      b.classList.remove('hidden');
      if(available){
        b.textContent = 'Multipliers: disponível';
        b.className = 'px-2 py-1 rounded-lg text-xs border bg-emerald-500/10 text-emerald-300 border-emerald-500/30';
      }else{
        b.textContent = 'Multipliers: indisponível';
        b.className = 'px-2 py-1 rounded-lg text-xs border bg-rose-500/10 text-rose-300 border-rose-500/30';
      }
    }
    function setMultiplierOptions(list){
      els.multInput.innerHTML = '';
      (list && list.length ? list : [10,50,100,200,400]).forEach(v=>{
        const o = document.createElement('option');
        o.value = String(v);
        o.textContent = 'x'+v;
        els.multInput.appendChild(o);
      });
    }
    function showMarketClosedUI(isClosed, reopenEpoch=null, marketName=''){
      els.marketStatus.classList.toggle('hidden', !isClosed);
      els.closedBox.classList.toggle('hidden', !isClosed);
      if(reopenTimer){ clearInterval(reopenTimer); reopenTimer=null; }
      if(!isClosed){ els.reopenCountdown.textContent='—'; return; }
      nextReopenEpoch = reopenEpoch||null;

      // linha “Reabrirá em …”
      if(nextReopenEpoch){
        const dt = new Date(nextReopenEpoch*1000);
        const fmtDate = dt.toLocaleDateString('pt-PT', { weekday:'long', day:'2-digit', month:'short', year:'numeric', timeZone:'UTC' }).replace('.', '');
        const hours = dt.getUTCHours();
        const mins = dt.getUTCMinutes().toString().padStart(2,'0');
        const ampm = hours<12 ? 'am' : 'pm';
        const h12 = ((hours+11)%12+1);
        els.reopenLine.textContent = `Reabrirá em ${h12}:${mins} ${ampm} (GMT) à ${fmtDate}`;
      }else{
        els.reopenLine.textContent = 'Reabrirá em breve';
      }

      // countdown
      if(nextReopenEpoch){
        const update = ()=>{
          const now = Math.floor(Date.now()/1000);
          let sec = nextReopenEpoch - now;
          if(sec < 0) sec = 0;
          const h = Math.floor(sec/3600);
          const m = Math.floor((sec%3600)/60);
          const s = sec%60;
          els.reopenCountdown.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        };
        update();
        reopenTimer = setInterval(update, 1000);
      }
    }

    // OAuth
    function extractTokensFromUrl(){
      const q = new URLSearchParams(location.search);
      const tokens = [];
      for (let i=1;i<=10;i++){
        const acct = q.get(`acct${i}`), token = q.get(`token${i}`), cur = q.get(`cur${i}`);
        if(acct && token){
          tokens.push({account:acct.toUpperCase(), token, currency:(cur||'USD').toUpperCase()});
        }
      }
      if(tokens.length){
        localStorage.setItem('POINT_TOKENS', JSON.stringify(tokens));
        history.replaceState({}, document.title, location.pathname);
      }
    }
    function getStoredTokens(){
      try { return JSON.parse(localStorage.getItem('POINT_TOKENS')||'[]'); } catch(e){ return []; }
    }
    function clearTokens(){
      localStorage.removeItem('POINT_TOKENS');
      localStorage.removeItem('POINT_SELECTED');
    }

    // WebSocket
    function connectWS(){
      if(ws && ws.readyState===1) return;
      ws = new WebSocket(WS_URL);
      ws.onopen = ()=>{
        setConnectedUI(true);
        const remembered = JSON.parse(localStorage.getItem('POINT_SELECTED')||'null');
        const tokens = getStoredTokens();
        if(remembered && tokens.length){
          const match = tokens.find(t=>t.account===remembered.account);
          if(match) authorize(match.token, match.account, match.currency);
        }
      };
      ws.onclose = ()=>{
        setConnectedUI(false);
        setAuthUI(false);
      };
      ws.onmessage = handleMessage;
      ws.onerror = ()=>toast('WebSocket error', true, false);
    }

    function send(msg){
      if(!ws || ws.readyState!==1){ toast('WS não conectado', true, true); return; }
      ws.send(JSON.stringify(msg));
    }

    function handleMessage(evt){
      const data = JSON.parse(evt.data);

      if(data.error){
        // Erros genéricos que não são de ação do usuário não poluem UI
        toast(data.error.message || 'Erro desconhecido', true, false);
        return;
      }

      if(data.msg_type==='authorize'){
        loginId = data.authorize.loginid;
        currency = data.authorize.currency || 'USD';
        els.pd_ccy.textContent = currency;
        setAuthUI(true);
        initChart();
        loadActiveSymbols();
        els.posStatus.textContent = 'Nenhuma posição aberta.';
        subscribeBalance();
      }

      // Active symbols => popula por grupos, sem (R_xx) no nome
      if(data.msg_type==='active_symbols'){
        const syms = (data.active_symbols||[]).map(s=>({
          symbol:s.symbol,
          display:s.display_name, // sem código entre parênteses
          market:s.market, submarket:s.submarket
        }));

        const groups = {
          synthetic_index: {label:'Derived Synthetic', items:[]},
          basket_index:    {label:'Baskets', items:[]},
          cryptocurrency:  {label:'Criptomoedas', items:[]},
          others:          {label:'Outros', items:[]}
        };
        syms.forEach(s=>{
          (groups[s.market] ? groups[s.market].items : groups.others.items).push(s);
        });

        els.symbolSelect.innerHTML = '';
        Object.values(groups).forEach(g=>{
          if(!g.items.length) return;
          const og = document.createElement('optgroup');
          og.label = g.label;
          g.items.sort((a,b)=>a.display.localeCompare(b.display)).forEach(s=>{
            const o=document.createElement('option');
            o.value = s.symbol; o.textContent = s.display;
            og.appendChild(o);
          });
          els.symbolSelect.appendChild(og);
        });

        const first = els.symbolSelect.querySelector('option');
        if(first) {
          els.symbolSelect.value = first.value;
          currentSymbol = first.value;
          subscribeTicks(currentSymbol);
          loadCandles(currentSymbol, currentGranularity);
          checkMultipliersAvailability(currentSymbol);
          checkTradingTimes(currentSymbol);
          els.pd_asset.textContent = first.textContent;
        }
      }

      // tick => intrabar
      if(data.msg_type==='tick' && data.tick){
        const q = Number(data.tick.quote);
        const epoch = Number(data.tick.epoch);
        const sym = data.tick.symbol;

        if(els.tickPrice){
          let s = q.toFixed(5);
          if(s.endsWith('00')) s = s.slice(0,-2);
          els.tickPrice.textContent = s;
        }

        if(sym === currentSymbol && candleSeries){
          const bucket = Math.floor(epoch / currentGranularity) * currentGranularity;
          if(!liveBar || liveBar.time !== bucket){
            liveBar = { time: bucket, open: q, high: q, low: q, close: q };
          }else{
            if(q > liveBar.high) liveBar.high = q;
            if(q < liveBar.low)  liveBar.low  = q;
            liveBar.close = q;
          }
          candleSeries.update(liveBar);
        }
      }

      // histórico candles
      if(data.msg_type==='candles' && Array.isArray(data.candles)){
        const bars = data.candles.map(c=>({
          time: Number(c.epoch),
          open: Number(c.open),
          high: Number(c.high),
          low: Number(c.low),
          close: Number(c.close),
        }));
        if(candleSeries){
          candleSeries.setData(bars);
          liveBar = bars[bars.length - 1] || null;
          lwChart.timeScale().fitContent();
        }
      }

      // stream OHLC (fecha velas)
      if(data.msg_type==='ohlc' && data.ohlc){
        if(!candleSeries) return;
        const c = data.ohlc;
        const bar = {
          time: Number(c.open_time),
          open: Number(c.open),
          high: Number(c.high),
          low: Number(c.low),
          close: Number(c.close),
        };
        candleSeries.update(bar);
        if(c.complete) liveBar = null;
      }

      // proposal -> buy
      if(data.msg_type==='proposal'){
        if(data.proposal && data.proposal.id){
          const p = data.proposal;
          // preencher detalhes
          els.pd_value.textContent = `${Number(p.ask_price).toFixed(2)} ${currency}`;
          els.pd_cost.textContent = (p.commission!=null) ? `${Number(p.commission).toFixed(2)} ${currency}` : '-';

          const id = p.id;
          const ask = Number(p.ask_price);
          send({ buy: id, price: ask });
        } else {
          els.posStatus.textContent = 'Falha ao receber proposta.';
        }
      }

      // buy -> contrato aberto
      if(data.msg_type==='buy'){
        if(data.buy && data.buy.contract_id){
          openContractId = data.buy.contract_id;
          els.posStatus.textContent = `Contrato #${openContractId} aberto. A acompanhar...`;
          els.closeBtn.classList.remove('hidden');
          subscribeOpenContract(openContractId);
        }
      }

      // proposta de contrato em aberto (P/L + detalhes + marcador no gráfico)
      if(data.msg_type==='proposal_open_contract'){
        const poc = data.proposal_open_contract;
        if(!poc) return;

        // direção / entrada / TP / SL
        if(poc.contract_type){
          const dir = poc.contract_type.includes('UP') ? 'Up' : 'Down';
          const mult = els.multInput.value || '—';
          els.pd_dir.textContent = `${dir} x${mult}`;
        }
        if(poc.buy_price!=null) els.pd_entry.textContent = `${Number(poc.buy_price).toFixed(2)} ${currency}`;
        els.pd_tp.textContent = (poc.limit_order && poc.limit_order.take_profit) ? Number(poc.limit_order.take_profit).toFixed(2) : '-';
        els.pd_sl.textContent = (poc.limit_order && poc.limit_order.stop_loss) ? Number(poc.limit_order.stop_loss).toFixed(2) : '-';
        els.pd_cancel.textContent = poc.cancellation ? poc.cancellation : '-';

        // P/L
        const pl = (poc.profit || 0);
        els.plVal.textContent = `${pl.toFixed(2)} ${currency}`;

        // marcador no gráfico no momento da entrada
        if(poc.entry_tick_time && poc.entry_tick){
          const t = Number(poc.entry_tick_time);
          const price = Number(poc.entry_tick);
          const dirUp = poc.contract_type.includes('UP');
          markers.push({
            time: t,
            position: dirUp ? 'belowBar' : 'aboveBar',
            color: dirUp ? '#22c55e' : '#ef4444',
            shape: 'arrowUp',
            text: dirUp ? 'UP' : 'DOWN',
          });
          candleSeries.setMarkers(markers);
        }

        if(poc.is_sold){
          els.posStatus.textContent = `Contrato fechado. Resultado: ${pl.toFixed(2)} ${currency}`;
          cleanupPosition();
        }
      }

      // sell enviado
      if(data.msg_type==='sell'){
        // ok
      }

      // balance
      if(data.msg_type==='balance'){
        if(data.balance && typeof data.balance.balance !== 'undefined'){
          const bal = Number(data.balance.balance);
          els.balanceInput.value = `${bal.toFixed(2)} ${data.balance.currency || currency}`;
        }
        if(data.subscription && data.subscription.id && !balanceSubId){
          balanceSubId = data.subscription.id;
        }
      }

      // contracts_for -> multipliers e disponibilidade
      if(data.msg_type==='contracts_for' && data.contracts_for){
        const a = data.contracts_for.available || [];
        const types = a.flatMap(x => (x.contract_type || []));
        const hasMult = types.includes('MULTUP') || types.includes('MULTDOWN');
        els.upBtn.disabled = !hasMult || !authorized;
        els.downBtn.disabled = !hasMult || !authorized;
        setBadge(hasMult);

        let allowed = [];
        for(const item of a){
          if(item.contract_type && (item.contract_type.includes('MULTUP') || item.contract_type.includes('MULTDOWN'))){
            if(Array.isArray(item.available_multipliers)) allowed = allowed.concat(item.available_multipliers);
            if(item.multiplier_range && Array.isArray(item.multiplier_range.list)) allowed = allowed.concat(item.multiplier_range.list);
            if(Array.isArray(item.multipliers)) allowed = allowed.concat(item.multipliers);
          }
        }
        if(allowed.length){
          allowed = [...new Set(allowed.map(Number).filter(Boolean))].sort((x,y)=>x-y);
          setMultiplierOptions(allowed);
        }
      }

      // trading_times -> estado de mercado
      if(data.msg_type==='trading_times' && data.trading_times){
        const info = findSymbolTradingInfo(data.trading_times, currentSymbol);
        if(info){
          const isOpen = info.is_open;
          const next = info.next_open_time ? Number(info.next_open_time) : null;
          showMarketClosedUI(!isOpen, next);
          els.upBtn.disabled = !isOpen || els.upBtn.disabled;
          els.downBtn.disabled = !isOpen || els.downBtn.disabled;
        }
      }
    }

    // API
    function authorize(token, acct, cur){
      selectedToken = token;
      currency = (cur||'USD').toUpperCase();
      els.pd_ccy.textContent = currency;
      send({ authorize: token, passthrough:{acct} });
    }

    function loadActiveSymbols(){
      send({ active_symbols: 'full' }); // full para obter market/submarket/nomes
    }

    function subscribeTicks(symbol){
      if(tickSubId){ send({ forget: tickSubId }); tickSubId=null; }
      if(els.tickSymbol) els.tickSymbol.textContent = symbol;
      if(els.tickNote) els.tickNote.textContent = 'Recebendo ticks...';
      send({ ticks: symbol, subscribe: 1 });
      ws.addEventListener('message', function once(e){
        const d = JSON.parse(e.data);
        if(d.msg_type==='tick' && d.tick && d.subscription && d.subscription.id){
          tickSubId = d.subscription.id;
          ws.removeEventListener('message', once);
        }
      });
    }

    function subscribeOpenContract(contract_id){
      if(pocSubId){ send({ forget: pocSubId }); pocSubId=null; }
      send({ proposal_open_contract: 1, contract_id, subscribe: 1 });
      ws.addEventListener('message', function once(e){
        const d = JSON.parse(e.data);
        if(d.msg_type==='proposal_open_contract' && d.subscription && d.subscription.id){
          pocSubId = d.subscription.id;
          ws.removeEventListener('message', once);
        }
      });
    }

    function subscribeBalance(){
      if(balanceSubId){ send({ forget: balanceSubId }); balanceSubId = null; }
      send({ balance: 1, subscribe: 1 });
      els.refreshBalanceBtn.disabled = false;
    }

    function requestBalanceOnce(){
      send({ balance: 1 });
    }

    function cleanupPosition(){
      openContractId = null;
      if(pocSubId){ send({ forget: pocSubId }); pocSubId=null; }
      els.closeBtn.classList.add('hidden');
      els.plVal.textContent = '—';
    }

    function placeMultiplier(direction){
      if(!authorized) return toast('Autorize primeiro', true, true);
      const symbol = els.symbolSelect.value;
      const amount = Number(els.stakeInput.value||0);
      const multiplier = Number(els.multInput.value||0);
      if(!symbol || !amount || !multiplier){ els.posStatus.textContent='Preencha símbolo, stake e multiplier'; return; }

      const limit_order = {};
      const tp = Number(els.tpInput.value||0);
      const sl = Number(els.slInput.value||0);
      if(tp>0) limit_order.take_profit = tp;
      if(sl>0) limit_order.stop_loss = sl;

      const req = {
        proposal: 1,
        amount,
        basis: 'stake',
        contract_type: direction==='up' ? 'MULTUP' : 'MULTDOWN',
        currency,
        symbol,
        multiplier
        // NÃO enviar product_type aqui
      };
      if(Object.keys(limit_order).length) req.limit_order = limit_order;
      const dc = els.dcInput.value;
      if(dc) req.cancellation = dc;

      // preencher dados fixos do painel
      els.pd_asset.textContent = els.symbolSelect.selectedOptions[0]?.textContent || symbol;
      els.pd_dir.textContent = `${direction==='up'?'Up':'Down'} x${multiplier}`;
      els.pd_entry.textContent = `${amount.toFixed(2)} ${currency}`;
      els.pd_tp.textContent = tp>0 ? tp.toFixed(2) : '-';
      els.pd_sl.textContent = sl>0 ? sl.toFixed(2) : '-';
      els.pd_cancel.textContent = dc ? dc : '-';

      lastUserActionAt = Date.now();
      els.posStatus.textContent = 'Enviando proposal...';
      send(req);
    }

    // ======== GRÁFICO ========
    function initChart(){
      if(lwChart || !els.chartWrap) return;
      lwChart = LightweightCharts.createChart(els.chartWrap, {
        autoSize: true,
        layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#9fb0d0' },
        grid: { vertLines: { color: '#1e2a46' }, horzLines: { color: '#1e2a46' } },
        crosshair: { mode: LightweightCharts.CrosshairMode.Magnet },
        rightPriceScale: { borderColor: '#1e2a46' },
        timeScale: {
          borderColor: '#1e2a46',
          timeVisible: true,
          secondsVisible: false,
          rightOffset: 3, // folga à direita
          fixRightEdge: false,
          fixLeftEdge: false
        },
      });

      candleSeries = lwChart.addCandlestickSeries({
        upColor: '#22c55e',
        downColor: '#ef4444',
        wickUpColor: '#22c55e',
        wickDownColor: '#ef4444',
        borderVisible: false,
      });

      new ResizeObserver(() => { lwChart.applyOptions({}); }).observe(els.chartWrap);
    }

    function loadCandles(symbol, granularitySec){
      if(!symbol) return;
      currentSymbol = symbol;
      currentGranularity = Number(granularitySec||60);

      liveBar = null;
      if(candleSeries) {
        candleSeries.setData([]);
        candleSeries.setMarkers(markers); // preserva marcadores antigos
      }

      if(ohlcSubId){
        send({ forget: ohlcSubId });
        ohlcSubId = null;
      }

      // Histórico
      send({
        ticks_history: symbol,
        adjust_start_time: 1,
        count: 300,
        end: 'latest',
        style: 'candles',
        granularity: currentGranularity
      });

      // Stream OHLC
      send({
        ohlc: 1,
        symbol,
        granularity: currentGranularity,
        subscribe: 1
      });

      // capturar subscription id do OHLC
      ws.addEventListener('message', function once(e){
        try{
          const d = JSON.parse(e.data);
          if(d.msg_type==='ohlc' && d.subscription && d.subscription.id){
            ohlcSubId = d.subscription.id;
            ws.removeEventListener('message', once);
          }
        }catch(err){}
      });
    }

    // ======== MERCADO ========
    function checkMultipliersAvailability(symbol){
      // Sem product_type para evitar erros de validação em algumas contas/rotas
      send({ contracts_for: symbol });
    }

    function checkTradingTimes(symbol){
      // Consulta horários de trading do dia (para “Fechado/Reabrirá”)
      const todayUTC = new Date().toISOString().slice(0,10);
      send({ trading_times: todayUTC, passthrough: { for_symbol: symbol } });
    }

    function findSymbolTradingInfo(trading_times_payload, symbol){
      const tt = trading_times_payload.trading_times || trading_times_payload;
      const mkts = (tt.markets||[]);
      for(const m of mkts){
        for(const sm of (m.submarkets||[])){
          for(const s of (sm.symbols||[])){
            if(s.symbol === symbol){
              // is_open geralmente vem de website_status/trading_status; nem sempre aqui.
              // Alguns payloads têm "times.open" e "times.close": inferimos próxima abertura.
              const now = Math.floor(Date.now()/1000);
              let is_open = true;
              let next_open_time = null;

              if(s.times && Array.isArray(s.times.open) && Array.isArray(s.times.close)){
                // Se houver pares open/close do dia, inferimos
                is_open = false;
                for(let i=0;i<s.times.open.length;i++){
                  const o = Number(s.times.open[i]);
                  const c = Number(s.times.close[i]);
                  if(now>=o && now<c){ is_open = true; break; }
                  if(now < o){ next_open_time = next_open_time ? Math.min(next_open_time,o) : o; }
                }
              }

              // Alguns símbolos (Synthetic) estão sempre abertos: se não houver times, consideramos abertos
              if(!s.times || (!s.times.open || !s.times.open.length)){
                is_open = true;
              }

              return { is_open, next_open_time };
            }
          }
        }
      }
      return null;
    }
    // =======================================

    // Eventos UI
    document.getElementById('loginBtn').onclick = ()=>{ window.location.href = OAUTH_URL; };
    document.getElementById('logoutBtn').onclick = ()=>{
      cleanupPosition();
      if(ws && ws.readyState===1) ws.close();
      if(balanceSubId){ send({ forget: balanceSubId }); balanceSubId=null; }
      if(tickSubId){ send({ forget: tickSubId }); tickSubId=null; }
      if(ohlcSubId){ send({ forget: ohlcSubId }); ohlcSubId=null; }
      clearTokens();
      selectedToken=null; loginId=null; setAuthUI(false);
      els.accountSelect.innerHTML = '';
      if(candleSeries) candleSeries.setData([]);
    };

    els.useAccountBtn.onclick = ()=>{
      const opt = els.accountSelect.value;
      if(!opt) return;
      const tokens = getStoredTokens();
      const chosen = tokens.find(t=>t.account===opt);
      if(!chosen) return;
      localStorage.setItem('POINT_SELECTED', JSON.stringify(chosen));
      if(ws && ws.readyState===1) authorize(chosen.token, chosen.account, chosen.currency);
      else connectWS();
      setTimeout(()=>{ subscribeBalance(); }, 200);
    };

    els.refreshBalanceBtn.onclick = ()=> send({ balance: 1 });

    els.symbolSelect.onchange = (e)=>{
      const sym = e.target.value;
      currentSymbol = sym;
      const name = e.target.selectedOptions[0]?.textContent || sym;
      els.pd_asset.textContent = name;
      subscribeTicks(sym);
      loadCandles(sym, currentGranularity);
      checkMultipliersAvailability(sym);
      checkTradingTimes(sym);
    };

    els.tfSelect.onchange = (e)=>{
      const gran = Number(e.target.value||60);
      loadCandles(els.symbolSelect.value, gran);
    };

    els.upBtn.onclick = ()=>{ lastUserActionAt=Date.now(); placeMultiplier('up'); };
    els.downBtn.onclick = ()=>{ lastUserActionAt=Date.now(); placeMultiplier('down'); };
    els.closeBtn.onclick = ()=>{
      if(!openContractId) return;
      lastUserActionAt=Date.now();
      send({ sell: openContractId, price: 0 });
    };

    // Inicialização
    extractTokensFromUrl();
    const tokens = getStoredTokens();
    if(tokens.length){
      els.accountSelect.innerHTML = '';
      tokens.forEach(t=>{
        const o=document.createElement('option');
        o.value=t.account; o.textContent=`${t.account} • ${t.currency}`;
        els.accountSelect.appendChild(o);
      });
      els.accountSelect.disabled = false;
      els.useAccountBtn.disabled = false;
      connectWS();
      const first = tokens[0];
      localStorage.setItem('POINT_SELECTED', JSON.stringify(first));
      authorize(first.token, first.account, first.currency);
    } else {
      connectWS();
      initChart();
    }
  </script>
</body>
</html>
