<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POINT — Multipliers (Deriv)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#0b1220;--card:#121a2b;--muted:#9fb0d0;--ok:#22c55e;--warn:#eab308;--err:#ef4444;--ink:#e6edf7;--soft:#1b2740
    }
    body{background:var(--bg);color:var(--ink)}
    .card{background:var(--card);border:1px solid #1e2a46}
    .pill{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08)}
    .btn{transition:transform .05s ease}
    .btn:active{transform:translateY(1px)}
    .glass{backdrop-filter: blur(8px); background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06)}
    .grid-col{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    @media (min-width:1024px){.grid-col-3{grid-template-columns:repeat(3,1fr)}}

    /* === Ajuste solicitado: selects com texto preto ao clicar === */
    select:focus, select:active { color:#000 !important; }
    select option { color:#000; }
  </style>
</head>
<body>
  <header class="sticky top-0 z-50 border-b border-slate-800 bg-[color:var(--soft)]">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-indigo-500/20 flex items-center justify-center">
          <span class="text-indigo-300 font-bold">P</span>
        </div>
        <div>
          <h1 class="text-lg font-semibold tracking-wide">POINT — Multipliers (Deriv)</h1>
          <p class="text-xs text-slate-400">App ID: 98640 • OAuth + WebSocket</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="loginBtn" class="btn px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm">Conectar</button>
        <button id="logoutBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-slate-100 text-sm hidden">Desconectar</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- STATUS / CONTAS -->
    <section class="card rounded-2xl p-4">
      <div class="flex flex-wrap items-center gap-3 justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-emerald-500/15 flex items-center justify-center">
            <span class="text-emerald-300">●</span>
          </div>
          <div>
            <div id="connStatus" class="text-sm text-slate-300">Desconectado</div>
            <div id="loginNote" class="text-xs text-slate-400">
              Clique em <b>Conectar</b> para iniciar o OAuth (será redirecionado e voltará com os tokens).
            </div>
          </div>
        </div>

        <div class="flex flex-col gap-2">
          <div class="flex items-center gap-3">
            <label class="text-sm text-slate-300">Conta:</label>
            <select id="accountSelect" class="pill px-3 py-2 rounded-xl text-sm text-slate-200 bg-transparent" disabled></select>
            <button id="useAccountBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-sm disabled:opacity-50" disabled>Usar conta</button>
          </div>
          <!-- === Formulário de Saldo (por conta selecionada) === -->
          <div class="flex items-center gap-3">
            <label class="text-sm text-slate-300">Saldo:</label>
            <input id="balanceInput" class="pill px-3 py-2 rounded-xl text-sm bg-transparent text-slate-200 w-40 text-right" placeholder="—" disabled />
            <button id="refreshBalanceBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-sm disabled:opacity-50" disabled>Atualizar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- CONTROLES DE MERCADO -->
    <section class="card rounded-2xl p-4">
      <div class="grid gap-4 lg:grid-cols-3">
        <div class="space-y-3">
          <div class="text-xs uppercase tracking-wide text-slate-400">Mercado</div>
          <div class="space-y-2">
            <label class="text-sm text-slate-300">Símbolo (Volatility/Synthetic)</label>
            <select id="symbolSelect" class="pill w-full px-3 py-2 rounded-xl text-sm bg-transparent text-slate-200" disabled>
              <option>— carregando —</option>
            </select>
          </div>
          <div class="grid-col">
            <div>
              <label class="text-sm text-slate-300">Stake</label>
              <input id="stakeInput" type="number" min="1" step="1" value="5" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled />
            </div>
            <div>
              <label class="text-sm text-slate-300">Multiplier</label>
              <select id="multInput" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled>
                <option value="10" selected>x10</option>
                <option value="50">x50</option>
                <option value="100">x100</option>
                <option value="200">x200</option>
                <option value="400">x400</option>
                <option value="800">x800</option>
                <option value="1000">x1000</option>
                <option value="1500">x1500</option>
                <option value="2000">x2000</option>
              </select>
            </div>
          </div>
          <div class="grid-col">
            <div>
              <label class="text-sm text-slate-300">Take Profit (opcional)</label>
              <input id="tpInput" type="number" min="1" step="1" placeholder="ex: 150" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled />
            </div>
            <div>
              <label class="text-sm text-slate-300">Stop Loss (opcional)</label>
              <input id="slInput" type="number" min="1" step="1" placeholder="ex: 130" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled />
            </div>
          </div>
          <div>
            <label class="text-sm text-slate-300">Deal Cancellation</label>
            <select id="dcInput" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled>
              <option value="">Desligado</option>
              <option value="5m">5m</option>
              <option value="10m">10m</option>
              <option value="15m">15m</option>
              <option value="30m">30m</option>
              <option value="60m">60m</option>
            </select>
          </div>
        </div>

        <div class="space-y-3">
          <div class="text-xs uppercase tracking-wide text-slate-400">Ação</div>
          <div class="flex gap-3">
            <button id="upBtn" class="btn flex-1 px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white disabled:opacity-40" disabled>UP (MULTUP)</button>
            <button id="downBtn" class="btn flex-1 px-4 py-3 rounded-xl bg-rose-600 hover:bg-rose-500 text-white disabled:opacity-40" disabled>DOWN (MULTDOWN)</button>
          </div>
          <div class="text-xs text-slate-400">
            Multipliers: perdas limitadas ao <b>stake</b>; podes fechar a qualquer momento; TP/SL e Cancellation suportados. 3
          </div>
        </div>

        <div class="space-y-3">
          <div class="text-xs uppercase tracking-wide text-slate-400">Preço (tempo real)</div>
          <div class="glass rounded-xl p-4">
            <div id="tickSymbol" class="text-sm text-slate-400">—</div>
            <div class="text-3xl font-semibold mt-1" id="tickPrice">—</div>
            <div class="mt-3 text-xs text-slate-400" id="tickNote">Assina ticks ao escolher o símbolo.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- POSIÇÃO ATIVA -->
    <section class="card rounded-2xl p-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-xs uppercase tracking-wide text-slate-400">Posição</div>
          <div id="posStatus" class="text-sm">Nenhuma posição aberta.</div>
        </div>
        <div class="flex items-center gap-3">
          <div class="text-sm">P/L: <span id="plVal" class="font-semibold text-slate-200">—</span></div>
          <button id="closeBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-sm hidden">Fechar posição</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ================== CONFIG ==================
    const APP_ID = 98640; // POINT
    const WS_URL = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;
    const OAUTH_URL = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}`; // redireciona e retorna com tokens
    // ============================================

    // Estado global simples
    let ws = null;
    let authorized = false;
    let selectedToken = null;
    let loginId = null;
    let currency = 'USD';
    let tickSubId = null;
    let openContractId = null;
    let pocSubId = null;
    let balanceSubId = null;

    const els = {
      loginBtn: document.getElementById('loginBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      connStatus: document.getElementById('connStatus'),
      loginNote: document.getElementById('loginNote'),
      accountSelect: document.getElementById('accountSelect'),
      useAccountBtn: document.getElementById('useAccountBtn'),
      symbolSelect: document.getElementById('symbolSelect'),
      stakeInput: document.getElementById('stakeInput'),
      multInput: document.getElementById('multInput'),
      tpInput: document.getElementById('tpInput'),
      slInput: document.getElementById('slInput'),
      dcInput: document.getElementById('dcInput'),
      upBtn: document.getElementById('upBtn'),
      downBtn: document.getElementById('downBtn'),
      tickSymbol: document.getElementById('tickSymbol'),
      tickPrice: document.getElementById('tickPrice'),
      tickNote: document.getElementById('tickNote'),
      posStatus: document.getElementById('posStatus'),
      plVal: document.getElementById('plVal'),
      closeBtn: document.getElementById('closeBtn'),
      balanceInput: document.getElementById('balanceInput'),
      refreshBalanceBtn: document.getElementById('refreshBalanceBtn'),
    };

    // ------------- Helpers UI -------------
    function setConnectedUI(on){
      els.connStatus.textContent = on ? 'Conectado (WebSocket ativo)' : 'Desconectado';
    }
    function setAuthUI(on){
      authorized = !!on;
      const dis = !on;
      [els.accountSelect, els.useAccountBtn, els.symbolSelect, els.stakeInput, els.multInput, els.tpInput, els.slInput, els.dcInput, els.upBtn, els.downBtn, els.refreshBalanceBtn].forEach(el=>{
        el.disabled = dis;
      });
      els.logoutBtn.classList.toggle('hidden', !on);
      els.loginBtn.classList.toggle('hidden', on);
      els.loginNote.textContent = on
        ? 'Autorizado. Escolhe a conta e o símbolo para negociar.'
        : 'Clique em Conectar para iniciar o OAuth.';
      if(dis){ els.balanceInput.value = ''; els.balanceInput.placeholder = '—'; }
    }
    function toast(msg,isErr=false){
      console[isErr?'error':'log'](msg);
    }

    // ------------- OAuth: captura tokens do redirect -------------
    // Exemplo de retorno: .../redirect/?acct1=crxxxx&token1=aaaa&cur1=usd&acct2=vrtc...&token2=bbbb&cur2=usd
    function extractTokensFromUrl(){
      const q = new URLSearchParams(location.search);
      const tokens = [];
      for (let i=1;i<=10;i++){
        const acct = q.get(`acct${i}`), token = q.get(`token${i}`), cur = q.get(`cur${i}`);
        if(acct && token){
          tokens.push({account:acct.toUpperCase(), token, currency:(cur||'USD').toUpperCase()});
        }
      }
      if(tokens.length){
        localStorage.setItem('POINT_TOKENS', JSON.stringify(tokens));
        // remove params da barra
        history.replaceState({}, document.title, location.pathname);
      }
    }
    function getStoredTokens(){
      try { return JSON.parse(localStorage.getItem('POINT_TOKENS')||'[]'); } catch(e){ return []; }
    }
    function clearTokens(){
      localStorage.removeItem('POINT_TOKENS');
      localStorage.removeItem('POINT_SELECTED');
    }

    // ------------- WebSocket Core -------------
    function connectWS(){
      if(ws && ws.readyState===1) return;
      ws = new WebSocket(WS_URL);
      ws.onopen = ()=>{
        setConnectedUI(true);
        // se já tínhamos uma conta escolhida, reautoriza
        const remembered = JSON.parse(localStorage.getItem('POINT_SELECTED')||'null');
        const tokens = getStoredTokens();
        if(remembered && tokens.length){
          const match = tokens.find(t=>t.account===remembered.account);
          if(match) authorize(match.token, match.account, match.currency);
        }
      };
      ws.onclose = ()=>{
        setConnectedUI(false);
        setAuthUI(false);
      };
      ws.onmessage = handleMessage;
      ws.onerror = (e)=>toast('WebSocket error', true);
    }

    function send(msg){
      if(!ws || ws.readyState!==1){ toast('WS não conectado', true); return; }
      ws.send(JSON.stringify(msg));
    }

    function handleMessage(evt){
      const data = JSON.parse(evt.data);

      if(data.error){
        toast(data.error.message, true);
        return;
      }

      // authorize
      if(data.msg_type==='authorize'){
        loginId = data.authorize.loginid;
        currency = data.authorize.currency || 'USD';
        setAuthUI(true);
        loadActiveSymbols();
        els.posStatus.textContent = 'Nenhuma posição aberta.';
        subscribeBalance(); // saldo ao autorizar
      }

      // active_symbols -> popula select
      if(data.msg_type==='active_symbols'){
        const syms = (data.active_symbols||[])
          .filter(s=>s.market==='synthetic_index' || s.symbol.includes('R_') || s.symbol.includes('VOL') || s.market==='cryptocurrency')
          .map(s=>({symbol:s.symbol, display:`${s.display_name} (${s.symbol})`}));
        els.symbolSelect.innerHTML = '';
        syms.forEach(s=>{
          const o=document.createElement('option');
          o.value = s.symbol; o.textContent = s.display;
          els.symbolSelect.appendChild(o);
        });
        // auto-subscribe first
        if(syms[0]) subscribeTicks(syms[0].symbol);
      }

      // ticks (formatação pedida: remover 2 zeros finais)
      if(data.msg_type==='tick'){
        const q = Number(data.tick.quote);
        let s = q.toFixed(5);
        if(s.endsWith('00')) s = s.slice(0,-2); // remove sempre dois zeros finais, se existirem
        els.tickPrice.textContent = s;
      }

      // proposal -> buy
      if(data.msg_type==='proposal'){
        if(data.proposal && data.proposal.id){
          const id = data.proposal.id;
          const ask = Number(data.proposal.ask_price);
          // Garantia: enviar buy com preço do proposal
          send({ buy: id, price: ask });
        }
      }

      // buy -> contrato aberto
      if(data.msg_type==='buy'){
        if(data.buy && data.buy.contract_id){
          openContractId = data.buy.contract_id;
          els.posStatus.textContent = `Contrato #${openContractId} aberto. A acompanhar...`;
          els.closeBtn.classList.remove('hidden');
          subscribeOpenContract(openContractId);
        }
      }

      // acompanhar contrato
      if(data.msg_type==='proposal_open_contract'){
        const poc = data.proposal_open_contract;
        if(!poc) return;
        if(poc.contract_id) openContractId = poc.contract_id;
        const pl = (poc.profit || 0);
        els.plVal.textContent = `${pl.toFixed(2)} ${currency}`;
        if(poc.is_sold){
          els.posStatus.textContent = `Contrato fechado. Resultado: ${pl.toFixed(2)} ${currency}`;
          cleanupPosition();
        }
      }

      // sell enviado
      if(data.msg_type==='sell'){
        toast('Solicitado fechar posição.');
      }

      // balance (atualiza campo)
      if(data.msg_type==='balance'){
        if(data.balance && typeof data.balance.balance !== 'undefined'){
          const bal = Number(data.balance.balance);
          els.balanceInput.value = `${bal.toFixed(2)} ${data.balance.currency || currency}`;
        }
        // captura subscription id
        if(data.subscription && data.subscription.id && !balanceSubId){
          balanceSubId = data.subscription.id;
        }
      }

      if(data.msg_type==='forget'){ /* ok */ }
    }

    // ------------- Fluxos API -------------
    function authorize(token, acct, cur){
      selectedToken = token;
      currency = (cur||'USD').toUpperCase();
      send({ authorize: token, passthrough:{acct} });
    }

    function loadActiveSymbols(){
      send({ active_symbols: 'brief', product_type: 'basic' });
    }

    function subscribeTicks(symbol){
      if(tickSubId){ send({ forget: tickSubId }); tickSubId=null; }
      els.tickSymbol.textContent = symbol;
      els.tickNote.textContent = 'Recebendo ticks...';
      send({ ticks: symbol, subscribe: 1 });
      ws.addEventListener('message', function once(e){
        const d = JSON.parse(e.data);
        if(d.msg_type==='tick' && d.tick && d.subscription && d.subscription.id){
          tickSubId = d.subscription.id;
          ws.removeEventListener('message', once);
        }
      });
    }

    function subscribeOpenContract(contract_id){
      if(pocSubId){ send({ forget: pocSubId }); pocSubId=null; }
      send({ proposal_open_contract: 1, contract_id, subscribe: 1 });
      ws.addEventListener('message', function once(e){
        const d = JSON.parse(e.data);
        if(d.msg_type==='proposal_open_contract' && d.subscription && d.subscription.id){
          pocSubId = d.subscription.id;
          ws.removeEventListener('message', once);
        }
      });
    }

    function subscribeBalance(){
      if(balanceSubId){ send({ forget: balanceSubId }); balanceSubId = null; }
      send({ balance: 1, subscribe: 1 });
      els.refreshBalanceBtn.disabled = false;
    }

    function requestBalanceOnce(){
      send({ balance: 1 });
    }

    function cleanupPosition(){
      openContractId = null;
      if(pocSubId){ send({ forget: pocSubId }); pocSubId=null; }
      els.closeBtn.classList.add('hidden');
      els.plVal.textContent = '—';
    }

    function placeMultiplier(direction){
      if(!authorized) return toast('Autorize primeiro', true);
      const symbol = els.symbolSelect.value;
      const amount = Number(els.stakeInput.value||0);
      const multiplier = Number(els.multInput.value||10); // x10 padrão
      if(!symbol || !amount){ els.posStatus.textContent='Preencha símbolo e stake'; return; }

      // limit_order opcional
      const limit_order = {};
      const tp = Number(els.tpInput.value||0);
      const sl = Number(els.slInput.value||0);
      if(tp>0) limit_order.take_profit = tp;
      if(sl>0) limit_order.stop_loss = sl;

      const req = {
        proposal: 1,
        amount,
        basis: 'stake',
        contract_type: direction==='up' ? 'MULTUP' : 'MULTDOWN',
        currency,
        symbol,
        multiplier
      };
      if(Object.keys(limit_order).length) req.limit_order = limit_order;
      const dc = els.dcInput.value;
      if(dc) req.cancellation = dc;

      els.posStatus.textContent = 'Enviando proposal...';
      send(req);
    }

    // ------------- Eventos UI -------------
    els.loginBtn.onclick = ()=>{ window.location.href = OAUTH_URL; };
    els.logoutBtn.onclick = ()=>{
      cleanupPosition();
      if(ws && ws.readyState===1) ws.close();
      if(balanceSubId){ send({ forget: balanceSubId }); balanceSubId=null; }
      if(tickSubId){ send({ forget: tickSubId }); tickSubId=null; }
      clearTokens();
      selectedToken=null; loginId=null; setAuthUI(false);
      els.accountSelect.innerHTML = '';
      toast('Sessão limpa.');
    };

    els.useAccountBtn.onclick = ()=>{
      const opt = els.accountSelect.value;
      if(!opt) return;
      const tokens = getStoredTokens();
      const chosen = tokens.find(t=>t.account===opt);
      if(!chosen) return;
      localStorage.setItem('POINT_SELECTED', JSON.stringify(chosen));
      if(ws && ws.readyState===1) authorize(chosen.token, chosen.account, chosen.currency);
      else connectWS();
      // Atualiza saldo para a conta escolhida
      setTimeout(()=>{ subscribeBalance(); }, 200);
    };

    els.refreshBalanceBtn.onclick = ()=> requestBalanceOnce();

    els.symbolSelect.onchange = (e)=> subscribeTicks(e.target.value);
    els.upBtn.onclick = ()=>placeMultiplier('up');
    els.downBtn.onclick = ()=>placeMultiplier('down');
    els.closeBtn.onclick = ()=>{
      if(!openContractId) return;
      send({ sell: openContractId, price: 0 });
    };

    // ------------- Inicialização -------------
    extractTokensFromUrl();
    const tokens = getStoredTokens();
    if(tokens.length){
      // popular seletor de contas
      els.accountSelect.innerHTML = '';
      tokens.forEach(t=>{
        const o=document.createElement('option');
        o.value=t.account; o.textContent=`${t.account} • ${t.currency}`;
        els.accountSelect.appendChild(o);
      });
      els.accountSelect.disabled = false;
      els.useAccountBtn.disabled = false;
      // conectar WS e autorizar na primeira conta por padrão
      connectWS();
      const first = tokens[0];
      localStorage.setItem('POINT_SELECTED', JSON.stringify(first));
      authorize(first.token, first.account, first.currency);
    } else {
      // ainda sem OAuth -> conecta WS só para status
      connectWS();
    }
  </script>
</body>
</html>
