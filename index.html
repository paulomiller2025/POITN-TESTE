<!DOCTYPE html> 
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POINT — Multipliers (Deriv)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root{ --bg:#0b1220; --card:#121a2b; --muted:#9fb0d0; --ok:#22c55e; --warn:#eab308; --err:#ef4444; --ink:#e6edf7; --soft:#1b2740 }
    body{ background:var(--bg); color:var(--ink) }
    .card{ background:var(--card); border:1px solid #1e2a46 }
    .pill{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08) }
    .btn{ transition:transform .05s ease }
    .btn:active{ transform:translateY(1px) }
    .glass{ backdrop-filter: blur(8px); background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06) }
    .grid-col{ display:grid; grid-template-columns:1fr 1fr; gap:.75rem }
    .layout{ display:grid; grid-template-columns:260px 1fr 300px; gap:12px }
    @media (max-width:1024px){ .layout{ grid-template-columns:1fr } }
    select:focus,select:active{ color:#000 !important } select option{ color:#000 }
    #chartWrap{ height:480px; transition:height .2s ease } @media (max-width:1024px){ #chartWrap{ height:420px } }
    .pl-green{ color:#22c55e !important } .pl-red{ color:#ef4444 !important }

    /* Painel Robô IA (drawer) */
    #aiPanel{
      position:fixed; right:16px; top:88px; bottom:16px; width:360px; max-width:92vw;
      transform: translateX(120%); transition: transform .25s ease; z-index:60;
    }
    #aiPanel.open{ transform: translateX(0); }

    /* Separador fino */
    .sep{ height:1px; background:#1e2a46; margin-top:.75rem; margin-bottom:.75rem; }

    /* Dropdown do menu */
    .menu-card{ background:var(--card); border:1px solid #1e2a46; box-shadow:0 12px 30px rgba(0,0,0,.35) }
    .tab-btn{ padding:.4rem .7rem; border-radius:.6rem; font-size:.85rem }
    .tab-btn.active{ background:#1b2740; color:#e6edf7; border:1px solid #2a395d }
  </style>
</head>
<body>
  <header class="sticky top-0 z-50 border-b border-slate-800 bg-[color:var(--soft)]">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-indigo-500/20 flex items-center justify-center"><span class="text-indigo-300 font-bold">P</span></div>
        <div>
          <h1 class="text-lg font-semibold tracking-wide">POINT — Multipliers (Deriv)</h1>
          <p class="text-xs text-slate-400">App ID: 98640 • OAuth + WebSocket</p>
        </div>
      </div>
      <div class="flex items-center gap-2 relative">
        <button id="loginBtn" class="btn px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm">Conectar</button>
        <button id="logoutBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-slate-100 text-sm hidden">Desconectar</button>

        <!-- Botão de afiliado -->
        <a href="https://track.deriv.com/_IbwR-HIUYbJ8zg8lBvFoLmNd7ZgqdRLk/1/" target="_blank" rel="noopener"
           class="btn px-4 py-2 rounded-xl bg-red-600 hover:bg-red-500 text-white text-sm">Cadastre-se na Corretora Deriv</a>

        <!-- MENU à direita do botão de cadastro -->
        <div class="relative">
          <button id="menuBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-slate-100 text-sm">Menu ▾</button>
          <div id="menuDropdown" class="hidden absolute right-0 mt-2 w-[560px] rounded-xl p-3 menu-card">
            <!-- Abas -->
            <div class="flex gap-2 mb-3">
              <button data-tab="treinamento" class="tab-btn active">Treinamento</button>
              <button data-tab="termos" class="tab-btn">Termos e Condições</button>
              <button data-tab="download" class="tab-btn">Download</button>
            </div>
            <!-- Conteúdos -->
            <div id="tab-treinamento" class="space-y-3">
              <div class="text-sm text-slate-300">Cole o link do YouTube e clique em <b>Adicionar</b>. Selecione na lista para tocar.</div>
              <div class="flex gap-2">
                <input id="ytUrlInput" class="pill flex-1 px-3 py-2 rounded-xl text-sm bg-transparent text-slate-200" placeholder="https://www.youtube.com/watch?v=..." />
                <button id="ytAddBtn" class="btn px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm">Adicionar</button>
              </div>
              <div class="grid grid-cols-3 gap-3">
                <div class="col-span-2">
                  <div class="aspect-video glass rounded-xl overflow-hidden">
                    <iframe id="ytPlayer" class="w-full h-full" src="" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
                  </div>
                </div>
                <div class="col-span-1">
                  <div id="ytList" class="glass rounded-xl p-2 max-h-56 overflow-auto text-sm space-y-1">
                    <!-- itens inseridos via JS -->
                  </div>
                </div>
              </div>
            </div>

            <div id="tab-termos" class="hidden space-y-2">
              <div class="text-sm text-slate-300">Insira abaixo os termos e condições da plataforma:</div>
              <div id="termsArea" contenteditable="true" class="glass rounded-xl p-3 text-sm min-h-[220px] leading-6 outline-none">
                <p><i>Coloque aqui seu texto longo de Termos e Condições...</i></p>
              </div>
            </div>

            <div id="tab-download" class="hidden space-y-3">
              <div class="text-sm text-slate-300">Arquivos para download:</div>
              <div class="grid grid-cols-2 gap-2">
                <!-- sete botões de download (placeholders) -->
                <a class="btn px-3 py-2 rounded-xl bg-emerald-700 hover:bg-emerald-600 text-white text-sm text-center" href="#" download>Arquivo 1</a>
                <a class="btn px-3 py-2 rounded-xl bg-emerald-700 hover:bg-emerald-600 text-white text-sm text-center" href="#" download>Arquivo 2</a>
                <a class="btn px-3 py-2 rounded-xl bg-emerald-700 hover:bg-emerald-600 text-white text-sm text-center" href="#" download>Arquivo 3</a>
                <a class="btn px-3 py-2 rounded-xl bg-emerald-700 hover:bg-emerald-600 text-white text-sm text-center" href="#" download>Arquivo 4</a>
                <a class="btn px-3 py-2 rounded-xl bg-emerald-700 hover:bg-emerald-600 text-white text-sm text-center" href="#" download>Arquivo 5</a>
                <a class="btn px-3 py-2 rounded-xl bg-emerald-700 hover:bg-emerald-600 text-white text-sm text-center" href="#" download>Arquivo 6</a>
                <a class="btn px-3 py-2 rounded-xl bg-emerald-700 hover:bg-emerald-600 text-white text-sm text-center col-span-2" href="#" download>Arquivo 7</a>
              </div>
            </div>
          </div>
        </div>
        <!-- /MENU -->
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-4">
    <!-- STATUS -->
    <section class="card rounded-2xl p-4">
      <div class="flex flex-wrap items-center gap-3 justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-emerald-500/15 flex items-center justify-center"><span class="text-emerald-300">●</span></div>
          <div>
            <div id="connStatus" class="text-sm text-slate-300">Desconectado</div>
            <div id="loginNote" class="text-xs text-slate-400">Clique em <b>Conectar</b> para iniciar o OAuth.</div>
          </div>
        </div>
        <div class="flex flex-col gap-2">
          <div class="flex items-center gap-3">
            <label class="text-sm text-slate-300">Conta:</label>
            <select id="accountSelect" class="pill px-3 py-2 rounded-xl text-sm text-slate-200 bg-transparent" disabled></select>
          </div>
          <div class="flex items-center gap-3">
            <label class="text-sm text-slate-300">Saldo:</label>
            <input id="balanceInput" class="pill px-3 py-2 rounded-xl text-sm bg-transparent text-slate-200 w-40 text-right" placeholder="—" disabled />
          </div>
        </div>
      </div>
    </section>

    <!-- LAYOUT -->
    <div class="layout">
      <!-- ESQUERDA: POSIÇÕES -->
      <section class="card rounded-2xl p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-xs uppercase tracking-wide text-slate-400">Posição</div>
          <button id="resetBtn" class="btn px-2 py-1 rounded-lg bg-slate-700 hover:bg-slate-600 text-xs">Reset histórico</button>
        </div>
        <div id="posStatus" class="text-sm">Nenhuma posição aberta.</div>
        <div id="positionsList" class="space-y-3 mt-3 max-h-[520px] overflow-auto pr-2"></div>
      </section>

      <!-- CENTRO: GRÁFICO -->
      <section class="card rounded-2xl p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-xs uppercase tracking-wide text-slate-400">Gráfico de Tendências (Velas)</div>
          <div class="flex items-center gap-2">
            <label for="tfSelect" class="text-xs text-slate-400">Timeframe</label>
            <select id="tfSelect" class="pill px-2 py-1 rounded-lg text-sm bg-transparent text-slate-200" disabled>
              <option value="60" selected>1m</option>
              <option value="120">2m</option>
              <option value="180">3m</option>
              <option value="300">5m</option>
              <option value="600">10m</option>
              <option value="900">15m</option>
              <option value="1800">30m</option>
              <option value="3600">1h</option>
              <option value="7200">2h</option>
              <option value="14400">4h</option>
              <option value="28800">8h</option>
              <option value="86400">1d</option>
            </select>
          </div>
        </div>
        <div id="chartWrap" class="glass rounded-xl"></div>
        <!-- Preço em tempo real (oculto) -->
        <div class="glass rounded-xl p-4 mt-3 hidden">
          <div id="tickSymbol" class="text-sm text-slate-400">—</div>
          <div class="text-3xl font-semibold mt-1" id="tickPrice">—</div>
          <div class="mt-3 text-xs text-slate-400" id="tickNote">Assina ticks ao escolher o símbolo.</div>
        </div>
      </section>

      <!-- DIREITA: MERCADO + AÇÃO -->
      <div class="flex flex-col gap-3">
        <section class="card rounded-2xl p-4">
          <div class="text-xs uppercase tracking-wide text-slate-400 mb-3">Mercado</div>
          <div class="space-y-3">
            <div>
              <label class="text-sm text-slate-300">Símbolo</label>
              <div class="flex items-center gap-2">
                <select id="symbolSelect" class="pill w-full px-3 py-2 rounded-xl text-sm bg-transparent text-slate-200" disabled>
                  <option>— carregando —</option>
                </select>
                <span id="multBadge" class="px-2 py-1 rounded-lg text-xs border hidden"></span>
              </div>
            </div>
            <div class="grid-col">
              <div>
                <label class="text-sm text-slate-300">Stake</label>
                <input id="stakeInput" type="number" min="1" step="1" value="10" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled />
              </div>
              <div>
                <label class="text-sm text-slate-300">Multiplier</label>
                <select id="multInput" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled></select>
              </div>
            </div>
            <div class="grid-col">
              <div>
                <label class="text-sm text-slate-300">Take Profit (opcional)</label>
                <input id="tpInput" type="number" min="1" step="1" placeholder="ex: 150" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled />
              </div>
              <div>
                <label class="text-sm text-slate-300">Stop Loss (opcional)</label>
                <input id="slInput" type="number" min="1" step="1" placeholder="ex: 130" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled />
              </div>
            </div>
          </div>
        </section>

        <section class="card rounded-2xl p-4">
          <div class="text-xs uppercase tracking-wide text-slate-400 mb-3">Ação</div>
          <div class="flex gap-3">
            <button id="upBtn" class="btn flex-1 px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white disabled:opacity-40" disabled>UP (MULTUP)</button>
            <button id="downBtn" class="btn flex-1 px-4 py-3 rounded-xl bg-rose-600 hover:bg-rose-500 text-white disabled:opacity-40" disabled>DOWN (MULTDOWN)</button>
          </div>

          <div class="sep"></div>

          <!-- NOVOS BOTÕES IA (abaixo dos UP/DOWN) -->
          <div class="flex gap-3">
            <button id="aiOpenBtn" class="btn flex-1 px-4 py-3 rounded-xl bg-sky-700 hover:bg-sky-600 text-white disabled:opacity-40" disabled>
              <span class="inline-flex items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2v3M7 22h10M4 19V9a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v10" stroke="#fff" stroke-width="1.5"/><rect x="6" y="11" width="4" height="4" rx="1" stroke="#fff" stroke-width="1.5"/><rect x="14" y="11" width="4" height="4" rx="1" stroke="#fff" stroke-width="1.5"/></svg>
                Robô IA
              </span>
            </button>
            <button id="aiAutoBtn" class="btn flex-1 px-4 py-3 rounded-xl bg-purple-700 hover:bg-purple-600 text-white disabled:opacity-40" disabled>IA (Auto)</button>
          </div>

          <div class="text-xs text-slate-400 mt-2">
            Multipliers: perdas limitadas ao <b>stake</b>; podes fechar a qualquer momento; TP/SL suportados.
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Painel Robô IA -->
  <div id="aiPanel" class="card rounded-2xl p-4 shadow-xl">
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-2">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 2v3M7 22h10M4 19V9a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v10" stroke="#9fb0d0" stroke-width="1.5"/><rect x="6" y="11" width="4" height="4" rx="1" stroke="#9fb0d0" stroke-width="1.5"/><rect x="14" y="11" width="4" height="4" rx="1" stroke="#9fb0d0" stroke-width="1.5"/></svg>
        <div class="text-sm font-semibold">Robô IA — Probabilidades</div>
      </div>
      <button id="aiCloseBtn" class="btn px-2 py-1 rounded-lg bg-slate-700 hover:bg-slate-600 text-xs">Fechar</button>
    </div>

    <div class="glass rounded-xl p-3 mb-3">
      <div class="flex items-baseline justify-between">
        <div class="text-xs text-slate-400">Sinal recomendado</div>
        <div id="aiUpdatedAt" class="text-[10px] text-slate-500">—</div>
      </div>
      <div class="mt-1 flex items-center justify-between">
        <div id="aiSignal" class="text-lg font-semibold">—</div>
        <div id="aiConfidence" class="text-sm text-slate-300">Confiança: —%</div>
      </div>
      <div class="mt-1 text-xs text-slate-400">Permanência sugerida</div>
      <div id="aiHold" class="text-sm">—</div>
      <div class="mt-2 text-xs text-slate-400">Resumo</div>
      <div id="aiSummary" class="text-sm">—</div>
      <button id="aiExecuteBtn" class="btn mt-3 w-full px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white text-sm">Executar sinal agora</button>
    </div>

    <div class="space-y-2">
      <div class="text-xs uppercase tracking-wide text-slate-400">Indicadores</div>
      <div id="aiIndicators" class="grid grid-cols-2 gap-2 text-sm"></div>
      <div class="text-[11px] text-slate-500 mt-2">Nota: ferramenta experimental. Utilize gestão de risco.</div>
    </div>
  </div>

  <!-- Botão WhatsApp (próximo do rodapé) -->
  <a href="https://wa.me/SEUNUMERO" target="_blank" rel="noopener"
     class="fixed bottom-5 right-5 z-50 inline-flex items-center gap-2 px-4 py-3 rounded-full bg-green-600 hover:bg-green-500 text-white shadow-lg">
    <svg width="22" height="22" viewBox="0 0 32 32" fill="none" aria-hidden="true">
      <path d="M19.6 17.4c-.3-.2-1.7-.9-2-.9s-.5.1-.7.4-.8.9-.9 1-.3.1-.6 0a9.5 9.5 0 0 1-2.8-1.7 10 10 0 0 1-1.9-2.4c-.2-.4 0-.5.1-.6l.3-.3c.1-.1.1-.2.2-.3s.1-.2.2-.3a.6.6 0 0 0 0-.6c0-.2-.7-1.8-.9-2.1s-.5-.5-.7-.5h-.6c-.2 0-.5.1-.7.4s-1 1-1 2.4 1 2.8 1.2 3 .2.4.5.8a11.5 11.5 0 0 0 4.1 3.8 13 13 0 0 0 2.6 1 .7.7 0 0 0 .7-.1c.2-.2.8-.9 1-1.2s.4-.3.7-.2 1.7.8 2 .9.5.1.7 0l.5-.2c.2-.1.5-.2.6-.3s.2-.2.2-.3-.1-.3-.3-.4Z" fill="#fff"/>
      <path d="M27.6 4.4A14.7 14.7 0 0 0 3.7 24.2L2 30l6-1.6a14.7 14.7 0 0 0 19.6-24Zm-3 18.6A10.6 10.6 0 1 1 26.6 10a10.6 10.6 0 0 1-2 13Z" fill="#fff"/>
    </svg>
    WhatsApp
  </a>

  <script>
    // ========= CONFIG =========
    const APP_ID  = 98640;
    const WS_URL  = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;
    const OAUTH_URL = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}`;

    const ALL_MULTS = [10,15,20,40,50,80,100,150,200,250,300,350,400,450,500,700,800,1000,1300,1500,1600,2000,2500,3200];
    const DEFAULT_SYMBOL_REGEX = /Volatility 100 \(1s\)/i;

    // ========= ESTADO =========
    let ws=null, authorized=false, loginId=null, currency='USD';
    let tickSubId=null, ohlcSubId=null, balanceSubId=null;
    let lwChart=null, candleSeries=null, currentSymbol=null, currentGranularity=60, liveBar=null;

    let activeTicksSymbol = null;
    let activeOHLCKey = null;

    const positions = new Map();
    const allowedBySymbol = new Map();
    let currentAllowedMultipliers = [];

    const barsCache = new Map();

    // ÁUDIO (cash ao lucrar)
    let audioCtx = null;
    function playCash(){ try{
      if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const t = audioCtx.currentTime + 0.01;
      const g = audioCtx.createGain();
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.25, t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t+0.35);
      g.connect(audioCtx.destination);
      const o1 = audioCtx.createOscillator(); o1.type='triangle'; o1.frequency.setValueAtTime(1320, t); o1.frequency.exponentialRampToValueAtTime(880, t+0.3); o1.connect(g); o1.start(t); o1.stop(t+0.35);
      const o2 = audioCtx.createOscillator(); o2.type='square';   o2.frequency.setValueAtTime(1980, t); o2.frequency.exponentialRampToValueAtTime(990, t+0.25); o2.connect(g); o2.start(t); o2.stop(t+0.3);
    }catch(e){} }

    // ========= DOM =========
    const els = {
      loginBtn:document.getElementById('loginBtn'), logoutBtn:document.getElementById('logoutBtn'),
      connStatus:document.getElementById('connStatus'), loginNote:document.getElementById('loginNote'),
      accountSelect:document.getElementById('accountSelect'),
      symbolSelect:document.getElementById('symbolSelect'), stakeInput:document.getElementById('stakeInput'),
      multInput:document.getElementById('multInput'), tpInput:document.getElementById('tpInput'), slInput:document.getElementById('slInput'),
      upBtn:document.getElementById('upBtn'), downBtn:document.getElementById('downBtn'),
      tickSymbol:document.getElementById('tickSymbol'), tickPrice:document.getElementById('tickPrice'), tickNote:document.getElementById('tickNote'),
      balanceInput:document.getElementById('balanceInput'),
      tfSelect:document.getElementById('tfSelect'), chartWrap:document.getElementById('chartWrap'), multBadge:document.getElementById('multBadge'),
      posStatus:document.getElementById('posStatus'), positionsList:document.getElementById('positionsList'), resetBtn:document.getElementById('resetBtn'),

      // IA
      aiOpenBtn:document.getElementById('aiOpenBtn'), aiAutoBtn:document.getElementById('aiAutoBtn'),
      aiPanel:document.getElementById('aiPanel'), aiCloseBtn:document.getElementById('aiCloseBtn'),
      aiSignal:document.getElementById('aiSignal'), aiConfidence:document.getElementById('aiConfidence'),
      aiIndicators:document.getElementById('aiIndicators'), aiUpdatedAt:document.getElementById('aiUpdatedAt'),
      aiExecuteBtn:document.getElementById('aiExecuteBtn'),
      aiHold:document.getElementById('aiHold'), aiSummary:document.getElementById('aiSummary'),

      // Menu
      menuBtn:document.getElementById('menuBtn'),
      menuDropdown:document.getElementById('menuDropdown'),
      ytUrlInput:document.getElementById('ytUrlInput'),
      ytAddBtn:document.getElementById('ytAddBtn'),
      ytList:document.getElementById('ytList'),
      ytPlayer:document.getElementById('ytPlayer'),
    };

    // ========= UI helpers =========
    function setConnectedUI(on){ els.connStatus.textContent = on ? 'Conectado (WebSocket ativo)' : 'Desconectado'; }
    function setAuthUI(on){
      authorized=!!on; const dis=!on;
      [els.accountSelect,els.symbolSelect,els.stakeInput,els.multInput,els.tpInput,els.slInput,els.upBtn,els.downBtn,els.tfSelect,els.aiOpenBtn,els.aiAutoBtn]
        .forEach(el=>{ el.disabled=dis; });
      els.logoutBtn.classList.toggle('hidden',!on); els.loginBtn.classList.toggle('hidden',on);
      els.loginNote.textContent = on ? 'Autorizado. Escolhe a conta e o símbolo para negociar.' : 'Clique em Conectar para iniciar o OAuth.';
      if(dis){ els.balanceInput.value=''; els.balanceInput.placeholder='—'; }
    }

    // Mensagens PT com prefixo “Caro Trader:”
    function translateError(msg){
      let m=String(msg||'');
      m = m.replace(/Your account balance \(([^)]+)\) is insufficient to buy this contract \(([^)]+)\)\./i, 'Saldo da sua conta ($1) é insuficiente para comprar este contrato ($2).');
      m = m.replace(/Input validation failed:? ?(.+)?/i,'Validação de entrada falhou.');
      m = m.replace(/Market is closed/i,'O mercado está fechado');
      m = m.replace(/Insufficient balance/i,'Saldo insuficiente');
      m = m.replace(/Unrecognised request|Unrecognized request/i,'Pedido não reconhecido');
      m = m.replace(/You are already subscribed to ([A-Za-z0-9_\.]+)/i,'Já existe uma subscrição ativa para $1.');
      m = m.replace(/Already subscribed/i,'Já existe uma subscrição ativa.');
      m = m.replace(/Multiplier is not in acceptable range\. Accepts (.+)$/i,'O multiplicador selecionado não é aceite. Aceites: $1');
      return m;
    }
    function showTraderMessage(text){
      els.posStatus.innerHTML = `<span class="text-emerald-400">Caro Trader:</span> <span class="text-slate-200">${text}</span>`;
    }
    function toast(msg,isErr=false){
      const raw = String(msg||'');
      if(isErr && /Accepts/i.test(raw)){
        const after = raw.split('Accepts')[1]?.replace(':','').trim() || '';
        const values = after.split(',').map(x=>Number(x.trim())).filter(Number.isFinite).sort((a,b)=>a-b);
        if(values.length){
          allowedBySymbol.set(currentSymbol, values.slice());
          currentAllowedMultipliers = values.slice();
          updateMultiplierHighlights();
          const list = values.map(v=>'x'+v).join(', ');
          showTraderMessage(`O multiplicador selecionado não é suportado para este mercado. Suportados: ${list}.`);
        } else {
          showTraderMessage(translateError(raw));
        }
        return;
      }
      if(isErr){
        if(/WS não conectado/i.test(raw)){ els.posStatus.textContent = 'Sistema não conectado'; return; }
        showTraderMessage(translateError(raw));
      }else{
        els.posStatus.textContent = raw;
      }
    }

    function setBadge(available){
      const b=els.multBadge; if(!b) return;
      b.classList.remove('hidden');
      b.textContent = available ? 'Multipliers: disponível' : 'Multipliers: indisponível';
      b.className = available
        ? 'px-2 py-1 rounded-lg text-xs border bg-emerald-500/10 text-emerald-300 border-emerald-500/30'
        : 'px-2 py-1 rounded-lg text-xs border bg-rose-500/10 text-rose-300 border-rose-500/30';
    }

    function renderAllMultipliers(){
      els.multInput.innerHTML='';
      ALL_MULTS.forEach(v=>{
        const o=document.createElement('option');
        o.value=String(v); o.textContent='x'+v;
        els.multInput.appendChild(o);
      });
      els.multInput.disabled=false;
      updateMultiplierHighlights();
    }
    function updateMultiplierHighlights(){
      const allowed = allowedBySymbol.get(currentSymbol) || currentAllowedMultipliers || [];
      const allowedSet = new Set(allowed);
      Array.from(els.multInput.options).forEach(opt=>{
        const n = Number(opt.value);
        const base = 'x'+n;
        opt.textContent = allowedSet.has(n) ? (base+' ✓') : base;
      });
    }
    function updatePosStatus(){
      const openCount = Array.from(positions.values()).filter(p=>!p.closed).length;
      els.posStatus.textContent = openCount ? `${openCount} posição(ões) aberta(s)` : 'Nenhuma posição aberta.';
    }
    function selectDefaultSymbol(){
      const all = Array.from(els.symbolSelect.querySelectorAll('option'));
      let def = all.find(o=>DEFAULT_SYMBOL_REGEX.test(o.textContent||'')) || all[0];
      if(def){ els.symbolSelect.value = def.value; return def.value; }
      return null;
    }

    // ========= OAUTH =========
    function extractTokensFromUrl(){
      const q=new URLSearchParams(location.search); const tokens=[];
      for(let i=1;i<=10;i++){ const acct=q.get(`acct${i}`),token=q.get(`token${i}`),cur=q.get(`cur${i}`); if(acct&&token){ tokens.push({account:acct.toUpperCase(),token,currency:(cur||'USD').toUpperCase()}); } }
      if(tokens.length){ localStorage.setItem('POINT_TOKENS',JSON.stringify(tokens)); history.replaceState({},document.title,location.pathname); }
    }
    function getStoredTokens(){ try{return JSON.parse(localStorage.getItem('POINT_TOKENS')||'[]');}catch(e){return[]} }
    function clearTokens(){ localStorage.removeItem('POINT_TOKENS'); localStorage.removeItem('POINT_SELECTED'); }

    // ========= WS =========
    function connectWS(){
      if(ws&&ws.readyState===1) return;
      ws=new WebSocket(WS_URL);
      ws.onopen=()=>{
        setConnectedUI(true);
        const remembered=JSON.parse(localStorage.getItem('POINT_SELECTED')||'null');
        const tokens=getStoredTokens();
        if(remembered&&tokens.length){
          const match=tokens.find(t=>t.account===remembered.account);
          if(match) authorize(match.token,match.account,match.currency);
        }
      };
      ws.onclose=()=>{ setConnectedUI(false); setAuthUI(false); };
      ws.onmessage=handleMessage;
      ws.onerror=()=>toast('Erro de WebSocket',true);
    }
    function send(msg){
      if(!ws||ws.readyState!==1){ els.posStatus.textContent='Sistema não conectado'; return; }
      ws.send(JSON.stringify(msg));
    }

    // ========= SUBSCRIÇÕES: helpers =========
    function forgetAllSubscriptions(){
      if(tickSubId){ send({ forget: tickSubId }); tickSubId=null; }
      if(ohlcSubId){ send({ forget: ohlcSubId }); ohlcSubId=null; }
      send({ forget_all: 'ticks' });
      send({ forget_all: 'candles' });
      activeTicksSymbol = null;
      activeOHLCKey = null;
    }

    // ========= MENSAGENS =========
    function handleMessage(evt){
      const data=JSON.parse(evt.data);
      if(data.error){ toast(data.error.message||'Erro desconhecido',true); return; }

      if(data.msg_type==='authorize'){
        loginId=data.authorize.loginid; currency=data.authorize.currency||'USD';
        setAuthUI(true); initChart(); loadActiveSymbols(); subscribeBalance(); updatePosStatus();
        renderAllMultipliers();
      }

      if(data.msg_type==='active_symbols'){
        const list=(data.active_symbols||[]).map(s=>({
          symbol:s.symbol, display:s.display_name, market:s.market, submarket:(s.submarket||'').toLowerCase()
        }));
        const groups = {};
        function groupPush(key,label,item){ if(!groups[key]) groups[key]={label,items:[]}; groups[key].items.push(item); }
        list.forEach(s=>{
          const mk=s.market;
          if(mk==='synthetic_index') groupPush('synthetic','Derived Synthetic',s);
          else if(mk==='basket_index') groupPush('baskets','Baskets',s);
          else if(mk==='cryptocurrency') groupPush('crypto','Criptomoedas',s);
          else if(mk==='forex') groupPush('forex','Forex',s);
          else if(mk==='commodities') groupPush('commodities','Commodities',s);
          else if(mk==='stock_index' || mk==='indices'){
            const sm=s.submarket;
            if(/amer/i.test(sm)) groupPush('idx_us','Índices Americanos',s);
            else if(/asia|oceania/i.test(sm)) groupPush('idx_asia','Índices Asiáticos',s);
            else if(/euro|eu/i.test(sm)) groupPush('idx_eu','Índices Europeus',s);
            else groupPush('idx_others','Índices',s);
          } else groupPush('others','Outros',s);
        });

        els.symbolSelect.innerHTML='';
        Object.values(groups).forEach(g=>{
          g.items.sort((a,b)=>a.display.localeCompare(b.display));
          const og=document.createElement('optgroup'); og.label=g.label;
          g.items.forEach(s=>{ const o=document.createElement('option'); o.value=s.symbol; o.textContent=s.display; og.appendChild(o); });
          els.symbolSelect.appendChild(og);
        });

        const chosen = selectDefaultSymbol();
        if(chosen){
          currentSymbol = chosen;
          subscribeTicks(currentSymbol);
          loadCandles(currentSymbol,currentGranularity);
          checkMultipliersAvailability(currentSymbol);
          renderAllMultipliers();
        }
      }

      if(data.msg_type==='tick'&&data.tick){
        const q=Number(data.tick.quote), epoch=Number(data.tick.epoch), sym=data.tick.symbol;
        if(els.tickPrice){ let s=q.toFixed(5); if(s.endsWith('00')) s=s.slice(0,-2); els.tickPrice.textContent=s; }
        if(sym===currentSymbol&&candleSeries){
          const bucket=Math.floor(epoch/currentGranularity)*currentGranularity;
          if(!liveBar||liveBar.time!==bucket){ liveBar={time:bucket,open:q,high:q,low:q,close:q}; }
          else{ if(q>liveBar.high) liveBar.high=q; if(q<liveBar.low) liveBar.low=q; liveBar.close=q; }
          candleSeries.update(liveBar);

          const key = `${currentSymbol}|${currentGranularity}`;
          const arr = barsCache.get(key) || [];
          if(arr.length){
            const last = arr[arr.length-1];
            if(last.time===Math.floor(epoch/currentGranularity)*currentGranularity){
              last.high = Math.max(last.high, q);
              last.low  = Math.min(last.low, q);
              last.close = q;
            }
          }
          maybeUpdateAI();
        }
      }

      if(data.msg_type==='candles'&&Array.isArray(data.candles)){
        const bars=data.candles.map(c=>({time:+c.epoch,open:+c.open,high:+c.high,low:+c.low,close:+c.close}));
        if(candleSeries){ candleSeries.setData(bars); liveBar=bars[bars.length-1]||null; lwChart.timeScale().fitContent(); }
        barsCache.set(`${currentSymbol}|${currentGranularity}`, bars.slice(-600));
        maybeUpdateAI(true);
      }

      if(data.msg_type==='ohlc'&&data.ohlc){
        const c=data.ohlc; if(!candleSeries) return;
        candleSeries.update({time:+c.open_time,open:+c.open,high:+c.high,low:+c.low,close:+c.close});
        if(c.complete) liveBar=null;

        const key = `${currentSymbol}|${currentGranularity}`;
        const arr = barsCache.get(key) || [];
        const t = +c.open_time;
        const idx = arr.findIndex(b=>b.time===t);
        if(idx>=0) arr[idx] = {time:t,open:+c.open,high:+c.high,low:+c.low,close:+c.close};
        else arr.push({time:t,open:+c.open,high:+c.high,low:+c.low,close:+c.close});
        barsCache.set(key, arr.slice(-600));
        maybeUpdateAI(true);
      }

      if(data.msg_type==='proposal'){
        if(data.proposal && data.proposal.id){
          const p=data.proposal;
          const meta = (data.echo_req && data.echo_req.passthrough) ? data.echo_req.passthrough : {};
          send({ buy:p.id, price:+p.ask_price, passthrough:{...meta, proposal_id:p.id} });
        }
      }

      if(data.msg_type==='buy'){
        if(data.buy && data.buy.contract_id){
          const meta = (data.echo_req && data.echo_req.passthrough) ? data.echo_req.passthrough : {};
          const cid = data.buy.contract_id;
          createPositionCard(cid, meta);
          subscribeOpenContract(cid);
          updatePosStatus();
        }
      }

      if(data.msg_type==='proposal_open_contract'){
        const poc=data.proposal_open_contract; if(!poc || !poc.contract_id) return;
        const cid=poc.contract_id;
        const pos=positions.get(cid); if(!pos) return;

        if(poc.buy_price!=null){ pos.entry = Number(poc.buy_price); pos.els.entry.textContent = `${pos.entry.toFixed(2)} ${pos.meta.currency}`; }

        const tp = (pos.meta.tp>0) ? pos.meta.tp : (poc.limit_order && poc.limit_order.take_profit ? Number(poc.limit_order.take_profit) : 0);
        const sl = (pos.meta.sl>0) ? pos.meta.sl : (poc.limit_order && poc.limit_order.stop_loss ? Number(poc.limit_order.stop_loss) : 0);
        pos.els.tp.textContent = tp>0 ? tp.toFixed(2) : '-';
        pos.els.sl.textContent = sl>0 ? sl.toFixed(2) : '-';

        const pl=(poc.profit||0);
        pos.els.pl.classList.remove('pl-green','pl-red');
        pos.els.pl.textContent = `${pl.toFixed(2)} ${pos.meta.currency}`;
        if(pl>0) pos.els.pl.classList.add('pl-green'); else if(pl<0) pos.els.pl.classList.add('pl-red');

        const entry = (pos.entry||pos.meta.amount);
        const contractVal = entry + pl;
        pos.els.value.classList.remove('pl-green','pl-red');
        pos.els.value.textContent = `${contractVal.toFixed(2)} ${pos.meta.currency}`;
        if(contractVal>entry) pos.els.value.classList.add('pl-green'); else if(contractVal<entry) pos.els.value.classList.add('pl-red');

        if(!pos.priceLine && poc.entry_tick){
          const isUp = poc.contract_type && poc.contract_type.includes('UP');
          pos.priceLine = candleSeries.createPriceLine({
            price: Number(poc.entry_tick),
            color: isUp ? '#22c55e' : '#ef4444',
            lineWidth:1, lineStyle:LightweightCharts.LineStyle.Solid,
            axisLabelVisible:true, title: isUp ? '▲' : '▼'
          });
        }

        if(!pos.closed && !pos.closing){
          if(tp>0 && pl >= tp){ pos.closing=true; send({ sell: cid, price: 0 }); }
          if(sl>0 && -pl >= sl){ pos.closing=true; send({ sell: cid, price: 0 }); }
        }

        if(poc.is_sold){
          pos.closed = true;
          pos.els.status.textContent = `Fechado · ${pl.toFixed(2)} ${pos.meta.currency}`;
          pos.els.closeBtn.classList.add('hidden');
          if(pos.priceLine){ candleSeries.removePriceLine(pos.priceLine); pos.priceLine=null; }
          if(pl>0) playCash();
          updatePosStatus();
        }
      }

      if(data.msg_type==='balance'){
        if(data.balance && typeof data.balance.balance!=='undefined'){
          const bal=+data.balance.balance; els.balanceInput.value=`${bal.toFixed(2)} ${data.balance.currency||currency}`;
        }
        if(data.subscription && data.subscription.id && !balanceSubId){ balanceSubId=data.subscription.id; }
      }

      if(data.msg_type==='contracts_for' && data.contracts_for){
        const a=data.contracts_for.available||[];
        const types=a.flatMap(x=>x.contract_type||[]);
        const hasMult=types.includes('MULTUP')||types.includes('MULTDOWN');
        els.upBtn.disabled=!hasMult||!authorized; els.downBtn.disabled=!hasMult||!authorized; setBadge(hasMult);

        let allowed=[];
        for(const item of a){
          if(item.contract_type && (item.contract_type.includes('MULTUP')||item.contract_type.includes('MULTDOWN'))){
            if(Array.isArray(item.available_multipliers)) allowed=allowed.concat(item.available_multipliers);
            if(item.multiplier_range && Array.isArray(item.multiplier_range.list)) allowed=allowed.concat(item.multiplier_range.list);
            if(Array.isArray(item.multipliers)) allowed=allowed.concat(item.multipliers);
          }
        }
        allowed=[...new Set(allowed.map(Number).filter(Number.isFinite))].sort((x,y)=>x-y);
        const sym = (data.echo_req && data.echo_req.contracts_for) || currentSymbol;
        allowedBySymbol.set(sym, allowed);
        if(sym === currentSymbol){ currentAllowedMultipliers = allowed.slice(); updateMultiplierHighlights(); }
      }
    }

    // ========= Indicadores (IA) =========
    function sma(vals, p){ if(vals.length<p) return []; const out=[]; let s=0; for(let i=0;i<vals.length;i++){ s+=vals[i]; if(i>=p) s-=vals[i-p]; if(i>=p-1) out.push(s/p); } return out; }
    function ema(arr, period, accessor=(x)=>x){
      const k = 2/(period+1); let emaPrev;
      return arr.map((v,i)=>{ const val = accessor(v); if(i===0){ emaPrev = val; return val; } emaPrev = val*k + emaPrev*(1-k); return emaPrev; });
    }
    function rsi(arr, period=14, accessor=(x)=>x){
      if(arr.length<period+1) return [];
      let gains=0, losses=0;
      for(let i=1;i<=period;i++){
        const ch = accessor(arr[i]) - accessor(arr[i-1]);
        if(ch>=0) gains += ch; else losses += -ch;
      }
      gains/=period; losses/=period;
      const out = new Array(arr.length).fill(null);
      out[period] = 100 - 100/(1 + (losses===0?1000:gains/losses));
      for(let i=period+1;i<arr.length;i++){
        const ch = accessor(arr[i]) - accessor(arr[i-1]);
        const gain = ch>0?ch:0;
        const loss = ch<0?-ch:0;
        gains = (gains*(period-1)+gain)/period;
        losses= (losses*(period-1)+loss)/period;
        out[i] = 100 - 100/(1 + (losses===0?1000:gains/losses));
      }
      return out;
    }
    function macd(arr, fast=12, slow=26, signalP=9, accessor=(x)=>x){
      const emaFast = ema(arr, fast, accessor);
      const emaSlow = ema(arr, slow, accessor);
      const macdLine = emaFast.map((v,i)=> v - (emaSlow[i]??0));
      const signal = ema(macdLine.map(v=>({v})), signalP, x=>x.v);
      const hist = macdLine.map((v,i)=> v - (signal[i]??0));
      return { macdLine, signal, hist };
    }
    function atr(arr, period=14){
      if(arr.length<period+1) return [];
      const trs = [null];
      for(let i=1;i<arr.length;i++){
        const h = arr[i].high, l = arr[i].low, cPrev = arr[i-1].close;
        trs[i] = Math.max(h-l, Math.abs(h-cPrev), Math.abs(l-cPrev));
      }
      const out=new Array(arr.length).fill(null);
      let s=0;
      for(let i=1;i<=period;i++) s+=trs[i];
      out[period]=s/period;
      for(let i=period+1;i<arr.length;i++) out[i]=(out[i-1]*(period-1)+trs[i])/period;
      return out;
    }
    function adx(arr, period=14){
      if(arr.length<period+2) return {adx:[], plusDI:[], minusDI:[]};
      const plusDM=[null], minusDM=[null], tr=[null];
      for(let i=1;i<arr.length;i++){
        const up = arr[i].high - arr[i-1].high;
        const dn = arr[i-1].low - arr[i].low;
        plusDM[i]  = (up>dn && up>0)? up : 0;
        minusDM[i] = (dn>up && dn>0)? dn : 0;
        tr[i] = Math.max(arr[i].high-arr[i].low, Math.abs(arr[i].high-arr[i-1].close), Math.abs(arr[i].low-arr[i-1].close));
      }
      let ATR=0, pDM=0, mDM=0;
      for(let i=1;i<=period;i++){ ATR+=tr[i]; pDM+=plusDM[i]; mDM+=minusDM[i]; }
      ATR/=period; pDM/=period; mDM/=period;
      const plusDI=[...new Array(arr.length).fill(null)], minusDI=[...new Array(arr.length).fill(null)], DX=[...new Array(arr.length).fill(null)];
      plusDI[period] = (pDM/ATR)*100; minusDI[period]=(mDM/ATR)*100; DX[period]= (Math.abs(plusDI[period]-minusDI[period])/(plusDI[period]+minusDI[period]))*100;
      for(let i=period+1;i<arr.length;i++){
        ATR = (ATR*(period-1)+tr[i])/period;
        pDM = (pDM*(period-1)+plusDM[i])/period;
        mDM = (mDM*(period-1)+minusDM[i])/period;
        plusDI[i]=(pDM/ATR)*100; minusDI[i]=(mDM/ATR)*100;
        DX[i]=(Math.abs(plusDI[i]-minusDI[i])/(plusDI[i]+minusDI[i]))*100;
      }
      const adx=[...new Array(arr.length).fill(null)];
      let s=0, start=period;
      for(let i=start;i<start+period;i++) s+=DX[i];
      adx[start+period-1]=s/period;
      for(let i=start+period;i<arr.length;i++) adx[i]=(adx[i-1]*(period-1)+DX[i])/period;
      return { adx, plusDI, minusDI };
    }
    function stoch(arr, kPeriod=14, dPeriod=3){
      if(arr.length<kPeriod) return {k:[], d:[]};
      const k=new Array(arr.length).fill(null);
      for(let i=kPeriod-1;i<arr.length;i++){
        let h=-Infinity,l=Infinity;
        for(let j=i-kPeriod+1;j<=i;j++){ h=Math.max(h,arr[j].high); l=Math.min(l,arr[j].low); }
        k[i] = ( (arr[i].close - l) / (h - l || 1) ) * 100;
      }
      const d=new Array(arr.length).fill(null);
      let s=0, count=0;
      for(let i=0;i<arr.length;i++){
        if(k[i]==null){ d[i]=null; continue; }
        s+=k[i]; count++;
        if(count>dPeriod){ s-=k[i-dPeriod]; count--; }
        if(count===dPeriod) d[i]=s/dPeriod;
      }
      return {k, d};
    }
    function bbands(arr, period=20, mult=2){
      const closes = arr.map(b=>b.close);
      const ma = sma(closes, period);
      const out = new Array(arr.length).fill(null).map(()=>({mid:null, up:null, dn:null}));
      for(let i=period-1;i<closes.length;i++){
        const slice = closes.slice(i-period+1, i+1);
        const mean = ma[i-(period-1)];
        const sd = Math.sqrt(slice.reduce((s,x)=>s+(x-mean)*(x-mean),0)/period);
        out[i] = { mid: mean, up: mean + mult*sd, dn: mean - mult*sd };
      }
      return out;
    }
    function supertrend(arr, atrPeriod=10, factor=3){
      if(arr.length<atrPeriod+2) return [];
      const _atr = atr(arr, atrPeriod);
      const res=new Array(arr.length).fill(null);
      let dir=1, upper=0, lower=0;
      for(let i=atrPeriod;i<arr.length;i++){
        const hl2 = (arr[i].high+arr[i].low)/2;
        const atrV = _atr[i]??0;
        const ub = hl2 + factor*atrV;
        const lb = hl2 - factor*atrV;
        if(i===atrPeriod){ upper=ub; lower=lb; res[i]={dir, value:lb}; continue; }
        upper = (ub < upper || arr[i-1].close > upper) ? ub : upper;
        lower = (lb > lower || arr[i-1].close < lower) ? lb : lower;
        if(arr[i].close > upper){ dir=1; } else if(arr[i].close < lower){ dir=-1; }
        res[i] = {dir, value: (dir===1?lower:upper)};
      }
      return res;
    }
    function resample(bars, factor){
      if(!bars || bars.length===0 || factor<=1) return bars;
      const out=[];
      for(let i=0;i<bars.length;i+=factor){
        const chunk = bars.slice(i,i+factor);
        if(chunk.length===0) continue;
        const open = chunk[0].open;
        const close = chunk[chunk.length-1].close;
        let high=-Infinity, low=Infinity, time=chunk[0].time;
        chunk.forEach(b=>{ if(b.high>high) high=b.high; if(b.low<low) low=b.low; });
        out.push({time, open, high, low, close});
      }
      return out;
    }

    // Score IA
    function computeAI(bars){
      if(!bars || bars.length<60) return {signal:'Neutro', conf:0.0, holdSec:0, details:{}, summary:'Dados insuficientes.'};

      const last = bars[bars.length-1];

      const ema9  = ema(bars, 9, x=>x.close);
      const ema21 = ema(bars,21, x=>x.close);
      const ema50 = ema(bars,50, x=>x.close);

      const rsi14 = rsi(bars,14,x=>x.close);
      const { macdLine, signal:macdSig, hist } = macd(bars,12,26,9,x=>x.close);
      const atr14 = atr(bars,14);
      const { adx:adx14, plusDI, minusDI } = adx(bars,14);
      const { k:stochK, d:stochD } = stoch(bars,14,3);
      const bb = bbands(bars,20,2);
      const st = supertrend(bars,10,3);

      const e9 = ema9.at(-1), e21=ema21.at(-1), e50=ema50.at(-1);
      const rLast = rsi14.at(-1) ?? 50;
      const mLast = macdLine.at(-1) ?? 0;
      const sLast = macdSig.at(-1) ?? 0;
      const hLast = hist.at(-1) ?? 0;

      const adxLast = adx14.at(-1) ?? 0;
      const pdi = plusDI.at(-1) ?? 0;
      const mdi = minusDI.at(-1) ?? 0;

      const kLast = stochK.at(-1) ?? 50;
      const dLast = stochD.at(-1) ?? 50;

      const bbLast = bb.at(-1) || {mid:null,up:null,dn:null};
      const stLast = st.at(-1) || {dir:0,value:null};

      const barsHTF = resample(bars.slice(-180), 3);
      const ema50H = ema(barsHTF,50, x=>x.close).at(-1);
      const stH = supertrend(barsHTF,10,3).at(-1) || {dir:0};
      const macdH = macd(barsHTF,12,26,9,x=>x.close);
      const macdUpH = (macdH.macdLine.at(-1) ?? 0) > (macdH.signal.at(-1) ?? 0);
      const macdDnH = (macdH.macdLine.at(-1) ?? 0) < (macdH.signal.at(-1) ?? 0);

      const trendUp   = last.close>e50 && e9>e21 && mLast>sLast && hLast>0 && stLast.dir===1;
      const trendDown = last.close<e50 && e9<e21 && mLast<sLast && hLast<0 && stLast.dir===-1;
      const trendUpHTF   = (barsHTF.at(-1)?.close || 0) > (ema50H || -Infinity) && stH.dir===1 && macdUpH;
      const trendDownHTF = (barsHTF.at(-1)?.close || 0) < (ema50H || Infinity) && stH.dir===-1 && macdDnH;

      const adxStrong = adxLast>=20;
      const diBull = pdi>mdi;
      const diBear = mdi>pdi;
      const stochBull = kLast>dLast && kLast<80;
      const stochBear = kLast<dLast && kLast>20;
      const nearUpper = bbLast.up && last.close > bbLast.up*0.995;
      const nearLower = bbLast.dn && last.close < bbLast.dn*1.005;

      let upScore=0, downScore=0, reasons=[];
      function add(reason, weight, dir){ if(dir==='up') upScore+=weight; else downScore+=weight; reasons.push(reason); }

      if(trendUp){ add('Tendência UP (EMA/MACD/Supertrend)', 0.30, 'up'); }
      if(trendDown){ add('Tendência DOWN (EMA/MACD/Supertrend)', 0.30, 'down'); }

      if(trendUpHTF){ add('Confirmação UP no TF superior', 0.20, 'up'); }
      if(trendDownHTF){ add('Confirmação DOWN no TF superior', 0.20, 'down'); }

      if(adxStrong && diBull){ add('Força (ADX) e +DI>−DI', 0.15, 'up'); }
      if(adxStrong && diBear){ add('Força (ADX) e −DI>+DI', 0.15, 'down'); }

      if(stochBull){ add('Estocástico favorável (alta)', 0.10, 'up'); }
      if(stochBear){ add('Estocástico favorável (baixa)', 0.10, 'down'); }

      if(bbLast.mid && last.close>bbLast.mid){ add('Preço acima da banda média (BB)', 0.08, 'up'); }
      if(bbLast.mid && last.close<bbLast.mid){ add('Preço abaixo da banda média (BB)', 0.08, 'down'); }

      if(nearUpper){ downScore += 0.05; reasons.push('Perto da banda superior (risco de correção)'); }
      if(nearLower){ upScore   += 0.05; reasons.push('Perto da banda inferior (risco de repique)'); }

      let conf = Math.max(upScore,downScore);
      conf = Math.min(0.95, Math.max(0.20, conf+0.35));

      let signal='Neutro';
      if(upScore>downScore && upScore>=0.70) signal='UP';
      else if(downScore>upScore && downScore>=0.70) signal='DOWN';

      let candles=2;
      if(adxStrong && (trendUpHTF||trendDownHTF)) candles=4;
      if(adxLast>=28) candles=5;
      const holdSec = candles * (currentGranularity||60);

      return {
        signal,
        conf: +(conf*100).toFixed(1),
        holdSec,
        details:{ close:last.close, rsi:rsi14.at(-1)??50, stDir:stLast.dir, stVal:stLast.value, bbUp:bbLast.up, bbDn:bbLast.dn, stochK:stochK.at(-1)??50, stochD:stochD.at(-1)??50, adx:adxLast, plusDI:pdi, minusDI:mdi, ema9:ema9.at(-1), ema21:ema21.at(-1), ema50:ema50.at(-1), macd:mLast, macdSig:sLast, macdHist:hLast, atr:atr14.at(-1)??0, bbMid:bbLast.mid },
        summary: reasons.join(' · ')
      };
    }

    let lastAICalcAt = 0;
    function maybeUpdateAI(force=false){
      const now = Date.now();
      if(!force && now-lastAICalcAt<500) return;
      lastAICalcAt = now;

      const key = `${currentSymbol}|${currentGranularity}`;
      const bars = barsCache.get(key);
      const res = computeAI(bars);
      renderAIPanel(res);
      return res;
    }

    function renderAIPanel(res){
      if(!res) return;
      els.aiSignal.textContent = res.signal;
      els.aiSignal.classList.remove('pl-green','pl-red');
      if(res.signal==='UP') els.aiSignal.classList.add('pl-green');
      else if(res.signal==='DOWN') els.aiSignal.classList.add('pl-red');
      els.aiConfidence.textContent = `Confiança: ${res.conf}%`;
      els.aiUpdatedAt.textContent = new Date().toLocaleTimeString();
      const mins = Math.floor((res.holdSec||0)/60), secs=(res.holdSec||0)%60;
      els.aiHold.textContent = (res.holdSec>0) ? `${mins}m ${secs}s (aprox.)` : '—';
      els.aiSummary.textContent = res.summary || '—';

      const d = res.details || {};
      els.aiIndicators.innerHTML = `
        <div class="glass rounded-lg p-2"><div class="text-[11px] text-slate-400">EMA9/21/50</div><div>${(d.ema9||0).toFixed(5)} / ${(d.ema21||0).toFixed(5)} / ${(d.ema50||0).toFixed(5)}</div></div>
        <div class="glass rounded-lg p-2"><div class="text-[11px] text-slate-400">RSI(14)</div><div>${(d.rsi||0).toFixed(2)}</div></div>
        <div class="glass rounded-lg p-2"><div class="text-[11px] text-slate-400">MACD / Sinal / Hist</div><div>${(d.macd||0).toFixed(5)} / ${(d.macdSig||0).toFixed(5)} / ${(d.macdHist||0).toFixed(5)}</div></div>
        <div class="glass rounded-lg p-2"><div class="text-[11px] text-slate-400">ATR(14)</div><div>${(d.atr||0).toFixed(5)}</div></div>
        <div class="glass rounded-lg p-2"><div class="text-[11px] text-slate-400">ADX(14) / +DI / −DI</div><div>${(d.adx||0).toFixed(2)} / ${(d.plusDI||0).toFixed(2)} / ${(d.minusDI||0).toFixed(2)}</div></div>
        <div class="glass rounded-lg p-2"><div class="text-[11px] text-slate-400">%K / %D (Stoch)</div><div>${(d.stochK||0).toFixed(2)} / ${(d.stochD||0).toFixed(2)}</div></div>
        <div class="glass rounded-lg p-2"><div class="text-[11px] text-slate-400">BB Mid/Up/Dn</div><div>${(d.bbMid||0).toFixed(5)} / ${(d.bbUp||0).toFixed(5)} / ${(d.bbDn||0).toFixed(5)}</div></div>
        <div class="glass rounded-lg p-2"><div class="text-[11px] text-slate-400">Supertrend</div><div>${d.stDir===1?'Alta':'Baixa'} @ ${(d.stVal||0).toFixed(5)}</div></div>
      `;
    }

    function refreshAISignal(){
      const res = maybeUpdateAI(true);
      if(!res) { showTraderMessage('dados insuficientes para analisar.'); return; }
      if(res.signal==='UP') showTraderMessage(`sugerimos **UP** com confiança ${res.conf}% · permanecer ~ ${Math.round((res.holdSec||0)/60)} min.`);
      else if(res.signal==='DOWN') showTraderMessage(`sugerimos **DOWN** com confiança ${res.conf}% · permanecer ~ ${Math.round((res.holdSec||0)/60)} min.`);
      else showTraderMessage('Condições neutras. Aguarde melhor confluência ou altere o timeframe.');
    }

    let lastAutoAt = 0;
    function executeAIAuto(){
      const now = Date.now();
      if(now - lastAutoAt < 8000){ showTraderMessage('aguarde alguns segundos antes de nova execução automática.'); return; }
      const res = maybeUpdateAI(true);
      if(!res){ showTraderMessage('dados insuficientes para analisar.'); return; }

      const strongConf = res.conf >= 75;
      const d = res.details || {};
      const adxOK = (d.adx||0) >= 22;
      const rsiOK = (d.rsi||50) >= 35 && (d.rsi||50) <= 65;
      const stochOK = (d.stochK!=null && d.stochD!=null) ? Math.abs(d.stochK - d.stochD) <= 30 : true;
      const notNearBBEdge = !((d.bbUp && d.close>d.bbUp*0.998) || (d.bbDn && d.close<d.bbDn*1.002));
      const supertrendAgree = (res.signal==='UP' && d.stDir===1) || (res.signal==='DOWN' && d.stDir===-1);

      if(res.signal==='Neutro' || !strongConf || !adxOK || !rsiOK || !stochOK || !notNearBBEdge || !supertrendAgree){
        showTraderMessage('Cenário ainda conservador/indefinido para auto-execução. Ajuste timeframe ou aguarde nova vela.');
        return;
      }

      const symbol=els.symbolSelect.value;
      const multiplier=Number(els.multInput.value||0);
      const allowed = allowedBySymbol.get(symbol) || currentAllowedMultipliers || [];
      if(Array.isArray(allowed) && allowed.length && !allowed.includes(multiplier)){
        const list = allowed.map(v=>'x'+v).join(', ');
        showTraderMessage(`o multiplicador x${multiplier} não é suportado para este mercado. Suportados: ${list}.`);
        updateMultiplierHighlights();
        return;
      }

      lastAutoAt = now;
      if(res.signal==='UP') placeMultiplier('up');
      else if(res.signal==='DOWN') placeMultiplier('down');
    }

    // ========= API =========
    function authorize(token,acct,cur){ currency=(cur||'USD').toUpperCase(); send({ authorize:token, passthrough:{acct} }); }
    function loadActiveSymbols(){ send({ active_symbols:'full' }); }

    function subscribeTicks(symbol){
      if(activeTicksSymbol===symbol && tickSubId){ return; }
      if(tickSubId){ send({ forget: tickSubId }); tickSubId=null; }
      send({ forget_all: 'ticks' });
      activeTicksSymbol = null;

      if(els.tickSymbol) els.tickSymbol.textContent=symbol; if(els.tickNote) els.tickNote.textContent='Recebendo ticks...';
      send({ ticks:symbol, subscribe:1 });
      ws.addEventListener('message', function once(e){ const d=JSON.parse(e.data);
        if(d.msg_type==='tick'&&d.tick&&d.subscription&&d.subscription.id){ tickSubId=d.subscription.id; activeTicksSymbol = symbol; ws.removeEventListener('message',once); }
      });
    }

    function loadCandles(symbol,granularitySec){
      if(!symbol) return; currentSymbol=symbol; currentGranularity=Number(granularitySec||60);
      const key = `${symbol}|${currentGranularity}`;
      if(activeOHLCKey===key && ohlcSubId){ return; }

      liveBar=null; if(candleSeries){ candleSeries.setData([]); }
      if(ohlcSubId){ send({ forget: ohlcSubId }); ohlcSubId=null; }
      send({ forget_all: 'candles' });
      activeOHLCKey = null;

      send({ ticks_history:symbol, adjust_start_time:1, count:300, end:'latest', style:'candles', granularity:currentGranularity });
      send({ ohlc:1, symbol, granularity:currentGranularity, subscribe:1 });
      ws.addEventListener('message', function once(e){ try{ const d=JSON.parse(e.data);
        if(d.msg_type==='ohlc'&&d.subscription&&d.subscription.id){ ohlcSubId=d.subscription.id; activeOHLCKey = key; ws.removeEventListener('message',once);} }catch(err){} });
    }

    function subscribeOpenContract(contract_id){
      send({ proposal_open_contract:1, contract_id, subscribe:1, passthrough:{contract_id} });
      ws.addEventListener('message', function once(e){ const d=JSON.parse(e.data);
        if(d.msg_type==='proposal_open_contract'&&d.subscription&&d.subscription.id){
          const cid = d.proposal_open_contract.contract_id;
          const pos = positions.get(cid); if(pos) pos.subId = d.subscription.id;
          ws.removeEventListener('message',once);
        }
      });
    }

    function subscribeBalance(){
      if(balanceSubId){ send({ forget:balanceSubId }); balanceSubId=null; }
      send({ balance:1, subscribe:1 }); // atualização automática
    }
    function checkMultipliersAvailability(symbol){ send({ contracts_for:symbol, currency }); }

    // ========= POSIÇÕES (UI) =========
    function createPositionCard(contract_id, meta){
      const wrap = document.createElement('div');
      wrap.id = `pos-${contract_id}`;
      wrap.className = 'rounded-xl border border-slate-800 p-3 space-y-2';

      const top = document.createElement('div');
      top.className = 'flex items-center justify-between';
      const title = document.createElement('div');
      title.className = 'text-sm';
      title.textContent = `${meta.assetName || meta.symbol} · ${meta.direction==='up'?'Up':'Down'} x${meta.multiplier}`;
      const status = document.createElement('div');
      status.className = 'text-xs text-slate-400';
      status.textContent = 'Aberto';
      top.appendChild(title); top.appendChild(status);

      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-2 gap-x-3 gap-y-1 text-sm';
      grid.innerHTML = `
        <div class="text-slate-400">Custos do contrato</div><div class="text-slate-200" id="v_cost">${meta.amount.toFixed(2)} ${meta.currency}</div>
        <div class="text-slate-400">Valor do contrato</div><div class="text-slate-200" id="v_value">${meta.amount.toFixed(2)} ${meta.currency}</div>
        <div class="text-slate-400">Entrada</div><div class="text-slate-200" id="v_entry">${meta.amount.toFixed(2)} ${meta.currency}</div>
        <div class="text-slate-400">Take profit</div><div class="text-slate-200" id="v_tp">${meta.tp>0?meta.tp.toFixed(2):'-'}</div>
        <div class="text-slate-400">Stop loss</div><div class="text-slate-200" id="v_sl">${meta.sl>0?meta.sl.toFixed(2):'-'}</div>
        <div class="text-slate-400">Lucro/Prejuízo</div><div class="text-slate-200 font-semibold" id="v_pl">0.00 ${meta.currency}</div>
      `;

      const actions = document.createElement('div');
      actions.className = 'flex justify-end';
      const btn = document.createElement('button');
      btn.className = 'btn px-3 py-1 rounded-lg bg-slate-700 hover:bg-slate-600 text-xs';
      btn.textContent = 'Fechar';
      actions.appendChild(btn);

      wrap.appendChild(top); wrap.appendChild(grid); wrap.appendChild(actions);
      els.positionsList.prepend(wrap);

      const refs = {
        status,
        value: grid.querySelector('#v_value'),
        entry: grid.querySelector('#v_entry'),
        tp: grid.querySelector('#v_tp'),
        sl: grid.querySelector('#v_sl'),
        pl: grid.querySelector('#v_pl'),
        closeBtn: btn
      };
      btn.onclick = ()=>{ send({ sell: contract_id, price: 0 }); };

      positions.set(contract_id, {
        meta, els: refs, subId: null, entry: meta.amount, priceLine: null, closed: false, closing: false
      });
    }

    // ========= AÇÕES =========
    function placeMultiplier(direction){
      if(!authorized){ showTraderMessage('por favor, autorize a conta para operar.'); return; }
      const symbol=els.symbolSelect.value;
      const amount=Number(els.stakeInput.value||0);
      const multiplier=Number(els.multInput.value||0);
      if(!symbol||!amount||!multiplier){ showTraderMessage('preencha símbolo, stake e multiplier.'); return; }

      const allowed = allowedBySymbol.get(symbol) || currentAllowedMultipliers || [];
      if(Array.isArray(allowed) && allowed.length && !allowed.includes(multiplier)){
        const list = allowed.map(v=>'x'+v).join(', ');
        showTraderMessage(`o multiplicador x${multiplier} não é suportado para este mercado. Suportados: ${list}.`);
        updateMultiplierHighlights();
        return;
      }

      const tp=Number(els.tpInput.value||0), sl=Number(els.slInput.value||0);
      const meta = { symbol, amount, multiplier, direction, tp, sl, currency, assetName: els.symbolSelect.selectedOptions[0]?.textContent || symbol };

      els.posStatus.textContent='Enviando proposal...';

      const req={ proposal:1, amount, basis:'stake', contract_type: direction==='up' ? 'MULTUP' : 'MULTDOWN', currency, symbol, multiplier, passthrough: meta };
      if(tp>0 || sl>0){
        req.limit_order = {};
        if(tp>0) req.limit_order.take_profit = tp;
        if(sl>0) req.limit_order.stop_loss = sl;
      }
      send(req);
    }

    // ========= GRÁFICO =========
    function initChart(){
      if(lwChart||!els.chartWrap) return;
      lwChart=LightweightCharts.createChart(els.chartWrap,{
        autoSize:true,
        layout:{ background:{ type:'solid', color:'transparent' }, textColor:'#9fb0d0' },
        grid:{ vertLines:{ color:'#1e2a46' }, horzLines:{ color:'#1e2a46' } },
        crosshair:{ mode:LightweightCharts.CrosshairMode.Magnet },
        rightPriceScale:{ borderColor:'#1e2a46' },
        timeScale:{ borderColor:'#1e2a46', timeVisible:true, secondsVisible:false, rightOffset:3 }
      });
      candleSeries=lwChart.addCandlestickSeries({ upColor:'#22c55e', downColor:'#ef4444', wickUpColor:'#22c55e', wickDownColor:'#ef4444', borderVisible:false });
      new ResizeObserver(()=>{ lwChart.applyOptions({}); }).observe(els.chartWrap);
    }

    // ========= CONTA: comportamento do select (Demo/Real fechado) =========
    function isDemoLogin(id){ return /VRTC/i.test(id||''); }
    function buildAccountClosedState(){
      const sel = els.accountSelect;
      const remembered = JSON.parse(localStorage.getItem('POINT_SELECTED')||'null');
      const label = remembered ? (isDemoLogin(remembered.account) ? 'Conta Demo' : 'Conta Real') : 'Selecionar conta';
      sel.innerHTML = '';
      const o = document.createElement('option');
      o.value = remembered?.account || '';
      o.textContent = label;
      sel.appendChild(o);
    }
    function buildAccountOpenList(){
      const sel = els.accountSelect;
      const tokens = getStoredTokens();
      sel.innerHTML = '';
      tokens.forEach(t=>{
        const o = document.createElement('option');
        o.value = t.account;
        o.textContent = `${t.account} • ${t.currency}`;
        sel.appendChild(o);
      });
    }

    // ========= EVENTOS =========
    els.loginBtn.onclick=()=>{ window.location.href=OAUTH_URL; };
    els.logoutBtn.onclick=()=>{
      positions.clear(); els.positionsList.innerHTML=''; updatePosStatus();
      if(ws&&ws.readyState===1) ws.close();
      forgetAllSubscriptions();
      clearTokens(); setAuthUI(false); els.accountSelect.innerHTML=''; if(candleSeries) candleSeries.setData([]);
    };

    // Conta: abre lista ao focar; ao escolher autoriza e volta para Demo/Real
    els.accountSelect.addEventListener('focus', ()=>{
      const tokens=getStoredTokens(); if(!tokens.length) return;
      buildAccountOpenList();
    });
    els.accountSelect.addEventListener('change', ()=>{
      const acct = els.accountSelect.value;
      const tokens=getStoredTokens();
      const chosen=tokens.find(t=>t.account===acct);
      if(!chosen) return;
      localStorage.setItem('POINT_SELECTED',JSON.stringify(chosen));
      if(ws&&ws.readyState===1) authorize(chosen.token,chosen.account,chosen.currency); else connectWS();
      setTimeout(()=>{ subscribeBalance(); },200);
      setTimeout(buildAccountClosedState, 120);
    });
    els.accountSelect.addEventListener('blur', buildAccountClosedState);

    els.symbolSelect.onchange=(e)=>{
      const sym=e.target.value;
      subscribeTicks(sym);
      loadCandles(sym,currentGranularity);
      checkMultipliersAvailability(sym);
      renderAllMultipliers();
    };

    els.tfSelect.onchange=(e)=>{ loadCandles(els.symbolSelect.value, Number(e.target.value||60)); };

    els.upBtn.onclick=()=>{ placeMultiplier('up'); };
    els.downBtn.onclick=()=>{ placeMultiplier('down'); };

    document.getElementById('resetBtn').onclick=()=>{
      for(const [cid,pos] of positions){ if(pos.closed){ positions.delete(cid); const el=document.getElementById(`pos-${cid}`); if(el) el.remove(); } }
      updatePosStatus();
      forgetAllSubscriptions();
      els.stakeInput.value = 10; els.tpInput.value = ''; els.slInput.value = '';
      els.tfSelect.value = '60';
      const chosen = selectDefaultSymbol();
      if(chosen){
        currentSymbol = chosen;
        subscribeTicks(chosen);
        loadCandles(chosen,60);
        checkMultipliersAvailability(chosen);
      }
      renderAllMultipliers();
      els.posStatus.textContent = 'Histórico limpo.';
    };

    // Robô IA painel
    els.aiOpenBtn.onclick = ()=>{ els.aiPanel.classList.add('open'); maybeUpdateAI(true); };
    els.aiCloseBtn.onclick = ()=> els.aiPanel.classList.remove('open');
    els.aiExecuteBtn.onclick = refreshAISignal;
    els.aiAutoBtn.onclick = executeAIAuto;

    // MENU dropdown
    els.menuBtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      els.menuDropdown.classList.toggle('hidden');
    });
    document.addEventListener('click', (e)=>{
      const dd = els.menuDropdown;
      if(!dd.classList.contains('hidden') && !dd.contains(e.target) && e.target!==els.menuBtn){
        dd.classList.add('hidden');
      }
    });
    // Tabs
    [...document.querySelectorAll('.tab-btn')].forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.getAttribute('data-tab');
        document.getElementById('tab-treinamento').classList.toggle('hidden', tab!=='treinamento');
        document.getElementById('tab-termos').classList.toggle('hidden', tab!=='termos');
        document.getElementById('tab-download').classList.toggle('hidden', tab!=='download');
      });
    });

    // Treinamento: adicionar vídeo
    function ytToEmbed(url){
      try{
        const u = new URL(url);
        if(u.hostname.includes('youtu.be')){
          const id = u.pathname.slice(1);
          return `https://www.youtube.com/embed/${id}`;
        }
        if(u.hostname.includes('youtube.com')){
          const id = u.searchParams.get('v');
          if(id) return `https://www.youtube.com/embed/${id}`;
        }
      }catch(e){}
      return '';
    }
    function addVideoItem(embedUrl){
      const a = document.createElement('button');
      a.className = 'w-full text-left px-2 py-1 rounded hover:bg-slate-800/60';
      a.textContent = embedUrl.replace('https://www.youtube.com/embed/','');
      a.onclick = ()=>{ els.ytPlayer.src = embedUrl; };
      els.ytList.prepend(a);
      if(!els.ytPlayer.src) els.ytPlayer.src = embedUrl;
    }
    els.ytAddBtn.addEventListener('click', ()=>{
      const embed = ytToEmbed(els.ytUrlInput.value.trim());
      if(!embed){ alert('Link inválido do YouTube.'); return; }
      addVideoItem(embed);
      els.ytUrlInput.value='';
    });

    // ========= BOOT =========
    function extractAndBoot(){
      extractTokensFromUrl();
      const stored=getStoredTokens();
      if(stored.length){
        els.accountSelect.disabled=false;
        connectWS();
        const first=stored[0];
        localStorage.setItem('POINT_SELECTED',JSON.stringify(first));
        authorize(first.token,first.account,first.currency);
        setTimeout(buildAccountClosedState, 200);
      }else{
        connectWS(); initChart();
      }
    }

    function authorize(token,acct,cur){ currency=(cur||'USD').toUpperCase(); send({ authorize:token, passthrough:{acct} }); }
    function checkMultipliersAvailability(symbol){ send({ contracts_for:symbol, currency }); }

    extractAndBoot();
  </script>
</body>
</html>
