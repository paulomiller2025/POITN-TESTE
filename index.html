<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POINT — Multipliers (Deriv)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root{ --bg:#0b1220; --card:#121a2b; --muted:#9fb0d0; --ok:#22c55e; --warn:#eab308; --err:#ef4444; --ink:#e6edf7; --soft:#1b2740 }
    body{ background:var(--bg); color:var(--ink) }
    .card{ background:var(--card); border:1px solid #1e2a46 }
    .pill{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08) }
    .btn{ transition:transform .05s ease }
    .btn:active{ transform:translateY(1px) }
    .glass{ backdrop-filter: blur(8px); background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06) }
    .grid-col{ display:grid; grid-template-columns:1fr 1fr; gap:.75rem }
    .layout{ display:grid; grid-template-columns:260px 1fr 300px; gap:12px }
    @media (max-width:1024px){ .layout{ grid-template-columns:1fr } }
    select:focus,select:active{ color:#000 !important } select option{ color:#000 }
    #chartWrap{ height:480px; transition:height .2s ease } @media (max-width:1024px){ #chartWrap{ height:420px } }
    .pl-green{ color:#22c55e } .pl-red{ color:#ef4444 }
  </style>
</head>
<body>
  <header class="sticky top-0 z-50 border-b border-slate-800 bg-[color:var(--soft)]">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-indigo-500/20 flex items-center justify-center"><span class="text-indigo-300 font-bold">P</span></div>
        <div>
          <h1 class="text-lg font-semibold tracking-wide">POINT — Multipliers (Deriv)</h1>
          <p class="text-xs text-slate-400">App ID: 98640 • OAuth + WebSocket</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="loginBtn" class="btn px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm">Conectar</button>
        <button id="logoutBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-slate-100 text-sm hidden">Desconectar</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-4">
    <!-- STATUS -->
    <section class="card rounded-2xl p-4">
      <div class="flex flex-wrap items-center gap-3 justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-emerald-500/15 flex items-center justify-center"><span class="text-emerald-300">●</span></div>
          <div>
            <div id="connStatus" class="text-sm text-slate-300">Desconectado</div>
            <div id="loginNote" class="text-xs text-slate-400">Clique em <b>Conectar</b> para iniciar o OAuth.</div>
          </div>
        </div>
        <div class="flex flex-col gap-2">
          <div class="flex items-center gap-3">
            <label class="text-sm text-slate-300">Conta:</label>
            <select id="accountSelect" class="pill px-3 py-2 rounded-xl text-sm text-slate-200 bg-transparent" disabled></select>
            <button id="useAccountBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-sm disabled:opacity-50" disabled>Usar conta</button>
          </div>
          <div class="flex items-center gap-3">
            <label class="text-sm text-slate-300">Saldo:</label>
            <input id="balanceInput" class="pill px-3 py-2 rounded-xl text-sm bg-transparent text-slate-200 w-40 text-right" placeholder="—" disabled />
            <button id="refreshBalanceBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-sm disabled:opacity-50" disabled>Atualizar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- LAYOUT -->
    <div class="layout">
      <!-- ESQUERDA: POSIÇÕES (múltiplas) -->
      <section class="card rounded-2xl p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-xs uppercase tracking-wide text-slate-400">Posição</div>
          <button id="resetBtn" class="btn px-2 py-1 rounded-lg bg-slate-700 hover:bg-slate-600 text-xs">Reset histórico</button>
        </div>
        <div id="posStatus" class="text-sm">Nenhuma posição aberta.</div>
        <div id="positionsList" class="space-y-3 mt-3 max-h-[520px] overflow-auto pr-2"></div>
      </section>

      <!-- CENTRO: GRÁFICO -->
      <section class="card rounded-2xl p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-xs uppercase tracking-wide text-slate-400">Gráfico de Tendências (Velas)</div>
          <div class="flex items-center gap-2">
            <label for="tfSelect" class="text-xs text-slate-400">Timeframe</label>
            <select id="tfSelect" class="pill px-2 py-1 rounded-lg text-sm bg-transparent text-slate-200" disabled>
              <option value="60" selected>1m</option>
              <option value="120">2m</option>
              <option value="180">3m</option>
              <option value="300">5m</option>
              <option value="600">10m</option>
              <option value="900">15m</option>
              <option value="1800">30m</option>
              <option value="3600">1h</option>
              <option value="7200">2h</option>
              <option value="14400">4h</option>
              <option value="28800">8h</option>
              <option value="86400">1d</option>
            </select>
          </div>
        </div>
        <div id="chartWrap" class="glass rounded-xl"></div>
        <!-- Preço em tempo real (oculto) -->
        <div class="glass rounded-xl p-4 mt-3 hidden">
          <div id="tickSymbol" class="text-sm text-slate-400">—</div>
          <div class="text-3xl font-semibold mt-1" id="tickPrice">—</div>
          <div class="mt-3 text-xs text-slate-400" id="tickNote">Assina ticks ao escolher o símbolo.</div>
        </div>
      </section>

      <!-- DIREITA: MERCADO + AÇÃO -->
      <div class="flex flex-col gap-3">
        <section class="card rounded-2xl p-4">
          <div class="text-xs uppercase tracking-wide text-slate-400 mb-3">Mercado</div>
          <div class="space-y-3">
            <div>
              <label class="text-sm text-slate-300">Símbolo</label>
              <div class="flex items-center gap-2">
                <select id="symbolSelect" class="pill w-full px-3 py-2 rounded-xl text-sm bg-transparent text-slate-200" disabled>
                  <option>— carregando —</option>
                </select>
                <span id="multBadge" class="px-2 py-1 rounded-lg text-xs border hidden"></span>
              </div>
            </div>
            <div class="grid-col">
              <div>
                <label class="text-sm text-slate-300">Stake</label>
                <input id="stakeInput" type="number" min="1" step="1" value="10" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled />
              </div>
              <div>
                <label class="text-sm text-slate-300">Multiplier</label>
                <select id="multInput" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled></select>
              </div>
            </div>
            <div class="grid-col">
              <div>
                <label class="text-sm text-slate-300">Take Profit (opcional)</label>
                <input id="tpInput" type="number" min="1" step="1" placeholder="ex: 150" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled />
              </div>
              <div>
                <label class="text-sm text-slate-300">Stop Loss (opcional)</label>
                <input id="slInput" type="number" min="1" step="1" placeholder="ex: 130" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled />
              </div>
            </div>
            <!-- Deal Cancellation removido -->
          </div>
        </section>

        <section class="card rounded-2xl p-4">
          <div class="text-xs uppercase tracking-wide text-slate-400 mb-3">Ação</div>
          <div class="flex gap-3">
            <button id="upBtn" class="btn flex-1 px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white disabled:opacity-40" disabled>UP (MULTUP)</button>
            <button id="downBtn" class="btn flex-1 px-4 py-3 rounded-xl bg-rose-600 hover:bg-rose-500 text-white disabled:opacity-40" disabled>DOWN (MULTDOWN)</button>
          </div>
          <div class="text-xs text-slate-400 mt-2">
            Multipliers: perdas limitadas ao <b>stake</b>; podes fechar a qualquer momento; TP/SL suportados.
          </div>
        </section>
      </div>
    </div>
  </main>

  <script>
    // ========= CONFIG =========
    const APP_ID  = 98640;
    const WS_URL  = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;
    const OAUTH_URL = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}`;

    // ordem preferida apenas para ORGANIZAR quando a API aceitar vários
    const PREFERRED_MULTS = [10,15,20,40,50,80,100,200,250,350,400,450,500,700,800,1300,1600,2500,3200];

    const DEFAULT_SYMBOL_REGEX = /Volatility 100 \(1s\)/i;

    // ========= ESTADO =========
    let ws=null, authorized=false, currency='USD';
    let tickSubId=null, ohlcSubId=null, balanceSubId=null;
    let lwChart=null, candleSeries=null, currentSymbol=null, currentGranularity=60, liveBar=null;

    const positions = new Map();
    let currentAllowedMultipliers = []; // vindo de contracts_for

    // ========= ÁUDIO GANHO =========
    let audioCtx = null;
    function playCash(){
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        const t = audioCtx.currentTime + 0.01;
        const g = audioCtx.createGain();
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.25, t+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t+0.35);
        g.connect(audioCtx.destination);
        const o1 = audioCtx.createOscillator(); o1.type='triangle'; o1.frequency.setValueAtTime(1320, t); o1.frequency.exponentialRampToValueAtTime(880, t+0.3); o1.connect(g); o1.start(t); o1.stop(t+0.35);
        const o2 = audioCtx.createOscillator(); o2.type='square';   o2.frequency.setValueAtTime(1980, t); o2.frequency.exponentialRampToValueAtTime(990, t+0.25); o2.connect(g); o2.start(t); o2.stop(t+0.3);
      }catch(e){}
    }

    // ========= DOM =========
    const els = {
      loginBtn:document.getElementById('loginBtn'), logoutBtn:document.getElementById('logoutBtn'),
      connStatus:document.getElementById('connStatus'), loginNote:document.getElementById('loginNote'),
      accountSelect:document.getElementById('accountSelect'), useAccountBtn:document.getElementById('useAccountBtn'),
      symbolSelect:document.getElementById('symbolSelect'), stakeInput:document.getElementById('stakeInput'),
      multInput:document.getElementById('multInput'), tpInput:document.getElementById('tpInput'), slInput:document.getElementById('slInput'),
      upBtn:document.getElementById('upBtn'), downBtn:document.getElementById('downBtn'),
      tickSymbol:document.getElementById('tickSymbol'), tickPrice:document.getElementById('tickPrice'), tickNote:document.getElementById('tickNote'),
      balanceInput:document.getElementById('balanceInput'), refreshBalanceBtn:document.getElementById('refreshBalanceBtn'),
      tfSelect:document.getElementById('tfSelect'), chartWrap:document.getElementById('chartWrap'), multBadge:document.getElementById('multBadge'),
      posStatus:document.getElementById('posStatus'), positionsList:document.getElementById('positionsList'), resetBtn:document.getElementById('resetBtn'),
    };

    // ========= UI HELPERS =========
    function setConnectedUI(on){ els.connStatus.textContent = on ? 'Conectado (WebSocket ativo)' : 'Desconectado'; }
    function setAuthUI(on){
      authorized=!!on; const dis=!on;
      [els.accountSelect,els.useAccountBtn,els.symbolSelect,els.stakeInput,els.multInput,els.tpInput,els.slInput,els.upBtn,els.downBtn,els.refreshBalanceBtn,els.tfSelect]
        .forEach(el=>{ el.disabled=dis; });
      els.logoutBtn.classList.toggle('hidden',!on); els.loginBtn.classList.toggle('hidden',on);
      els.loginNote.textContent = on ? 'Autorizado. Escolhe a conta e o símbolo para negociar.' : 'Clique em Conectar para iniciar o OAuth.';
      if(dis){ els.balanceInput.value=''; els.balanceInput.placeholder='—'; }
    }
    function translateError(msg){
      let m=String(msg||'');
      m = m.replace(/Your account balance \(([^)]+)\) is insufficient to buy this contract \(([^)]+)\)\./i, 'Saldo da sua conta ($1) é insuficiente para comprar este contrato ($2).');
      m = m.replace(/Input validation failed:? ?(.+)?/i,'Validação de entrada falhou.');
      m = m.replace(/Market is closed/i,'O mercado está fechado');
      m = m.replace(/Insufficient balance/i,'Saldo insuficiente');
      m = m.replace(/Not authorized/i,'Não autorizado');
      m = m.replace(/Multiplier is not in acceptable range\. Accepts (.+)$/i,'O multiplicador selecionado não é aceite. Aceites: $1');
      return m;
    }
    function toast(msg,isErr=false){
      const s=String(msg||'');
      // Se vier "Accepts", sincroniza o seletor com a lista aceita e pede ao usuário escolher (sem auto-ajustar)
      if(isErr && /Accepts/i.test(s)){
        const raw = s.split('Accepts')[1]?.replace(':','').trim() || '';
        const values = raw.split(',').map(x=>Number(x.trim())).filter(Number.isFinite).sort((a,b)=>a-b);
        if(values.length){
          currentAllowedMultipliers = values.slice();
          setMultiplierOptions(values,true);
          els.posStatus.textContent = 'Erro: ' + translateError(s);
        }
        return;
      }
      console[isErr?'error':'log'](msg);
      if(isErr){ els.posStatus.textContent = `Erro: ${translateError(s)}`; }
    }
    function setBadge(available){
      const b=els.multBadge; if(!b) return;
      b.classList.remove('hidden');
      b.textContent = available ? 'Multipliers: disponível' : 'Multipliers: indisponível';
      b.className = available
        ? 'px-2 py-1 rounded-lg text-xs border bg-emerald-500/10 text-emerald-300 border-emerald-500/30'
        : 'px-2 py-1 rounded-lg text-xs border bg-rose-500/10 text-rose-300 border-rose-500/30';
    }
    function orderByPreference(allowed){
      const set = new Set(allowed);
      const top = PREFERRED_MULTS.filter(v=>set.has(v));
      const rest = allowed.filter(v=>!top.includes(v));
      return [...top, ...rest];
    }
    function setMultiplierOptions(allowed, forceEnable=false){
      const arr = Array.isArray(allowed)&&allowed.length
        ? [...new Set(allowed.map(Number).filter(Number.isFinite))].sort((a,b)=>a-b)
        : [];
      currentAllowedMultipliers = arr.slice();
      els.multInput.innerHTML='';
      if(arr.length){
        const ordered = orderByPreference(arr);
        ordered.forEach(v=>{ const o=document.createElement('option'); o.value=String(v); o.textContent='x'+v; els.multInput.appendChild(o); });
        els.multInput.disabled = false;
        els.upBtn.disabled = !authorized;
        els.downBtn.disabled = !authorized;
      }else{
        // nenhum multiplier disponível — desativa
        const o=document.createElement('option'); o.textContent='—'; o.value=''; els.multInput.appendChild(o);
        els.multInput.disabled = true;
        els.upBtn.disabled = true; els.downBtn.disabled = true;
      }
    }
    function updatePosStatus(){
      const openCount = Array.from(positions.values()).filter(p=>!p.closed).length;
      els.posStatus.textContent = openCount ? `${openCount} posição(ões) aberta(s)` : 'Nenhuma posição aberta.';
    }
    function selectDefaultSymbol(){
      const all = Array.from(els.symbolSelect.querySelectorAll('option'));
      let def = all.find(o=>DEFAULT_SYMBOL_REGEX.test(o.textContent||'')) || all[0];
      if(def){ els.symbolSelect.value = def.value; return def.value; }
      return null;
    }

    // ========= OAUTH =========
    function extractTokensFromUrl(){
      const q=new URLSearchParams(location.search); const tokens=[];
      for(let i=1;i<=10;i++){ const acct=q.get(`acct${i}`),token=q.get(`token${i}`),cur=q.get(`cur${i}`); if(acct&&token){ tokens.push({account:acct.toUpperCase(),token,currency:(cur||'USD').toUpperCase()}); } }
      if(tokens.length){ localStorage.setItem('POINT_TOKENS',JSON.stringify(tokens)); history.replaceState({},document.title,location.pathname); }
    }
    function getStoredTokens(){ try{return JSON.parse(localStorage.getItem('POINT_TOKENS')||'[]');}catch(e){return[]} }
    function clearTokens(){ localStorage.removeItem('POINT_TOKENS'); localStorage.removeItem('POINT_SELECTED'); }

    // ========= WS =========
    let wsObj=null;
    function connectWS(){
      if(wsObj&&wsObj.readyState===1) return;
      wsObj=new WebSocket(WS_URL);
      wsObj.onopen=()=>{
        setConnectedUI(true);
        const remembered=JSON.parse(localStorage.getItem('POINT_SELECTED')||'null');
        const tokens=getStoredTokens();
        if(remembered&&tokens.length){
          const match=tokens.find(t=>t.account===remembered.account);
          if(match) authorize(match.token,match.account,match.currency);
        }
      };
      wsObj.onclose=()=>{ setConnectedUI(false); setAuthUI(false); };
      wsObj.onmessage=handleMessage;
      wsObj.onerror=()=>toast('WebSocket error',true);
    }
    function send(msg){ if(!wsObj||wsObj.readyState!==1){ toast('WS não conectado',true); return; } wsObj.send(JSON.stringify(msg)); }

    // ========= HANDLER =========
    function handleMessage(evt){
      const data=JSON.parse(evt.data);
      if(data.error){ toast(data.error.message||'Erro desconhecido',true); return; }

      if(data.msg_type==='authorize'){
        currency=data.authorize.currency||'USD';
        setAuthUI(true); initChart(); loadActiveSymbols(); subscribeBalance(); updatePosStatus();
      }

      if(data.msg_type==='active_symbols'){
        const list=(data.active_symbols||[]).map(s=>({
          symbol:s.symbol, display:s.display_name, market:s.market, submarket:(s.submarket||'').toLowerCase()
        }));
        const groups = {};
        function groupPush(key,label,item){ if(!groups[key]) groups[key]={label,items:[]}; groups[key].items.push(item); }
        list.forEach(s=>{
          const mk=s.market;
          if(mk==='synthetic_index') groupPush('synthetic','Derived Synthetic',s);
          else if(mk==='basket_index') groupPush('baskets','Baskets',s);
          else if(mk==='cryptocurrency') groupPush('crypto','Criptomoedas',s);
          else if(mk==='forex') groupPush('forex','Forex',s);
          else if(mk==='commodities') groupPush('commodities','Commodities',s);
          else if(mk==='stock_index' || mk==='indices'){
            const sm=s.submarket;
            if(/amer/i.test(sm)) groupPush('idx_us','Índices Americanos',s);
            else if(/asia|oceania/i.test(sm)) groupPush('idx_asia','Índices Asiáticos',s);
            else if(/euro|eu/i.test(sm)) groupPush('idx_eu','Índices Europeus',s);
            else groupPush('idx_others','Índices',s);
          } else {
            groupPush('others','Outros',s);
          }
        });
        els.symbolSelect.innerHTML='';
        Object.values(groups).forEach(g=>{
          g.items.sort((a,b)=>a.display.localeCompare(b.display));
          const og=document.createElement('optgroup'); og.label=g.label;
          g.items.forEach(s=>{ const o=document.createElement('option'); o.value=s.symbol; o.textContent=s.display; og.appendChild(o); });
          els.symbolSelect.appendChild(og);
        });

        // DEFAULT: Volatility 100 (1s)
        const chosen = selectDefaultSymbol();
        if(chosen){
          currentSymbol = chosen;
          // desativa ações até sabermos os multiplicadores reais deste símbolo
          els.multInput.disabled = true; els.upBtn.disabled = true; els.downBtn.disabled = true;
          subscribeTicks(currentSymbol);
          loadCandles(currentSymbol,currentGranularity);
          checkMultipliersAvailability(currentSymbol);
        }
      }

      if(data.msg_type==='tick'&&data.tick){
        const q=Number(data.tick.quote), epoch=Number(data.tick.epoch), sym=data.tick.symbol;
        if(els.tickPrice){ let s=q.toFixed(5); if(s.endsWith('00')) s=s.slice(0,-2); els.tickPrice.textContent=s; }
        if(sym===currentSymbol&&candleSeries){
          const bucket=Math.floor(epoch/currentGranularity)*currentGranularity;
          if(!liveBar||liveBar.time!==bucket){ liveBar={time:bucket,open:q,high:q,low:q,close:q}; }
          else{ if(q>liveBar.high) liveBar.high=q; if(q<liveBar.low) liveBar.low=q; liveBar.close=q; }
          candleSeries.update(liveBar);
        }
      }

      if(data.msg_type==='candles'&&Array.isArray(data.candles)){
        const bars=data.candles.map(c=>({time:+c.epoch,open:+c.open,high:+c.high,low:+c.low,close:+c.close}));
        if(candleSeries){ candleSeries.setData(bars); liveBar=bars[bars.length-1]||null; lwChart.timeScale().fitContent(); }
      }

      if(data.msg_type==='ohlc'&&data.ohlc){
        const c=data.ohlc; if(!candleSeries) return;
        candleSeries.update({time:+c.open_time,open:+c.open,high:+c.high,low:+c.low,close:+c.close});
        if(c.complete) liveBar=null;
      }

      if(data.msg_type==='proposal'){
        if(data.proposal && data.proposal.id){
          const p=data.proposal;
          const meta = (data.echo_req && data.echo_req.passthrough) ? data.echo_req.passthrough : {};
          send({ buy:p.id, price:+p.ask_price, passthrough:{...meta, proposal_id:p.id} });
        }
      }

      if(data.msg_type==='buy'){
        if(data.buy && data.buy.contract_id){
          const meta = (data.echo_req && data.echo_req.passthrough) ? data.echo_req.passthrough : {};
          const cid = data.buy.contract_id;
          createPositionCard(cid, meta);
          subscribeOpenContract(cid);
          updatePosStatus();
        }
      }

      if(data.msg_type==='proposal_open_contract'){
        const poc=data.proposal_open_contract; if(!poc || !poc.contract_id) return;
        const cid=poc.contract_id;
        const pos=positions.get(cid); if(!pos) return;

        if(poc.buy_price!=null){ pos.entry = Number(poc.buy_price); pos.els.entry.textContent = `${pos.entry.toFixed(2)} ${pos.meta.currency}`; }

        const tp = (pos.meta.tp>0) ? pos.meta.tp : (poc.limit_order && poc.limit_order.take_profit ? Number(poc.limit_order.take_profit) : 0);
        const sl = (pos.meta.sl>0) ? pos.meta.sl : (poc.limit_order && poc.limit_order.stop_loss ? Number(poc.limit_order.stop_loss) : 0);
        pos.els.tp.textContent = tp>0 ? tp.toFixed(2) : '-';
        pos.els.sl.textContent = sl>0 ? sl.toFixed(2) : '-';

        const pl=(poc.profit||0);
        pos.els.pl.textContent = `${pl.toFixed(2)} ${pos.meta.currency}`;
        pos.els.pl.classList.toggle('pl-green', pl>0);
        pos.els.pl.classList.toggle('pl-red', pl<0);

        const entry = (pos.entry||pos.meta.amount);
        const contractVal = entry + pl;
        pos.els.value.textContent = `${contractVal.toFixed(2)} ${pos.meta.currency}`;
        pos.els.value.classList.toggle('pl-green', contractVal > entry);
        pos.els.value.classList.toggle('pl-red', contractVal < entry);

        if(!pos.priceLine && poc.entry_tick){
          const isUp = poc.contract_type && poc.contract_type.includes('UP');
          pos.priceLine = candleSeries.createPriceLine({
            price: Number(poc.entry_tick),
            color: isUp ? '#22c55e' : '#ef4444',
            lineWidth:1,
            lineStyle:LightweightCharts.LineStyle.Solid,
            axisLabelVisible:true,
            title: isUp ? '▲' : '▼'
          });
        }

        if(!pos.closed && !pos.closing){
          if(tp>0 && pl >= tp){ pos.closing=true; send({ sell: cid, price: 0 }); }
          if(sl>0 && -pl >= sl){ pos.closing=true; send({ sell: cid, price: 0 }); }
        }

        if(poc.is_sold){
          pos.closed = true;
          pos.els.status.textContent = `Fechado · ${pl.toFixed(2)} ${pos.meta.currency}`;
          pos.els.closeBtn.classList.add('hidden');
          if(pos.priceLine){ candleSeries.removePriceLine(pos.priceLine); pos.priceLine=null; }
          if(pl>0) playCash();
          updatePosStatus();
        }
      }

      if(data.msg_type==='balance'){
        if(data.balance && typeof data.balance.balance!=='undefined'){
          const bal=+data.balance.balance; els.balanceInput.value=`${bal.toFixed(2)} ${data.balance.currency||currency}`;
        }
        if(data.subscription && data.subscription.id && !balanceSubId){ balanceSubId=data.subscription.id; }
      }

      if(data.msg_type==='contracts_for' && data.contracts_for){
        const a=data.contracts_for.available||[];
        const types=a.flatMap(x=>x.contract_type||[]);
        const hasMult=types.includes('MULTUP')||types.includes('MULTDOWN');
        setBadge(hasMult);

        // construir lista somente com aceites
        let allowed=[];
        for(const item of a){
          if(item.contract_type && (item.contract_type.includes('MULTUP')||item.contract_type.includes('MULTDOWN'))){
            if(Array.isArray(item.available_multipliers)) allowed=allowed.concat(item.available_multipliers);
            if(item.multiplier_range && Array.isArray(item.multiplier_range.list)) allowed=allowed.concat(item.multiplier_range.list);
            if(Array.isArray(item.multipliers)) allowed=allowed.concat(item.multipliers);
          }
        }
        allowed=[...new Set(allowed.map(Number).filter(Number.isFinite))].sort((x,y)=>a-b);
        // (BUG FIX sort): 
        allowed = allowed.sort((x,y)=>x-y);

        // preencher o seletor SOMENTE com os aceites; desativar botões se vazio
        setMultiplierOptions(allowed,true);
      }
    }

    // ========= API =========
    function authorize(token,acct,cur){ currency=(cur||'USD').toUpperCase(); send({ authorize:token, passthrough:{acct} }); }
    function loadActiveSymbols(){ send({ active_symbols:'full' }); }
    function subscribeTicks(symbol){
      if(tickSubId){ send({ forget:tickSubId }); tickSubId=null; }
      if(els.tickSymbol) els.tickSymbol.textContent=symbol; if(els.tickNote) els.tickNote.textContent='Recebendo ticks...';
      send({ ticks:symbol, subscribe:1 });
      wsObj.addEventListener('message', function once(e){ const d=JSON.parse(e.data);
        if(d.msg_type==='tick'&&d.tick&&d.subscription&&d.subscription.id){ tickSubId=d.subscription.id; wsObj.removeEventListener('message',once); }
      });
    }
    function subscribeOpenContract(contract_id){
      send({ proposal_open_contract:1, contract_id, subscribe:1 });
    }
    function subscribeBalance(){ if(balanceSubId){ send({ forget:balanceSubId }); balanceSubId=null; } send({ balance:1, subscribe:1 }); els.refreshBalanceBtn.disabled=false; }

    // ========= POSIÇÕES (UI) =========
    function createPositionCard(contract_id, meta){
      const wrap = document.createElement('div');
      wrap.id = `pos-${contract_id}`;
      wrap.className = 'rounded-xl border border-slate-800 p-3 space-y-2';

      const top = document.createElement('div');
      top.className = 'flex items-center justify-between';
      const title = document.createElement('div');
      title.className = 'text-sm';
      title.textContent = `${meta.assetName || meta.symbol} · ${meta.direction==='up'?'Up':'Down'} x${meta.multiplier}`;
      const status = document.createElement('div');
      status.className = 'text-xs text-slate-400';
      status.textContent = 'Aberto';
      top.appendChild(title); top.appendChild(status);

      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-2 gap-x-3 gap-y-1 text-sm';
      grid.innerHTML = `
        <div class="text-slate-400">Custos do contrato</div><div class="text-slate-200" id="v_value_init">${meta.amount.toFixed(2)} ${meta.currency}</div>
        <div class="text-slate-400">Valor do contrato</div><div class="text-slate-200" id="v_value">${meta.amount.toFixed(2)} ${meta.currency}</div>
        <div class="text-slate-400">Entrada</div><div class="text-slate-200" id="v_entry">${meta.amount.toFixed(2)} ${meta.currency}</div>
        <div class="text-slate-400">Take profit</div><div class="text-slate-200" id="v_tp">${meta.tp>0?meta.tp.toFixed(2):'-'}</div>
        <div class="text-slate-400">Stop loss</div><div class="text-slate-200" id="v_sl">${meta.sl>0?meta.sl.toFixed(2):'-'}</div>
        <div class="text-slate-400">Lucro/Prejuízo</div><div class="text-slate-200 font-semibold" id="v_pl">0.00 ${meta.currency}</div>
      `;

      const actions = document.createElement('div');
      actions.className = 'flex justify-end';
      const btn = document.createElement('button');
      btn.className = 'btn px-3 py-1 rounded-lg bg-slate-700 hover:bg-slate-600 text-xs';
      btn.textContent = 'Fechar';
      actions.appendChild(btn);

      wrap.appendChild(top); wrap.appendChild(grid); wrap.appendChild(actions);
      els.positionsList.prepend(wrap);

      const refs = {
        status,
        value: grid.querySelector('#v_value'),
        entry: grid.querySelector('#v_entry'),
        tp: grid.querySelector('#v_tp'),
        sl: grid.querySelector('#v_sl'),
        pl: grid.querySelector('#v_pl'),
        closeBtn: btn
      };
      btn.onclick = ()=>{ send({ sell: contract_id, price: 0 }); };

      positions.set(contract_id, { meta, els: refs, subId:null, entry: meta.amount, priceLine:null, closed:false, closing:false });
    }

    // ========= AÇÕES =========
    function placeMultiplier(direction){
      if(!authorized){ els.posStatus.textContent='Erro: Não autorizado'; return; }
      const symbol=els.symbolSelect.value;
      const amount=Number(els.stakeInput.value||0);
      const multiplier=Number(els.multInput.value||0);

      if(!symbol || !Number.isFinite(amount) || amount<=0){ els.posStatus.textContent='Preencha símbolo e stake'; return; }
      // NUNCA auto-ajustar; se não for aceito, bloquear com instrução em PT
      if(!currentAllowedMultipliers.includes(multiplier)){
        if(currentAllowedMultipliers.length){
          els.posStatus.textContent='Erro: O multiplicador selecionado não é aceite para este mercado. Escolha um dos disponíveis no seletor.';
        }else{
          els.posStatus.textContent='Erro: Não há multiplicadores disponíveis para este mercado.';
        }
        return;
      }

      const tp=Number(els.tpInput.value||0), sl=Number(els.slInput.value||0);
      const meta = { symbol, amount, multiplier, direction, tp, sl, currency, assetName: els.symbolSelect.selectedOptions[0]?.textContent || symbol };

      els.posStatus.textContent='Enviando proposal...';

      const req={ proposal:1, amount, basis:'stake', contract_type: direction==='up' ? 'MULTUP' : 'MULTDOWN', currency, symbol, multiplier, passthrough: meta };
      if(tp>0 || sl>0){
        req.limit_order = {};
        if(tp>0) req.limit_order.take_profit = tp;
        if(sl>0) req.limit_order.stop_loss = sl;
      }
      send(req);
    }

    // ========= GRÁFICO =========
    function initChart(){
      if(lwChart||!els.chartWrap) return;
      lwChart=LightweightCharts.createChart(els.chartWrap,{
        autoSize:true,
        layout:{ background:{ type:'solid', color:'transparent' }, textColor:'#9fb0d0' },
        grid:{ vertLines:{ color:'#1e2a46' }, horzLines:{ color:'#1e2a46' } },
        crosshair:{ mode:LightweightCharts.CrosshairMode.Magnet },
        rightPriceScale:{ borderColor:'#1e2a46' },
        timeScale:{ borderColor:'#1e2a46', timeVisible:true, secondsVisible:false, rightOffset:3 }
      });
      candleSeries=lwChart.addCandlestickSeries({ upColor:'#22c55e', downColor:'#ef4444', wickUpColor:'#22c55e', wickDownColor:'#ef4444', borderVisible:false });
      new ResizeObserver(()=>{ lwChart.applyOptions({}); }).observe(els.chartWrap);
    }
    function loadCandles(symbol,granularitySec){
      if(!symbol) return; currentSymbol=symbol; currentGranularity=Number(granularitySec||60);
      liveBar=null; if(candleSeries){ candleSeries.setData([]); }
      if(ohlcSubId){ send({ forget:ohlcSubId }); ohlcSubId=null; }
      send({ ticks_history:symbol, adjust_start_time:1, count:300, end:'latest', style:'candles', granularity:currentGranularity });
      send({ ohlc:1, symbol, granularity:currentGranularity, subscribe:1 });
      wsObj.addEventListener('message', function once(e){ try{ const d=JSON.parse(e.data);
        if(d.msg_type==='ohlc'&&d.subscription&&d.subscription.id){ ohlcSubId=d.subscription.id; wsObj.removeEventListener('message',once);} }catch(err){} });
    }

    // ========= MERCADO =========
    function checkMultipliersAvailability(symbol){
      // Enquanto carrega, bloquear ações
      els.multInput.disabled = true; els.upBtn.disabled = true; els.downBtn.disabled = true;
      setMultiplierOptions([]); // limpa
      send({ contracts_for:symbol });
    }

    // ========= EVENTOS =========
    els.loginBtn.onclick=()=>{ window.location.href=OAUTH_URL; };
    els.logoutBtn.onclick=()=>{
      positions.clear(); els.positionsList.innerHTML=''; updatePosStatus();
      if(wsObj&&wsObj.readyState===1) wsObj.close();
      if(balanceSubId){ send({ forget:balanceSubId }); balanceSubId=null; }
      if(tickSubId){ send({ forget:tickSubId }); tickSubId=null; }
      if(ohlcSubId){ send({ forget:ohlcSubId }); ohlcSubId=null; }
      clearTokens(); setAuthUI(false); els.accountSelect.innerHTML=''; if(candleSeries) candleSeries.setData([]);
    };
    els.useAccountBtn.onclick=()=>{
      const opt=els.accountSelect.value; if(!opt) return;
      const tokens=getStoredTokens(); const chosen=tokens.find(t=>t.account===opt); if(!chosen) return;
      localStorage.setItem('POINT_SELECTED',JSON.stringify(chosen));
      if(wsObj&&wsObj.readyState===1) authorize(chosen.token,chosen.account,chosen.currency); else connectWS();
      setTimeout(()=>{ subscribeBalance(); },200);
    };
    els.refreshBalanceBtn.onclick=()=> send({ balance:1 });
    els.symbolSelect.onchange=(e)=>{
      const sym=e.target.value;
      subscribeTicks(sym); loadCandles(sym,currentGranularity); checkMultipliersAvailability(sym);
    };
    els.tfSelect.onchange=(e)=>{ loadCandles(els.symbolSelect.value, Number(e.target.value||60)); };
    els.upBtn.onclick=()=>{ placeMultiplier('up'); };
    els.downBtn.onclick=()=>{ placeMultiplier('down'); };
    document.getElementById('resetBtn').onclick=()=>{
      // remove cartões fechados
      for(const [cid,pos] of positions){ if(pos.closed){ positions.delete(cid); const el=document.getElementById(`pos-${cid}`); if(el) el.remove(); } }
      updatePosStatus();
      // repor inputs
      els.stakeInput.value = 10; els.tpInput.value = ''; els.slInput.value = '';
      // voltar ao padrão Volatility 100 (1s)
      const chosen = selectDefaultSymbol();
      if(chosen){
        subscribeTicks(chosen); loadCandles(chosen,60); checkMultipliersAvailability(chosen);
      }
      els.tfSelect.value = '60';
    };

    // ========= BOOT =========
    function extractAndBoot(){
      extractTokensFromUrl();
      const stored=getStoredTokens();
      if(stored.length){
        els.accountSelect.innerHTML=''; stored.forEach(t=>{ const o=document.createElement('option'); o.value=t.account; o.textContent=`${t.account} • ${t.currency}`; els.accountSelect.appendChild(o); });
        els.accountSelect.disabled=false; els.useAccountBtn.disabled=false;
        connectWS(); const first=stored[0]; localStorage.setItem('POINT_SELECTED',JSON.stringify(first)); authorize(first.token,first.account,first.currency);
      }else{ connectWS(); initChart(); }
    }
    function authorize(token,acct,cur){ currency=(cur||'USD').toUpperCase(); send({ authorize:token, passthrough:{acct} }); }
    function subscribeOpenContract(contract_id){ send({ proposal_open_contract:1, contract_id, subscribe:1 }); }
    function subscribeBalance(){ if(balanceSubId){ send({ forget:balanceSubId }); balanceSubId=null; } send({ balance:1, subscribe:1 }); els.refreshBalanceBtn.disabled=false; }

    extractAndBoot();
  </script>
</body>
</html>
