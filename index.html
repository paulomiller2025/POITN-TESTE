<!DOCTYPE html> 
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POINT — Multipliers (Deriv)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lightweight Charts para velas -->
  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root{
      --bg:#0b1220;--card:#121a2b;--muted:#9fb0d0;--ok:#22c55e;--warn:#eab308;--err:#ef4444;--ink:#e6edf7;--soft:#1b2740
    }
    body{background:var(--bg);color:var(--ink)}
    .card{background:var(--card);border:1px solid #1e2a46}
    .pill{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08)}
    .btn{transition:transform .05s ease}
    .btn:active{transform:translateY(1px)}
    .glass{backdrop-filter: blur(8px); background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06)}
    .grid-col{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    @media (min-width:1024px){.grid-col-3{grid-template-columns:repeat(3,1fr)}}

    /* === Ajuste solicitado: selects com texto preto ao clicar === */
    select:focus, select:active { color:#000 !important; }
    select option { color:#000; }

    /* Altura do gráfico */
    #chartWrap { height: 380px; transition: height .2s ease; }
    @media (min-width: 1024px){ #chartWrap{ height: 460px; } }
  </style>
</head>
<body>
  <header class="sticky top-0 z-50 border-b border-slate-800 bg-[color:var(--soft)]">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-indigo-500/20 flex items-center justify-center">
          <span class="text-indigo-300 font-bold">P</span>
        </div>
        <div>
          <h1 class="text-lg font-semibold tracking-wide">POINT — Multipliers (Deriv)</h1>
          <p class="text-xs text-slate-400">App ID: 98640 • OAuth + WebSocket</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="loginBtn" class="btn px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm">Conectar</button>
        <button id="logoutBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-slate-100 text-sm hidden">Desconectar</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- STATUS / CONTAS -->
    <section class="card rounded-2xl p-4">
      <div class="flex flex-wrap items-center gap-3 justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-emerald-500/15 flex items-center justify-center">
            <span class="text-emerald-300">●</span>
          </div>
          <div>
            <div id="connStatus" class="text-sm text-slate-300">Desconectado</div>
            <div id="loginNote" class="text-xs text-slate-400">
              Clique em <b>Conectar</b> para iniciar o OAuth (será redirecionado e voltará com os tokens).
            </div>
          </div>
        </div>

        <div class="flex flex-col gap-2">
          <div class="flex items-center gap-3">
            <label class="text-sm text-slate-300">Conta:</label>
            <select id="accountSelect" class="pill px-3 py-2 rounded-xl text-sm text-slate-200 bg-transparent" disabled></select>
            <button id="useAccountBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-sm disabled:opacity-50" disabled>Usar conta</button>
          </div>
          <!-- === Saldo === -->
          <div class="flex items-center gap-3">
            <label class="text-sm text-slate-300">Saldo:</label>
            <input id="balanceInput" class="pill px-3 py-2 rounded-xl text-sm bg-transparent text-slate-200 w-40 text-right" placeholder="—" disabled />
            <button id="refreshBalanceBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-sm disabled:opacity-50" disabled>Atualizar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- CONTROLES DE MERCADO -->
    <section class="card rounded-2xl p-4">
      <div class="grid gap-4 lg:grid-cols-3">
        <div class="space-y-3">
          <div class="text-xs uppercase tracking-wide text-slate-400">Mercado</div>
          <div class="space-y-2">
            <label class="text-sm text-slate-300">Símbolo (Volatility/Synthetic)</label>
            <div class="flex items-center gap-2">
              <select id="symbolSelect" class="pill w-full px-3 py-2 rounded-xl text-sm bg-transparent text-slate-200" disabled>
                <option>— carregando —</option>
              </select>
              <!-- BADGE multipliers -->
              <span id="multBadge" class="px-2 py-1 rounded-lg text-xs border hidden"></span>
            </div>
          </div>
          <div class="grid-col">
            <div>
              <label class="text-sm text-slate-300">Stake</label>
              <input id="stakeInput" type="number" min="1" step="1" value="5" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled />
            </div>
            <div>
              <label class="text-sm text-slate-300">Multiplier</label>
              <select id="multInput" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled>
                <option value="10" selected>x10</option>
                <option value="50">x50</option>
                <option value="100">x100</option>
                <option value="200">x200</option>
                <option value="400">x400</option>
                <option value="800">x800</option>
                <option value="1000">x1000</option>
                <option value="1500">x1500</option>
                <option value="2000">x2000</option>
              </select>
            </div>
          </div>
          <div class="grid-col">
            <div>
              <label class="text-sm text-slate-300">Take Profit (opcional)</label>
              <input id="tpInput" type="number" min="1" step="1" placeholder="ex: 150" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled />
            </div>
            <div>
              <label class="text-sm text-slate-300">Stop Loss (opcional)</label>
              <input id="slInput" type="number" min="1" step="1" placeholder="ex: 130" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled />
            </div>
          </div>
          <div>
            <label class="text-sm text-slate-300">Deal Cancellation</label>
            <select id="dcInput" class="pill w-full px-3 py-2 rounded-xl bg-transparent text-slate-200" disabled>
              <option value="">Desligado</option>
              <option value="5m">5m</option>
              <option value="10m">10m</option>
              <option value="15m">15m</option>
              <option value="30m">30m</option>
              <option value="60m">60m</option>
            </select>
          </div>
        </div>

        <div class="space-y-3">
          <div class="text-xs uppercase tracking-wide text-slate-400">Ação</div>
          <div class="flex gap-3">
            <button id="upBtn" class="btn flex-1 px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white disabled:opacity-40" disabled>UP (MULTUP)</button>
            <button id="downBtn" class="btn flex-1 px-4 py-3 rounded-xl bg-rose-600 hover:bg-rose-500 text-white disabled:opacity-40" disabled>DOWN (MULTDOWN)</button>
          </div>
          <div class="text-xs text-slate-400">
            Multipliers: perdas limitadas ao <b>stake</b>; podes fechar a qualquer momento; TP/SL e Cancellation suportados.
          </div>
        </div>

        <div class="space-y-3">
          <div class="text-xs uppercase tracking-wide text-slate-400">Preço (tempo real)</div>
          <div class="glass rounded-xl p-4">
            <div id="tickSymbol" class="text-sm text-slate-400">—</div>
            <div class="text-3xl font-semibold mt-1" id="tickPrice">—</div>
            <div class="mt-3 text-xs text-slate-400" id="tickNote">Assina ticks ao escolher o símbolo.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ============ GRÁFICO DE TENDÊNCIAS (VELAS) ============ -->
    <section class="card rounded-2xl p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="text-xs uppercase tracking-wide text-slate-400">Gráfico de Tendências (Velas)</div>
        <div class="flex items-center gap-2">
          <label for="tfSelect" class="text-xs text-slate-400">Timeframe</label>
          <select id="tfSelect" class="pill px-2 py-1 rounded-lg text-sm bg-transparent text-slate-200" disabled>
            <option value="60" selected>1m</option>
            <option value="300">5m</option>
            <option value="900">15m</option>
          </select>
        </div>
      </div>
      <div id="chartWrap" class="glass rounded-xl"></div>
    </section>
    <!-- ======================================================== -->

    <!-- POSIÇÃO ATIVA -->
    <section class="card rounded-2xl p-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-xs uppercase tracking-wide text-slate-400">Posição</div>
          <div id="posStatus" class="text-sm">Nenhuma posição aberta.</div>
        </div>
        <div class="flex items-center gap-3">
          <div class="text-sm">P/L: <span id="plVal" class="font-semibold text-slate-200">—</span></div>
          <button id="closeBtn" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-sm hidden">Fechar posição</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ================== CONFIG ==================
    const APP_ID = 98640; // POINT
    const WS_URL = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;
    const OAUTH_URL = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}`;
    // ============================================

    // Estado global simples
    let ws = null;
    let authorized = false;
    let selectedToken = null;
    let loginId = null;
    let currency = 'USD';
    let tickSubId = null;
    let openContractId = null;
    let pocSubId = null;
    let balanceSubId = null;

    // ==== ESTADO DO GRÁFICO ====
    let lwChart = null;
    let candleSeries = null;
    let ohlcSubId = null;
    let currentSymbol = null;
    let currentGranularity = 60; // 1m por padrão
    // controle intrabar via ticks
    let liveBar = null; // {time, open, high, low, close}
    // ============================

    const els = {
      loginBtn: document.getElementById('loginBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      connStatus: document.getElementById('connStatus'),
      loginNote: document.getElementById('loginNote'),
      accountSelect: document.getElementById('accountSelect'),
      useAccountBtn: document.getElementById('useAccountBtn'),
      symbolSelect: document.getElementById('symbolSelect'),
      stakeInput: document.getElementById('stakeInput'),
      multInput: document.getElementById('multInput'),
      tpInput: document.getElementById('tpInput'),
      slInput: document.getElementById('slInput'),
      dcInput: document.getElementById('dcInput'),
      upBtn: document.getElementById('upBtn'),
      downBtn: document.getElementById('downBtn'),
      tickSymbol: document.getElementById('tickSymbol'),
      tickPrice: document.getElementById('tickPrice'),
      tickNote: document.getElementById('tickNote'),
      posStatus: document.getElementById('posStatus'),
      plVal: document.getElementById('plVal'),
      closeBtn: document.getElementById('closeBtn'),
      balanceInput: document.getElementById('balanceInput'),
      refreshBalanceBtn: document.getElementById('refreshBalanceBtn'),
      tfSelect: document.getElementById('tfSelect'),
      chartWrap: document.getElementById('chartWrap'),
      multBadge: document.getElementById('multBadge'),
    };

    // ------------- Helpers UI -------------
    function setConnectedUI(on){
      els.connStatus.textContent = on ? 'Conectado (WebSocket ativo)' : 'Desconectado';
    }
    function setAuthUI(on){
      authorized = !!on;
      const dis = !on;
      [els.accountSelect, els.useAccountBtn, els.symbolSelect, els.stakeInput, els.multInput, els.tpInput, els.slInput, els.dcInput, els.upBtn, els.downBtn, els.refreshBalanceBtn, els.tfSelect].forEach(el=>{
        el.disabled = dis;
      });
      els.logoutBtn.classList.toggle('hidden', !on);
      els.loginBtn.classList.toggle('hidden', on);
      els.loginNote.textContent = on
        ? 'Autorizado. Escolhe a conta e o símbolo para negociar.'
        : 'Clique em Conectar para iniciar o OAuth.';
      if(dis){ els.balanceInput.value = ''; els.balanceInput.placeholder = '—'; }
    }
    function toast(msg,isErr=false){
      console[isErr?'error':'log'](msg);
      if(isErr) els.posStatus.textContent = `Erro: ${msg}`;
    }
    function setBadge(available){
      const b = els.multBadge;
      if(!b) return;
      b.classList.remove('hidden');
      if(available){
        b.textContent = 'Multipliers: disponível';
        b.className = 'px-2 py-1 rounded-lg text-xs border bg-emerald-500/10 text-emerald-300 border-emerald-500/30';
      }else{
        b.textContent = 'Multipliers: indisponível';
        b.className = 'px-2 py-1 rounded-lg text-xs border bg-rose-500/10 text-rose-300 border-rose-500/30';
      }
    }

    // ------------- OAuth: captura tokens do redirect -------------
    function extractTokensFromUrl(){
      const q = new URLSearchParams(location.search);
      const tokens = [];
      for (let i=1;i<=10;i++){
        const acct = q.get(`acct${i}`), token = q.get(`token${i}`), cur = q.get(`cur${i}`);
        if(acct && token){
          tokens.push({account:acct.toUpperCase(), token, currency:(cur||'USD').toUpperCase()});
        }
      }
      if(tokens.length){
        localStorage.setItem('POINT_TOKENS', JSON.stringify(tokens));
        history.replaceState({}, document.title, location.pathname);
      }
    }
    function getStoredTokens(){
      try { return JSON.parse(localStorage.getItem('POINT_TOKENS')||'[]'); } catch(e){ return []; }
    }
    function clearTokens(){
      localStorage.removeItem('POINT_TOKENS');
      localStorage.removeItem('POINT_SELECTED');
    }

    // ------------- WebSocket Core -------------
    function connectWS(){
      if(ws && ws.readyState===1) return;
      ws = new WebSocket(WS_URL);
      ws.onopen = ()=>{
        setConnectedUI(true);
        const remembered = JSON.parse(localStorage.getItem('POINT_SELECTED')||'null');
        const tokens = getStoredTokens();
        if(remembered && tokens.length){
          const match = tokens.find(t=>t.account===remembered.account);
          if(match) authorize(match.token, match.account, match.currency);
        }
      };
      ws.onclose = ()=>{
        setConnectedUI(false);
        setAuthUI(false);
      };
      ws.onmessage = handleMessage;
      ws.onerror = ()=>toast('WebSocket error', true);
    }

    function send(msg){
      if(!ws || ws.readyState!==1){ toast('WS não conectado', true); return; }
      ws.send(JSON.stringify(msg));
    }

    function handleMessage(evt){
      const data = JSON.parse(evt.data);

      if(data.error){
        toast(data.error.message || 'Erro desconhecido', true);
        return;
      }

      // authorize
      if(data.msg_type==='authorize'){
        loginId = data.authorize.loginid;
        currency = data.authorize.currency || 'USD';
        setAuthUI(true);
        initChart();
        loadActiveSymbols();
        els.posStatus.textContent = 'Nenhuma posição aberta.';
        subscribeBalance();
      }

      // active_symbols -> popula select
      if(data.msg_type==='active_symbols'){
        const syms = (data.active_symbols||[])
          .filter(s=>s.market==='synthetic_index' || s.symbol.includes('R_') || s.symbol.includes('VOL') || s.market==='cryptocurrency')
          .map(s=>({symbol:s.symbol, display:`${s.display_name} (${s.symbol})`}));
        els.symbolSelect.innerHTML = '';
        syms.forEach(s=>{
          const o=document.createElement('option');
          o.value = s.symbol; o.textContent = s.display;
          els.symbolSelect.appendChild(o);
        });
        if(syms[0]) {
          const firstSym = syms[0].symbol;
          subscribeTicks(firstSym);
          currentSymbol = firstSym;
          loadCandles(currentSymbol, currentGranularity);
          checkMultipliersAvailability(currentSymbol);
        }
      }

      // ticks (formatação pedida + intrabar)
      if(data.msg_type==='tick' && data.tick){
        const q = Number(data.tick.quote);
        const epoch = Number(data.tick.epoch);
        const sym = data.tick.symbol;
        let s = q.toFixed(5);
        if(s.endsWith('00')) s = s.slice(0,-2);
        els.tickPrice.textContent = s;

        // apenas atualiza vela se for o símbolo do gráfico
        if(sym === currentSymbol && candleSeries){
          const bucket = Math.floor(epoch / currentGranularity) * currentGranularity;
          if(!liveBar || liveBar.time !== bucket){
            // inicia nova vela
            liveBar = { time: bucket, open: q, high: q, low: q, close: q };
          }else{
            // atualiza extremos/fecho
            if(q > liveBar.high) liveBar.high = q;
            if(q < liveBar.low)  liveBar.low  = q;
            liveBar.close = q;
          }
          candleSeries.update(liveBar);
          lwChart.timeScale().scrollToRealTime();
        }
      }

      // histórico candles
      if(data.msg_type==='candles' && Array.isArray(data.candles)){
        const bars = data.candles.map(c=>({
          time: Number(c.epoch),
          open: Number(c.open),
          high: Number(c.high),
          low: Number(c.low),
          close: Number(c.close),
        }));
        if(candleSeries){
          candleSeries.setData(bars);
          liveBar = bars[bars.length - 1] || null; // base para intrabar
          lwChart.timeScale().fitContent();
          lwChart.timeScale().scrollToRealTime();
        }
      }

      // stream OHLC (confirma fechamento de velas)
      if(data.msg_type==='ohlc' && data.ohlc){
        if(!candleSeries) return;
        const c = data.ohlc;
        const t = Number(c.open_time); // tempo de abertura do candle
        const bar = {
          time: t,
          open: Number(c.open),
          high: Number(c.high),
          low: Number(c.low),
          close: Number(c.close),
        };
        candleSeries.update(bar);
        // se o servidor fechou a vela, reinicia liveBar no próximo tick
        if(c.complete) liveBar = null;
        lwChart.timeScale().scrollToRealTime();
      }

      // proposal -> buy
      if(data.msg_type==='proposal'){
        if(data.proposal && data.proposal.id){
          const id = data.proposal.id;
          const ask = Number(data.proposal.ask_price);
          send({ buy: id, price: ask });
        } else {
          els.posStatus.textContent = 'Falha ao receber proposta.';
        }
      }

      // buy -> contrato aberto
      if(data.msg_type==='buy'){
        if(data.buy && data.buy.contract_id){
          openContractId = data.buy.contract_id;
          els.posStatus.textContent = `Contrato #${openContractId} aberto. A acompanhar...`;
          els.closeBtn.classList.remove('hidden');
          subscribeOpenContract(openContractId);
        }
      }

      // acompanhar contrato
      if(data.msg_type==='proposal_open_contract'){
        const poc = data.proposal_open_contract;
        if(!poc) return;
        if(poc.contract_id) openContractId = poc.contract_id;
        const pl = (poc.profit || 0);
        els.plVal.textContent = `${pl.toFixed(2)} ${currency}`;
        if(poc.is_sold){
          els.posStatus.textContent = `Contrato fechado. Resultado: ${pl.toFixed(2)} ${currency}`;
          cleanupPosition();
        }
      }

      // sell enviado
      if(data.msg_type==='sell'){
        toast('Solicitado fechar posição.');
      }

      // balance
      if(data.msg_type==='balance'){
        if(data.balance && typeof data.balance.balance !== 'undefined'){
          const bal = Number(data.balance.balance);
          els.balanceInput.value = `${bal.toFixed(2)} ${data.balance.currency || currency}`;
        }
        if(data.subscription && data.subscription.id && !balanceSubId){
          balanceSubId = data.subscription.id;
        }
      }

      // contracts_for -> habilita/desabilita UP/DOWN + badge
      if(data.msg_type==='contracts_for' && data.contracts_for){
        const a = data.contracts_for.available || [];
        const types = a.flatMap(x => (x.contract_type || []));
        const hasMult = types.includes('MULTUP') || types.includes('MULTDOWN');
        els.upBtn.disabled = !hasMult || !authorized;
        els.downBtn.disabled = !hasMult || !authorized;
        setBadge(hasMult);
        if(!hasMult){
          els.posStatus.textContent = 'Este símbolo não suporta Multipliers. Escolha outro.';
        }
      }
    }

    // ------------- Fluxos API -------------
    function authorize(token, acct, cur){
      selectedToken = token;
      currency = (cur||'USD').toUpperCase();
      send({ authorize: token, passthrough:{acct} });
    }

    function loadActiveSymbols(){
      send({ active_symbols: 'brief', product_type: 'basic' });
    }

    function subscribeTicks(symbol){
      if(tickSubId){ send({ forget: tickSubId }); tickSubId=null; }
      els.tickSymbol.textContent = symbol;
      els.tickNote.textContent = 'Recebendo ticks...';
      send({ ticks: symbol, subscribe: 1 });
      ws.addEventListener('message', function once(e){
        const d = JSON.parse(e.data);
        if(d.msg_type==='tick' && d.tick && d.subscription && d.subscription.id){
          tickSubId = d.subscription.id;
          ws.removeEventListener('message', once);
        }
      });
    }

    function subscribeOpenContract(contract_id){
      if(pocSubId){ send({ forget: pocSubId }); pocSubId=null; }
      send({ proposal_open_contract: 1, contract_id, subscribe: 1 });
      ws.addEventListener('message', function once(e){
        const d = JSON.parse(e.data);
        if(d.msg_type==='proposal_open_contract' && d.subscription && d.subscription.id){
          pocSubId = d.subscription.id;
          ws.removeEventListener('message', once);
        }
      });
    }

    function subscribeBalance(){
      if(balanceSubId){ send({ forget: balanceSubId }); balanceSubId = null; }
      send({ balance: 1, subscribe: 1 });
      els.refreshBalanceBtn.disabled = false;
    }

    function requestBalanceOnce(){
      send({ balance: 1 });
    }

    function cleanupPosition(){
      openContractId = null;
      if(pocSubId){ send({ forget: pocSubId }); pocSubId=null; }
      els.closeBtn.classList.add('hidden');
      els.plVal.textContent = '—';
    }

    function placeMultiplier(direction){
      if(!authorized) return toast('Autorize primeiro', true);
      const symbol = els.symbolSelect.value;
      const amount = Number(els.stakeInput.value||0);
      const multiplier = Number(els.multInput.value||10); // x10 padrão
      if(!symbol || !amount){ els.posStatus.textContent='Preencha símbolo e stake'; return; }

      const limit_order = {};
      const tp = Number(els.tpInput.value||0);
      const sl = Number(els.slInput.value||0);
      if(tp>0) limit_order.take_profit = tp;
      if(sl>0) limit_order.stop_loss = sl;

      const req = {
        proposal: 1,
        amount,
        basis: 'stake',
        contract_type: direction==='up' ? 'MULTUP' : 'MULTDOWN',
        currency,
        symbol,
        multiplier
        // *** IMPORTANTE: NÃO enviar product_type aqui ***
      };
      if(Object.keys(limit_order).length) req.limit_order = limit_order;
      const dc = els.dcInput.value;
      if(dc) req.cancellation = dc;

      els.posStatus.textContent = 'Enviando proposal...';
      send(req);
    }

    // ======== GRÁFICO ========
    function initChart(){
      if(lwChart || !els.chartWrap) return;
      lwChart = LightweightCharts.createChart(els.chartWrap, {
        autoSize: true,
        layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#9fb0d0' },
        grid: { vertLines: { color: '#1e2a46' }, horzLines: { color: '#1e2a46' } },
        crosshair: { mode: LightweightCharts.CrosshairMode.Magnet },
        rightPriceScale: { borderColor: '#1e2a46' },
        timeScale: { borderColor: '#1e2a46', timeVisible: true, secondsVisible: false },
      });

      candleSeries = lwChart.addCandlestickSeries({
        upColor: '#22c55e',
        downColor: '#ef4444',
        wickUpColor: '#22c55e',
        wickDownColor: '#ef4444',
        borderVisible: false,
      });

      new ResizeObserver(() => { lwChart.applyOptions({}); }).observe(els.chartWrap);
    }

    function loadCandles(symbol, granularitySec){
      if(!symbol) return;
      currentSymbol = symbol;
      currentGranularity = Number(granularitySec||60);

      liveBar = null;
      if(candleSeries) candleSeries.setData([]);

      if(ohlcSubId){
        send({ forget: ohlcSubId });
        ohlcSubId = null;
      }

      // Histórico
      send({
        ticks_history: symbol,
        adjust_start_time: 1,
        count: 300,
        end: 'latest',
        style: 'candles',
        granularity: currentGranularity
      });

      // Stream OHLC
      send({
        ohlc: 1,
        symbol,
        granularity: currentGranularity,
        subscribe: 1
      });

      // captura subscription id do OHLC
      ws.addEventListener('message', function once(e){
        try{
          const d = JSON.parse(e.data);
          if(d.msg_type==='ohlc' && d.subscription && d.subscription.id){
            ohlcSubId = d.subscription.id;
            ws.removeEventListener('message', once);
          }
        }catch(err){}
      });
    }

    // Verifica se o símbolo suporta MULTUP/MULTDOWN
    function checkMultipliersAvailability(symbol){
      send({
        contracts_for: symbol,
        product_type: 'multipliers'
      });
    }
    // ==========================

    // ------------- Eventos UI -------------
    els.loginBtn.onclick = ()=>{ window.location.href = OAUTH_URL; };
    els.logoutBtn.onclick = ()=>{
      cleanupPosition();
      if(ws && ws.readyState===1) ws.close();
      if(balanceSubId){ send({ forget: balanceSubId }); balanceSubId=null; }
      if(tickSubId){ send({ forget: tickSubId }); tickSubId=null; }
      if(ohlcSubId){ send({ forget: ohlcSubId }); ohlcSubId=null; }
      clearTokens();
      selectedToken=null; loginId=null; setAuthUI(false);
      els.accountSelect.innerHTML = '';
      if(candleSeries) candleSeries.setData([]);
      toast('Sessão limpa.');
    };

    els.useAccountBtn.onclick = ()=>{
      const opt = els.accountSelect.value;
      if(!opt) return;
      const tokens = getStoredTokens();
      const chosen = tokens.find(t=>t.account===opt);
      if(!chosen) return;
      localStorage.setItem('POINT_SELECTED', JSON.stringify(chosen));
      if(ws && ws.readyState===1) authorize(chosen.token, chosen.account, chosen.currency);
      else connectWS();
      setTimeout(()=>{ subscribeBalance(); }, 200);
    };

    els.refreshBalanceBtn.onclick = ()=> requestBalanceOnce();

    els.symbolSelect.onchange = (e)=>{
      const sym = e.target.value;
      subscribeTicks(sym);
      loadCandles(sym, currentGranularity);
      checkMultipliersAvailability(sym);
    };

    els.tfSelect.onchange = (e)=>{
      const gran = Number(e.target.value||60);
      loadCandles(els.symbolSelect.value, gran);
    };

    els.upBtn.onclick = ()=>placeMultiplier('up');
    els.downBtn.onclick = ()=>placeMultiplier('down');
    els.closeBtn.onclick = ()=>{
      if(!openContractId) return;
      send({ sell: openContractId, price: 0 });
    };

    // ------------- Inicialização -------------
    extractTokensFromUrl();
    const tokens = getStoredTokens();
    if(tokens.length){
      els.accountSelect.innerHTML = '';
      tokens.forEach(t=>{
        const o=document.createElement('option');
        o.value=t.account; o.textContent=`${t.account} • ${t.currency}`;
        els.accountSelect.appendChild(o);
      });
      els.accountSelect.disabled = false;
      els.useAccountBtn.disabled = false;
      connectWS();
      const first = tokens[0];
      localStorage.setItem('POINT_SELECTED', JSON.stringify(first));
      authorize(first.token, first.account, first.currency);
    } else {
      connectWS();
      initChart();
    }
  </script>
</body>
</html>
